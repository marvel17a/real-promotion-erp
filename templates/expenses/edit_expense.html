{% extends 'admin_master.html' %}
{% block page_content %}
<!-- Same premium design as add_expense but with populated values -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    :root { --primary: #4f46e5; --light-blue: #0ea5e9; --success: #10b981; --danger: #ef4444; }
    body { font-family: 'Poppins', sans-serif; background-color: #f1f5f9; }
    .live-clock-box { background: var(--light-blue); color: white; padding: 6px 22px; border-radius: 50px; font-weight: 800; }
    .total-box-premium { background: var(--light-blue) !important; color: white !important; border-radius: 20px; padding: 25px; }
    .premium-card { background: white; border-radius: 24px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); }
    .btn-add-item { background: #ecfdf5; color: #059669; border: 2px dashed #10b981; border-radius: 12px; width: 100%; padding: 12px; font-weight: 700; }
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
</style>

<div class="container-fluid py-4">
    <div class="mb-4">
        <a href="{{ url_for('expenses_list') }}" class="btn btn-light rounded-pill border shadow-sm px-4">
            <i class="fas fa-arrow-left me-2"></i> Back to Ledger
        </a>
    </div>

    <div class="row align-items-center mb-4">
        <div class="col-md-7">
            <h2 class="fw-bold text-dark m-0">Edit Voucher #{{ expense.expense_id }}</h2>
            <div class="mt-2 text-muted small"><i class="fas fa-calendar me-1"></i> Original: {{ expense.expense_date.strftime('%d-%m-%Y') }}</div>
        </div>
    </div>

    <form action="{{ url_for('edit_expense', expense_id=expense.expense_id) }}" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="old_receipt_url" value="{{ expense.receipt_url }}">
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card premium-card p-4 mb-4">
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="small fw-bold text-muted">VOUCHER DATE</label>
                            <input type="text" name="expense_date" id="datePicker" class="form-control" value="{{ expense.expense_date.strftime('%d-%m-%Y') }}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold text-muted">MAIN CATEGORY</label>
                            <select name="main_category_id" id="mainCat" class="form-select" onchange="initVoucher()" required>
                                {% for cat in categories %}
                                <option value="{{ cat.category_id }}" {% if items[0] and items[0].category_id == cat.category_id %}selected{% endif %}>{{ cat.category_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div id="itemsContainer">
                        <div class="table-responsive">
                            <table class="table table-borderless align-middle">
                                <thead>
                                    <tr class="small text-muted border-bottom">
                                        <th style="width: 25%;">Sub-Category</th>
                                        <th style="width: 20%;">Method</th>
                                        <th style="width: 30%;">Note</th>
                                        <th style="width: 20%;">Amount (₹)</th>
                                        <th style="width: 5%;"></th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    {% for item in items %}
                                    <tr>
                                        <td>
                                            <select name="subcategory_id[]" class="form-select border-0 bg-light" required>
                                                {% for s in subcategories %}
                                                    {% if items[0] and s.category_id == items[0].category_id %}
                                                    <option value="{{ s.subcategory_id }}" {% if item.subcategory_id == s.subcategory_id %}selected{% endif %}>{{ s.subcategory_name }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <select name="item_payment_method[]" class="form-select border-0 bg-light small">
                                                <option value="Cash" {% if item.payment_method == 'Cash' %}selected{% endif %}>Cash</option>
                                                <option value="Online" {% if item.payment_method == 'Online' %}selected{% endif %}>Online</option>
                                            </select>
                                        </td>
                                        <td><input type="text" name="description[]" class="form-control border-0 bg-light" value="{{ item.description }}"></td>
                                        <td><input type="number" name="amount[]" class="form-control border-0 bg-light fw-bold text-end val-input" value="{{ item.amount|int }}" oninput="recalculate()" required></td>
                                        <td><button type="button" class="btn btn-link text-danger p-0" onclick="this.closest('tr').remove();recalculate();"><i class="fas fa-trash"></i></button></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-add-item mt-3" onclick="addNewRow()">
                            <i class="fas fa-plus-circle me-2"></i> Add Another Line Item
                        </button>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card premium-card p-4 h-100 text-center">
                            <h6 class="fw-bold mb-3 small text-muted text-uppercase">Update Document</h6>
                            <input type="file" name="receipt" class="form-control mb-2" accept="image/*,application/pdf">
                            {% if expense.receipt_url %}<a href="{{ expense.receipt_url }}" target="_blank" class="small text-primary"><i class="fas fa-link me-1"></i>View Existing Receipt</a>{% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card premium-card p-4 h-100">
                            <h6 class="fw-bold mb-3 small text-muted text-uppercase">Universal Note</h6>
                            <textarea name="voucher_description" class="form-control bg-light border-0" rows="3">{{ expense.description }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card premium-card p-4 sticky-top" style="top: 20px;">
                    <div class="total-box-premium text-center my-4">
                        <small class="text-uppercase opacity-75 fw-bold">Grand Total</small>
                        <h1 class="fw-bold m-0" id="totalText">₹ 0</h1>
                    </div>
                    <button type="submit" class="btn btn-success w-100 py-3 rounded-4 fw-bold shadow-sm mb-3">Save Changes</button>
                    <a href="{{ url_for('expenses_list') }}" class="btn btn-outline-secondary w-100 rounded-4 py-2">Cancel</a>
                </div>
            </div>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    const subcats = {{ subcategories | tojson }};
    document.addEventListener('DOMContentLoaded', () => {
        flatpickr("#datePicker", { dateFormat: "d-m-Y" });
        recalculate();
    });

    function addNewRow() {
        const mainId = document.getElementById('mainCat').value;
        const filtered = subcats.filter(s => s.category_id == mainId);
        let opts = '';
        filtered.forEach(s => opts += `<option value="${s.subcategory_id}">${s.subcategory_name}</option>`);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><select name="subcategory_id[]" class="form-select border-0 bg-light" required>${opts}</select></td>
            <td><select name="item_payment_method[]" class="form-select border-0 bg-light small"><option value="Cash">Cash</option><option value="Online">Online</option></select></td>
            <td><input type="text" name="description[]" class="form-control border-0 bg-light"></td>
            <td><input type="number" name="amount[]" class="form-control border-0 bg-light fw-bold text-end val-input" oninput="recalculate()" required></td>
            <td><button type="button" class="btn btn-link text-danger p-0" onclick="this.closest('tr').remove();recalculate();"><i class="fas fa-trash"></i></button></td>`;
        document.getElementById('tableBody').appendChild(tr);
    }
    function recalculate() {
        let total = 0;
        document.querySelectorAll('.val-input').forEach(i => total += parseInt(i.value) || 0);
        document.getElementById('totalText').innerText = "₹ " + total.toLocaleString('en-IN');
    }
</script>
{% endblock %}
