{% extends 'admin_master.html' %}
{% block page_content %}
<div class="container-fluid py-4 fade-in-up">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <form action="{{ url_for('edit_expense', expense_id=expense.expense_id) }}" method="POST">
                <div class="card glass-card border-0 shadow-lg rounded-4">
                    <div class="card-header bg-white border-0 p-4">
                        <h4 class="fw-bold mb-0">Edit Expense #{{ expense.expense_id }}</h4>
                    </div>
                    <div class="card-body p-4 bg-light bg-opacity-25">
                        <div class="row g-3 mb-4">
                            <div class="col-md-4"><label>Date</label><input type="date" name="expense_date" class="form-control" value="{{ expense.expense_date }}" required></div>
                            <div class="col-md-4"><label>Time</label><input type="time" name="expense_time" class="form-control" value="{{ expense.expense_time }}" required></div>
                            <div class="col-md-4">
                                <label>Method</label>
                                <select name="payment_method" class="form-select">
                                    <option value="Cash" {% if expense.payment_method=='Cash' %}selected{% endif %}>Cash</option>
                                    <option value="Online" {% if expense.payment_method=='Online' %}selected{% endif %}>Online</option>
                                    <option value="Bank Transfer" {% if expense.payment_method=='Bank Transfer' %}selected{% endif %}>Bank Transfer</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive bg-white rounded-3 p-3 shadow-sm">
                            <table class="table align-middle" id="itemsTable">
                                <thead class="small text-uppercase text-muted"><tr><th style="width:25%">Category</th><th style="width:25%">Item</th><th>Description</th><th style="width:15%">Amount</th><th></th></tr></thead>
                                <tbody id="itemsBody">
                                    {% for item in items %}
                                    <tr>
                                        <td>
                                            <select name="category_id[]" class="form-select border-0 bg-light" onchange="updSub(this, {{ loop.index }})" required>
                                                {% for c in categories %}
                                                <option value="{{ c.category_id }}" {% if c.category_id==item.category_id %}selected{% endif %}>{{ c.category_name }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <select name="subcategory_id[]" id="sub_{{ loop.index }}" class="form-select border-0 bg-light" required>
                                                <option value="{{ item.subcategory_id }}" selected>{{ item.description }} (Current)</option>
                                            </select>
                                        </td>
                                        <td><input type="text" name="description[]" class="form-control border-0 bg-light" value="{{ item.description }}"></td>
                                        <td><input type="number" name="amount[]" class="form-control border-0 bg-light fw-bold text-end amt" step="0.01" value="{{ item.amount }}" oninput="calc()" required></td>
                                        <td><button type="button" class="btn btn-sm text-danger" onclick="this.closest('tr').remove(); calc();"><i class="fas fa-times"></i></button></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <button type="button" class="btn btn-light w-100 fw-bold text-primary" onclick="addRow()">Add Item</button>
                        </div>
                    </div>
                    <div class="card-footer bg-white border-0 p-4 text-end">
                        <h5 class="d-inline-block me-4">Total: <span id="grandTotal">₹ {{ expense.amount }}</span></h5>
                        <button type="submit" class="btn btn-primary px-5 rounded-pill">Update</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Reusing JS logic for brevity -->
<script>
    const categories = {{ categories | tojson }};
    const subcategories = {{ subcategories | tojson }};
    function addRow() { 
        const rowId = Date.now();
        let catOpts = '<option value="" disabled selected>Select</option>';
        categories.forEach(c => catOpts += `<option value="${c.category_id}">${c.category_name}</option>`);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><select name="category_id[]" class="form-select border-0 bg-light" onchange="updSub(this, ${rowId})" required>${catOpts}</select></td>
            <td><select name="subcategory_id[]" id="sub_${rowId}" class="form-select border-0 bg-light" required><option disabled selected>--</option></select></td>
            <td><input type="text" name="description[]" class="form-control border-0 bg-light" placeholder="Note"></td>
            <td><input type="number" name="amount[]" class="form-control border-0 bg-light fw-bold text-end amt" step="0.01" oninput="calc()" required></td>
            <td><button type="button" class="btn btn-sm text-danger" onclick="this.closest('tr').remove(); calc();"><i class="fas fa-times"></i></button></td>`;
        document.getElementById('itemsBody').appendChild(tr);
    }
    function updSub(el, id) {
        const subs = subcategories.filter(s => s.category_id == el.value);
        let h = '<option disabled selected>--</option>';
        subs.forEach(s => h += `<option value="${s.subcategory_id}">${s.subcategory_name}</option>`);
        document.getElementById(`sub_${id}`).innerHTML = h;
    }
    function calc() {
        let t = 0;
        document.querySelectorAll('.amt').forEach(i => t += parseFloat(i.value) || 0);
        document.getElementById('grandTotal').innerText = "₹ " + t.toFixed(2);
    }
</script>
{% endblock %}
