{% extends 'admin_master.html' %}
{% block page_content %}
<!-- Dependencies -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
    :root { --primary: #4f46e5; --light-blue: #0ea5e9; --sky-blue: #e0f2fe; --dark-blue-text: #0369a1; }
    body { background-color: #f1f5f9; font-family: 'Poppins', sans-serif; }
    
    .premium-card { 
        background: white; border-radius: 20px; border: none; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
    }
    
    .filter-bar { 
        background: #fff; border-radius: 15px; padding: 20px; 
        margin-bottom: 25px; border: 1px solid #e2e8f0; 
    }
    
    .method-badge { 
        font-size: 0.75rem; padding: 4px 12px; border-radius: 50px; 
        font-weight: 600; text-transform: uppercase; 
    }
    .cash-bg { color: #059669; background: #ecfdf5; border: 1px solid #d1fae5; }
    .online-bg { color: #2563eb; background: #eff6ff; border: 1px solid #dbeafe; }
    .mixed-bg { color: #7c3aed; background: #f5f3ff; border: 1px solid #ede9fe; }
    
    /* Updated Table Headers Style */
    .table thead th { 
        background-color: var(--sky-blue) !important; /* Sky Blue Background */
        color: var(--dark-blue-text) !important;      /* Dark Blue Text for contrast */
        font-weight: 700 !important;                  /* Bold */
        font-size: 0.75rem; 
        text-transform: uppercase; 
        letter-spacing: 0.5px; 
        border: none; 
        padding: 16px;
    }
    
    .table-hover tbody tr:hover { background-color: #f8fafc; }
</style>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-dark m-0">Expense Ledger</h3>
            <p class="text-muted small m-0">Consolidated operational spending history</p>
        </div>
        <div class="d-flex gap-2">
            <!-- Dashboard Button Added -->
            <a href="{{ url_for('expense_dash') }}" class="btn btn-dark rounded-pill px-4 shadow-sm">
                <i class="fas fa-chart-pie me-2"></i> Dashboard
            </a>
            <a href="{{ url_for('category_man') }}" class="btn btn-outline-primary rounded-pill px-4">
                <i class="fas fa-tags me-1"></i> Categories
            </a>
            <a href="{{ url_for('add_expense') }}" class="btn btn-primary rounded-pill px-4 shadow">
                <i class="fas fa-plus me-1"></i> New Entry
            </a>
        </div>
    </div>

    <!-- Multi-Filter Bar -->
    <div class="filter-bar shadow-sm">
        <form action="{{ url_for('expenses_list') }}" method="GET" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="small fw-bold text-muted mb-1">SEARCH</label>
                <div class="input-group">
                    <span class="input-group-text bg-light border-0"><i class="fas fa-search text-muted"></i></span>
                    <input type="text" name="q" class="form-control border-0 bg-light" placeholder="Voucher # or Note..." value="{{ filters.q }}">
                </div>
            </div>
            <div class="col-md-2">
                <label class="small fw-bold text-muted mb-1">CATEGORY</label>
                <select name="cat_id" class="form-select border-0 bg-light" id="filterCat" onchange="filterSubCats()">
                    <option value="all">All Main</option>
                    {% for c in categories %}
                    <option value="{{ c.category_id }}" {% if filters.cat == c.category_id|string %}selected{% endif %}>{{ c.category_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="small fw-bold text-muted mb-1">SUB-CATEGORY</label>
                <select name="sub_id" class="form-select border-0 bg-light" id="filterSub">
                    <option value="all">All Sub</option>
                    {% for s in subcategories %}
                    <option value="{{ s.subcategory_id }}" data-parent="{{ s.category_id }}" {% if filters.sub == s.subcategory_id|string %}selected{% endif %}>{{ s.subcategory_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="small fw-bold text-muted mb-1">DATE RANGE</label>
                <div class="input-group">
                    <!-- Two separate inputs as requested, both using Flatpickr -->
                    <input type="text" name="start_date" id="startDate" class="form-control border-0 bg-light" placeholder="Start Date" value="{{ filters.start }}">
                    <span class="input-group-text bg-light border-0 text-muted">to</span>
                    <input type="text" name="end_date" id="endDate" class="form-control border-0 bg-light" placeholder="End Date" value="{{ filters.end }}">
                </div>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-dark w-100 rounded-pill py-2"><i class="fas fa-sync-alt me-1"></i> Apply Filter</button>
            </div>
        </form>
    </div>

    <!-- Data Table -->
    <div class="card premium-card overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle m-0">
                <thead>
                    <tr>
                        <th class="ps-4">Date & Time</th>
                        <th>Voucher Detail</th>
                        <th>Items</th>
                        <th>Method</th>
                        <th class="text-end">Voucher Total</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for e in expenses %}
                    <tr>
                        <td class="ps-4">
                            <div class="fw-bold text-dark">{{ e.expense_date.strftime('%d-%m-%Y') if e.expense_date else 'N/A' }}</div>
                            <small class="text-muted"><i class="far fa-clock me-1"></i>{{ e.expense_time }}</small>
                        </td>
                        <td>
                            <div class="fw-bold text-primary">{{ e.main_category or 'General' }}</div>
                            <div class="small text-muted text-truncate" style="max-width: 200px;">{{ e.description or 'No remarks' }}</div>
                        </td>
                        <td><span class="badge bg-light text-dark border px-3 rounded-pill">{{ e.item_count }} Lines</span></td>
                        <td>
                            {% set m = e.payment_method|lower %}
                            <span class="method-badge {% if m=='cash' %}cash-bg{% elif m=='mixed' %}mixed-bg{% else %}online-bg{% endif %}">
                                {{ e.payment_method }}
                            </span>
                        </td>
                        <td class="text-end fw-bold text-dark pe-4">â‚¹ {{ "{:,.0f}".format(e.total_amount) }}</td>
                        <td class="text-center">
                            <div class="d-flex justify-content-center gap-2">
                                <a href="{{ url_for('view_expense', expense_id=e.expense_id) }}" class="btn btn-sm btn-light rounded-circle shadow-sm border" title="View"><i class="fas fa-eye text-primary"></i></a>
                                <a href="{{ url_for('edit_expense', expense_id=e.expense_id) }}" class="btn btn-sm btn-light rounded-circle shadow-sm border" title="Edit"><i class="fas fa-edit text-success"></i></a>
                                <form action="{{ url_for('delete_expense', id=e.expense_id) }}" method="POST" onsubmit="return confirm('Archive this record?')">
                                    <button class="btn btn-sm btn-light rounded-circle shadow-sm border"><i class="fas fa-trash text-danger"></i></button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" class="text-center py-5 text-muted">No transactions matching your criteria.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Flatpickr on separate inputs
        flatpickr("#startDate", {
            dateFormat: "d-m-Y",
            allowInput: true
        });
        flatpickr("#endDate", {
            dateFormat: "d-m-Y",
            allowInput: true
        });
        filterSubCats();
    });

    function filterSubCats() {
        const catId = document.getElementById('filterCat').value;
        const subSelect = document.getElementById('filterSub');
        subSelect.querySelectorAll('option').forEach(opt => {
            if(opt.value === 'all') opt.style.display = 'block';
            else if(catId === 'all' || opt.getAttribute('data-parent') === catId) opt.style.display = 'block';
            else opt.style.display = 'none';
        });
        if(catId !== 'all') subSelect.value = 'all';
    }
</script>
{% endblock %}
