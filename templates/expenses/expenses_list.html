{% extends 'admin_master.html' %}

{% block title %}Expenses{% endblock %}

{% block page_content %}
<!-- Styles & Fonts -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/expenses.css') }}">
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/material_blue.css">

<div class="container-fluid py-4 fade-in-up">
    
    <!-- Header Actions -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-dark mb-1">Expense Management</h3>
            <p class="text-muted small mb-0">Track and manage your company spending.</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('category_man') }}" class="btn btn-light bg-white border shadow-sm rounded-pill px-3 fw-medium">
                <i class="fas fa-tags me-2 text-primary"></i> Categories
            </a>
            <a href="{{ url_for('expense_dash') }}" class="btn btn-gradient-primary">
                <i class="fas fa-chart-pie me-2"></i> Dashboard
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- LEFT: Add Expense Form -->
        <div class="col-lg-4">
            <div class="glass-card h-100">
                <div class="glass-header">
                    <h6 class="mb-0 fw-bold text-primary"><i class="fas fa-plus-circle me-2"></i>New Expense</h6>
                </div>
                <div class="p-4">
                    <form action="{{ url_for('expenses_list') }}" method="POST">
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Date</label>
                            <input type="text" id="expense_date" name="expense_date" class="form-control input-glass" placeholder="Select Date" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Amount (₹)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-0 ps-3">₹</span>
                                <input type="number" step="0.01" name="amount" class="form-control input-glass border-start-0 ps-1" placeholder="0.00" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Category</label>
                            <select id="category" name="category" class="form-select input-glass" required>
                                <option value="" disabled selected>Select Main Category</option>
                                {% for cat in categories %}
                                    <option value="{{ cat.category_id }}">{{ cat.category_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Subcategory</label>
                            <select id="subcategory_id" name="subcategory_id" class="form-select input-glass" required disabled>
                                <option value="">Select Category First</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Payment Method</label>
                            <select name="payment_method" class="form-select input-glass">
                                <option value="UPI">UPI</option>
                                <option value="Cash">Cash</option>
                                <option value="Card">Card</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="form-label small fw-bold text-muted text-uppercase">Description</label>
                            <textarea name="description" class="form-control input-glass" rows="2" placeholder="Optional notes..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-gradient-primary w-100 py-2 shadow-sm">
                            <i class="fas fa-check me-2"></i> Save Expense
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- RIGHT: Expense History -->
        <div class="col-lg-8">
            <div class="glass-card h-100 d-flex flex-column">
                <div class="glass-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-dark">Recent Transactions</h6>
                    <span class="badge bg-light text-dark border rounded-pill">{{ expenses|length }} Records</span>
                </div>
                
                <div class="table-responsive flex-grow-1 p-0">
                    <table class="table-glass align-middle">
                        <thead>
                            <tr>
                                <th class="ps-4">Date</th>
                                <th>Category / Item</th>
                                <th>Method</th>
                                <th class="text-end">Amount</th>
                                <th class="text-center pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in expenses %}
                            <tr>
                                <td class="ps-4 fw-medium text-dark">{{ expense.expense_date.strftime('%d %b, %Y') }}</td>
                                <td>
                                    <div class="fw-bold text-dark">{{ expense.subcategory_name }}</div>
                                    <small class="text-muted" style="font-size: 0.75rem;">{{ expense.category_name }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-light text-secondary border fw-normal">{{ expense.payment_method or 'Cash' }}</span>
                                </td>
                                <td class="text-end fw-bold text-dark">₹{{ "%.2f"|format(expense.amount) }}</td>
                                <td class="text-center pe-4">
                                    <div class="d-flex justify-content-center gap-1">
                                        <a href="{{ url_for('edit_expense', expense_id=expense.expense_id) }}" class="btn-icon text-primary bg-light" title="Edit">
                                            <i class="fas fa-pen fa-sm"></i>
                                        </a>
                                        <form action="{{ url_for('delete_expense', expense_id=expense.expense_id) }}" method="POST" onsubmit="return confirm('Delete this expense?');" style="display:inline;">
                                            <button type="submit" class="btn-icon text-danger bg-light" title="Delete">
                                                <i class="fas fa-trash fa-sm"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">
                                    <i class="fas fa-receipt fa-3x mb-3 opacity-25"></i>
                                    <p>No expenses recorded yet.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    // Flatpickr Init
    document.addEventListener("DOMContentLoaded", function() {
        flatpickr("#expense_date", {
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "F j, Y",
            defaultDate: "today",
            allowInput: true
        });

        // Subcategory Logic
        const subcategories = {{ subcategories_for_js | tojson }};
        const categorySelect = document.getElementById('category');
        const subcategorySelect = document.getElementById('subcategory_id');

        categorySelect.addEventListener('change', function() {
            const selectedCategoryId = this.value;
            subcategorySelect.innerHTML = '<option value="" disabled selected>-- Select Item --</option>';

            if (selectedCategoryId) {
                const relevant = subcategories.filter(sc => sc.category_id == selectedCategoryId);
                if (relevant.length > 0) {
                    relevant.forEach(sc => {
                        const opt = document.createElement('option');
                        opt.value = sc.subcategory_id;
                        opt.textContent = sc.subcategory_name;
                        subcategorySelect.appendChild(opt);
                    });
                    subcategorySelect.disabled = false;
                } else {
                    subcategorySelect.disabled = true;
                }
            } else {
                subcategorySelect.disabled = true;
            }
        });
    });
</script>
{% endblock %}
