{% extends 'admin_master.html' %}

{% block page_content %}
<!-- Dependencies -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root {
        --primary: #4f46e5;
        --light-blue: #0ea5e9;
        --success: #10b981;
        --danger: #ef4444;
        --dark: #1e293b;
        --bg-soft: #f1f5f9;
    }

    body { font-family: 'Poppins', sans-serif; background-color: var(--bg-soft); color: var(--dark); }

    .live-clock-box {
        background: var(--light-blue);
        color: white; padding: 6px 22px; border-radius: 50px;
        font-family: 'monospace'; font-weight: 800; letter-spacing: 1px;
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.35);
    }

    .total-box-premium {
        background: var(--light-blue) !important;
        color: white !important; border-radius: 20px; padding: 25px;
        box-shadow: 0 12px 20px -5px rgba(14, 165, 233, 0.45);
    }

    .premium-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        border-radius: 24px;
        box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.05);
    }

    .form-label { font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 8px; }

    .form-control, .form-select {
        border-radius: 12px; padding: 12px 18px; border: 1.5px solid #e2e8f0;
    }

    /* Remove Spinners */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    .btn-add-item {
        background: #ecfdf5; color: #059669; border: 2px dashed #10b981;
        border-radius: 15px; width: 100%; padding: 15px; font-weight: 700;
        transition: 0.3s;
    }
    .btn-add-item:hover { background: #d1fae5; transform: scale(1.005); }

    .action-card-post { background: #f0fdf4; border: 1px solid #dcfce7; border-radius: 24px; padding: 20px; }
    .action-card-discard { background: #fef2f2; border: 1px solid #fee2e2; border-radius: 24px; padding: 20px; }

    .btn-post { background: var(--success); color: white; border: none; border-radius: 16px; font-weight: 700; padding: 15px; transition: 0.3s; }
    .btn-post:hover { background: #059669; transform: translateY(-2px); }
    
    .btn-discard { background: white; color: var(--danger); border: 1.5px solid #fecaca; border-radius: 16px; font-weight: 600; padding: 12px; transition: 0.3s; }
    .btn-discard:hover { background: var(--danger); color: white; }

    .upload-zone { border: 2.5px dashed #cbd5e1; border-radius: 20px; padding: 30px; text-align: center; background: #f8fafc; cursor: pointer; }

    /* Responsive Table Fix */
    @media (max-width: 768px) {
        .item-row td { display: block; width: 100% !important; border: none !important; padding: 5px 0 !important; }
        .item-row { display: block; padding: 15px; border-bottom: 2px solid #f1f5f9; position: relative; }
        .item-row .btn-remove-container { position: absolute; top: 10px; right: 10px; }
        thead { display: none; }
    }
</style>

<div class="container-fluid py-4">
    <!-- Top Navigation -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
        <div>
            <a href="{{ url_for('expenses_list') }}" class="btn btn-white bg-white rounded-pill border shadow-sm px-4 py-2 small fw-bold text-muted">
                <i class="fas fa-arrow-left me-2"></i> Back to Ledger
            </a>
        </div>
        <div id="liveClock" class="live-clock-box align-self-start align-self-md-center shadow">00:00:00 AM</div>
    </div>

    <div class="mb-4">
        <h2 class="fw-bold text-dark m-0">Create Expense Voucher</h2>
        <p class="text-muted m-0 small">Record operational expenses without fund restriction</p>
    </div>

    <form id="voucherForm" action="{{ url_for('add_expense') }}" method="POST" enctype="multipart/form-data">
        <div class="row g-4">
            <!-- Left Side: Form Details -->
            <div class="col-12 col-lg-8">
                <div class="card premium-card p-4 mb-4">
                    <div class="row g-3 mb-4">
                        <div class="col-12 col-md-6">
                            <label class="form-label">VOUCHER DATE</label>
                            <input type="text" name="expense_date" id="datePicker" class="form-control" required>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label">MAIN ACCOUNT CATEGORY</label>
                            <select name="main_category_id" id="mainCat" class="form-select fw-bold" onchange="initVoucher()" required>
                                <option value="" disabled selected>Select Category...</option>
                                {% for cat in categories %}
                                <option value="{{ cat.category_id }}">{{ cat.category_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Item Allocation Table -->
                    <div id="itemsContainer" style="display: none;">
                        <h6 class="fw-bold text-dark mb-3"><i class="fas fa-list-check me-2 text-primary"></i>Allocation Details</h6>
                        <div class="table-responsive">
                            <table class="table table-borderless align-middle mb-0">
                                <thead class="d-none d-md-table-header-group">
                                    <tr class="border-bottom">
                                        <th style="width: 30%;">Sub-Category</th>
                                        <th style="width: 20%;">Payment</th>
                                        <th style="width: 30%;">Note</th>
                                        <th style="width: 15%; text-align: right;">Amount (₹)</th>
                                        <th style="width: 5%;"></th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-add-item mt-3 shadow-sm" onclick="addNewRow()">
                            <i class="fas fa-plus-circle me-2"></i> Add Line Item
                        </button>
                    </div>

                    <div id="placeholder" class="text-center py-5">
                        <p class="text-muted fw-medium">Select a category above to start adding line items.</p>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-12 col-md-6">
                        <div class="card premium-card p-4 h-100">
                            <h6 class="fw-bold mb-3 small text-muted text-uppercase">Attachment</h6>
                            <div class="upload-zone shadow-sm" onclick="document.getElementById('fileInp').click()">
                                <i class="fas fa-cloud-arrow-up fa-2x text-primary opacity-50 mb-2"></i>
                                <p class="m-0 fw-bold small text-dark">Upload Bill Photo</p>
                                <input type="file" name="receipt" id="fileInp" hidden accept="image/*,application/pdf" onchange="updateFileLabel(this)">
                                <div id="fileName" class="mt-2 small text-success fw-bold" style="display:none;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="card premium-card p-4 h-100">
                            <h6 class="fw-bold mb-3 small text-muted text-uppercase">Universal Note</h6>
                            <textarea name="voucher_description" class="form-control bg-light border-0" rows="4" placeholder="General description..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side: Summary & Actions -->
            <div class="col-12 col-lg-4">
                <div class="card premium-card p-4 sticky-top" style="top: 25px;">
                    <h5 class="fw-bold mb-4">Voucher Summary</h5>
                    <div class="d-flex justify-content-between mb-3 border-bottom pb-3">
                        <span class="text-muted">Item Lines</span>
                        <span class="fw-bold" id="itemCounter">0</span>
                    </div>

                    <div class="total-box-premium text-center my-4">
                        <small class="text-uppercase opacity-75 fw-bold" style="font-size: 0.7rem;">Grand Total</small>
                        <h1 class="fw-bold m-0" id="totalText">₹ 0</h1>
                    </div>

                    <div class="action-card-post mb-3 text-center">
                        <button type="submit" class="btn btn-post w-100">
                            <i class="fas fa-check-circle me-2"></i> Confirm & Post
                        </button>
                    </div>
                    
                    <div class="action-card-discard text-center">
                        <a href="{{ url_for('expenses_list') }}" class="btn btn-discard w-100 text-decoration-none d-block">
                            <i class="fas fa-times-circle me-2"></i> Discard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    const subcategories = {{ subcategories | tojson }};

    document.addEventListener('DOMContentLoaded', () => {
        flatpickr("#datePicker", { defaultDate: "today", dateFormat: "d-m-Y" });
        setInterval(() => {
            document.getElementById('liveClock').innerText = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }, 1000);
    });

    function initVoucher() {
        document.getElementById('placeholder').style.display = 'none';
        document.getElementById('itemsContainer').style.display = 'block';
        document.getElementById('tableBody').innerHTML = '';
        addNewRow();
    }

    function addNewRow() {
        const mainId = document.getElementById('mainCat').value;
        const filtered = subcategories.filter(s => s.category_id == mainId);
        let opts = '<option value="" disabled selected>Select Item</option>';
        filtered.forEach(s => opts += `<option value="${s.subcategory_id}">${s.subcategory_name}</option>`);

        const tr = document.createElement('tr');
        tr.className = 'item-row';
        tr.innerHTML = `
            <td>
                <label class="form-label d-md-none">SUB-CATEGORY</label>
                <select name="subcategory_id[]" class="form-select border-0 bg-light" required>${opts}</select>
            </td>
            <td>
                <label class="form-label d-md-none">PAYMENT</label>
                <select name="item_payment_method[]" class="form-select border-0 bg-light small">
                    <option value="Cash" selected>Cash</option>
                    <option value="Online">Online</option>
                </select>
            </td>
            <td>
                <label class="form-label d-md-none">NOTE</label>
                <input type="text" name="description[]" class="form-control border-0 bg-light" placeholder="Item note">
            </td>
            <td>
                <label class="form-label d-md-none text-end w-100">AMOUNT (₹)</label>
                <input type="number" name="amount[]" class="form-control border-0 bg-light fw-bold text-end val-input" 
                       placeholder="0" step="1" oninput="recalculate()" onkeypress="return event.charCode >= 48 && event.charCode <= 57" required>
            </td>
            <td class="text-end btn-remove-container">
                <button type="button" class="btn btn-link text-danger p-0" onclick="this.closest('tr').remove();recalculate();">
                    <i class="fas fa-trash-can"></i>
                </button>
            </td>
        `;
        document.getElementById('tableBody').appendChild(tr);
        recalculate();
    }

    function recalculate() {
        let total = 0;
        const rows = document.querySelectorAll('.item-row');
        document.querySelectorAll('.val-input').forEach(i => total += parseInt(i.value) || 0);
        document.getElementById('totalText').innerText = "₹ " + total.toLocaleString('en-IN');
        document.getElementById('itemCounter').innerText = rows.length;
    }

    function updateFileLabel(input) {
        if(input.files[0]) {
            const fileName = document.getElementById('fileName');
            fileName.innerText = "✓ Ready: " + input.files[0].name;
            fileName.style.display = 'block';
        }
    }
</script>
{% endblock %}
