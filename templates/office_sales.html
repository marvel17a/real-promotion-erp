{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<div class="glass-container fade-in-up mb-5">
    
    <div class="page-header">
        <h1 class="company-title fw-800 text-gradient">OFFICE SALES</h1>
        <p class="company-subtitle">Direct Customer Billing</p>
    </div>

    <div class="glass-panel p-4">
        <form method="POST" id="billForm">
            
            <!-- Customer Info -->
            <h5 class="fw-bold text-primary mb-3"><i class="fa-solid fa-user me-2"></i>Customer Details</h5>
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Date</label>
                    <input type="text" name="bill_date" class="form-control date-picker" value="{{ today }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Sales Person</label>
                    <select name="sales_person" class="form-select">
                        <option value="Office">Office Staff</option>
                        <option value="Owner">Owner</option>
                        <option value="Manager">Manager</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Customer Name</label>
                    <input type="text" name="customer_name" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold">Mobile</label>
                    <input type="tel" name="customer_mobile" class="form-control">
                </div>
                <div class="col-12">
                    <label class="form-label small fw-bold">Address</label>
                    <input type="text" name="customer_address" class="form-control">
                </div>
            </div>

            <!-- Product Table -->
            <h5 class="fw-bold text-primary mb-3"><i class="fa-solid fa-cart-shopping me-2"></i>Items</h5>
            <div class="table-responsive mb-3">
                <table class="table styled-table" id="billTable">
                    <thead>
                        <tr>
                            <th width="5%">#</th>
                            <th width="10%">Img</th>
                            <th width="40%">Product</th>
                            <th width="15%">Price</th>
                            <th width="15%">Qty</th>
                            <th width="15%">Total</th>
                            <th width="5%"></th>
                        </tr>
                    </thead>
                    <tbody id="billBody">
                        <!-- Rows will be added by JS -->
                    </tbody>
                </table>
            </div>
            
            <button type="button" class="btn btn-outline-primary mb-4" onclick="addBillRow()">
                <i class="fa-solid fa-plus"></i> Add Item
            </button>

            <!-- Calculations -->
            <div class="row justify-content-end">
                <div class="col-md-4">
                    <div class="card bg-light border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Sub Total:</span>
                                <span class="fw-bold" id="subTotal">0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2 align-items-center">
                                <span>Discount:</span>
                                <input type="number" name="discount" class="form-control form-control-sm w-50 text-end" value="0" oninput="calcTotal()">
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fs-5">
                                <span class="fw-bold text-primary">Grand Total:</span>
                                <span class="fw-bold text-primary" id="grandTotal">0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-success btn-lg px-5 rounded-pill shadow">
                    <i class="fa-solid fa-print me-2"></i> Save & Print Bill
                </button>
            </div>

        </form>
    </div>
</div>

<script>
    const products = {{ products | tojson | safe }};
    let rowCount = 0;

    function addBillRow() {
        rowCount++;
        const tbody = document.getElementById('billBody');
        const tr = document.createElement('tr');
        
        let options = '<option value="">Select Product</option>';
        products.forEach(p => {
            options += `<option value="${p.id}" data-price="${p.price}" data-img="${p.image}">${p.name} (Stock: ${p.stock})</option>`;
        });

        tr.innerHTML = `
            <td class="text-center align-middle">${rowCount}</td>
            <td class="text-center"><img src="" class="row-img rounded border" width="40" height="40" style="display:none; object-fit:cover;"></td>
            <td>
                <select name="product_id[]" class="form-select prod-select" required onchange="updateRow(this)">
                    ${options}
                </select>
            </td>
            <td><input type="number" name="price[]" class="form-control text-end row-price" readonly></td>
            <td><input type="number" name="qty[]" class="form-control text-center row-qty" value="1" min="1" oninput="updateRow(this)"></td>
            <td><input type="text" class="form-control text-end fw-bold row-total" readonly value="0.00"></td>
            <td class="text-center align-middle"><i class="fa-solid fa-trash text-danger cursor-pointer" onclick="removeRow(this)"></i></td>
        `;
        tbody.appendChild(tr);
    }

    function updateRow(el) {
        const tr = el.closest('tr');
        const select = tr.querySelector('.prod-select');
        const priceIn = tr.querySelector('.row-price');
        const qtyIn = tr.querySelector('.row-qty');
        const totalIn = tr.querySelector('.row-total');
        const img = tr.querySelector('.row-img');

        const option = select.options[select.selectedIndex];
        
        if (select.value) {
            priceIn.value = option.dataset.price;
            img.src = option.dataset.img;
            img.style.display = 'inline-block';
        }

        const qty = parseFloat(qtyIn.value) || 0;
        const price = parseFloat(priceIn.value) || 0;
        totalIn.value = (qty * price).toFixed(2);

        calcTotal();
    }

    function removeRow(el) {
        el.closest('tr').remove();
        calcTotal();
    }

    function calcTotal() {
        let sub = 0;
        document.querySelectorAll('.row-total').forEach(el => sub += parseFloat(el.value));
        
        document.getElementById('subTotal').textContent = sub.toFixed(2);
        
        const disc = parseFloat(document.querySelector('input[name="discount"]').value) || 0;
        const grand = sub - disc;
        
        document.getElementById('grandTotal').textContent = grand.toFixed(2);
    }

    document.addEventListener("DOMContentLoaded", function() {
        flatpickr(".date-picker", { dateFormat: "d-m-Y", allowInput: true });
        addBillRow(); // Add first row
    });
</script>
{% endblock %}
