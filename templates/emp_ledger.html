{% extends 'admin_master.html' %}

{% block title %}{{ employee.name }}'s Ledger{% endblock %}

{% block page_content %}
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body d-flex align-items-center p-4">
                <img src="{{ url_for('static', filename=employee.image or 'images/default-avatar.png') }}" alt="{{ employee.name }}" class="me-4" style="width: 90px; height: 90px; object-fit: cover; border-radius: 50%;">
                <div>
                    <h2 class="mb-0">{{ employee.name }}</h2>
                    <p class="text-muted mb-1">{{ employee.position }} | {{ employee.email }}</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card shadow-sm border-0 h-100 {% if final_balance > 0 %}bg-danger-subtle text-danger-emphasis{% else %}bg-success-subtle text-success-emphasis{% endif %}">
            <div class="card-body text-center p-4">
                <h6 class="text-uppercase small mb-2">Current Due Balance</h6>
                <h1 class="display-5 fw-bold mb-0">{{ (final_balance|abs)|inr }}</h1>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0">
  <div class="card-header bg-light d-flex justify-content-between align-items-center p-3">
    <h4 class="mb-0">Transaction History</h4>
    <a href="{{ url_for('add_transaction', employee_id=employee.id) }}" class="btn btn-success">
        <i class="fa-solid fa-plus-circle me-1"></i> Add New Transaction
    </a>
  </div>
  <div class="card-body p-0">
    <table class="table table-hover align-middle mb-0">
      <thead>
        <tr class="text-uppercase small">
          <th class="ps-4">Date</th>
          <th>Type</th>
          <th class="text-end">Debit (Given)</th>
          <th class="text-end">Credit (Received)</th>
          <th class="text-end">Balance</th>
          <th class="text-center pe-4">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for t in transactions %}
        <tr>
          <td class="ps-4">{{ t.transaction_date.strftime('%d-%m-%Y') }}</td>
          <td>
            {% if t.type == 'debit' %}
              <span class="badge bg-danger-subtle text-danger-emphasis p-2">Debit</span>
            {% else %}
              <span class="badge bg-success-subtle text-success-emphasis p-2">Credit


            </span>
            {% endif %}
          </td>
          <td class="text-end text-danger fw-medium">{% if t.type == 'debit' %}{{ t.amount|inr }}{% endif %}</td>
          <td class="text-end text-success fw-medium">{% if t.type == 'credit' %}{{ t.amount|inr }}{% endif %}</td>
          <td class="text-end fw-bold {% if t.balance > 0 %}text-danger{% endif %}">{{ (t.balance|abs)|inr }}</td>
          <td class="text-center pe-4">
            <button type="button" class="btn btn-outline-secondary btn-sm view-btn" 
                    data-bs-toggle="modal" data-bs-target="#viewTransactionModal"
                    data-id="{{ t.id }}"
                    data-date="{{ t.transaction_date.strftime('%d-%m-%Y') }}"
                    data-type="{{ t.type|title }}"
                    data-amount="{{ t.amount|inr }}"
                    data-description="{{ t.description }}"
                    data-created="{{ t.created_at.strftime('%d-%m-%Y %I:%M %p') }}">
                <i class="fa-solid fa-eye"></i>
            </button>
            <a href="{{ url_for('edit_transaction', transaction_id=t.id) }}" class="btn btn-outline-primary btn-sm"><i class="fa-solid fa-pencil-alt"></i></a>
            <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal" data-id="{{ t.id }}"><i class="fa-solid fa-trash"></i></button>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="6" class="text-center p-5">No transactions found. Start by adding one!</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="viewTransactionModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Transaction Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between"><strong>Transaction ID:</strong> <span id="view-id"></span></li>
          <li class="list-group-item d-flex justify-content-between"><strong>Date:</strong> <span id="view-date"></span></li>
          <li class="list-group-item d-flex justify-content-between"><strong>Type:</strong> <span id="view-type"></span></li>
          <li class="list-group-item d-flex justify-content-between"><strong>Amount:</strong> <span id="view-amount" class="fw-bold"></span></li>
          <li class="list-group-item d-flex justify-content-between"><strong>Recorded On:</strong> <span id="view-created"></span></li>
          <li class="list-group-item flex-column"><strong>Description:</strong><p id="view-description" class="mt-1 mb-0 text-muted"></p></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Confirm Deletion</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Are you sure you want to delete this transaction?</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><form id="deleteForm" method="POST"><button type="submit" class="btn btn-danger">Delete</button></form></div></div></div></div>
{% endblock %}

{% block page_scripts %}
<script>
// JavaScript for populating the VIEW modal
const viewModal = document.getElementById('viewTransactionModal');
viewModal.addEventListener('show.bs.modal', event => {
  const button = event.relatedTarget;
  document.getElementById('view-id').textContent = button.dataset.id;
  document.getElementById('view-date').textContent = button.dataset.date;
  document.getElementById('view-type').textContent = button.dataset.type;
  document.getElementById('view-amount').textContent = button.dataset.amount;
  document.getElementById('view-description').textContent = button.dataset.description || 'N/A';
  document.getElementById('view-created').textContent = button.dataset.created;
});

// JavaScript for the DELETE modal
const deleteModal = document.getElementById('deleteModal');
deleteModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const transactionId = button.dataset.id;
    document.getElementById('deleteForm').action = `/delete-transaction/${transactionId}`;
});
</script>
{% endblock %}