{% extends 'admin_master.html' %}

{% block title %}{{ employee.name }}'s Ledger{% endblock %}

{% block page_content %}
<!-- External Libs -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* Modern Variables */
    :root {
        --glass-bg: rgba(255, 255, 255, 0.85);
        --glass-border: 1px solid rgba(255, 255, 255, 0.6);
        --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* KPI Cards */
    .kpi-card {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        border-radius: 20px;
        border: var(--glass-border);
        box-shadow: var(--glass-shadow);
        padding: 1.5rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,0.1); }
    
    .kpi-icon-bg {
        position: absolute;
        top: -20px;
        right: -20px;
        font-size: 5rem;
        opacity: 0.05;
        transform: rotate(15deg);
    }

    /* Ledger Table */
    .ledger-container {
        background: white;
        border-radius: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.02);
        padding: 0; /* Removing padding for flush table */
        overflow: hidden;
        border: 1px solid rgba(0,0,0,0.04);
        margin-top: 2rem;
    }
    
    .table-modern thead th {
        background: #f8f9fa;
        color: #6c757d;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 1px;
        padding: 1.2rem 1.5rem;
        border-bottom: 2px solid #edf2f7;
    }
    
    .table-modern tbody td {
        padding: 1.2rem 1.5rem;
        vertical-align: middle;
        border-bottom: 1px solid #edf2f7;
        font-size: 0.95rem;
    }

    .table-modern tbody tr:last-child td { border-bottom: none; }
    .table-modern tbody tr:hover { background-color: #fafbfc; }

    /* Badges */
    .mode-badge {
        padding: 0.35em 0.8em;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .mode-cash { background: #e6fffa; color: #2c7a7b; border: 1px solid #b2f5ea; }
    .mode-online { background: #ebf8ff; color: #2b6cb0; border: 1px solid #bee3f8; }
    .mode-cheque { background: #fffaf0; color: #c05621; border: 1px solid #feebc8; }

    /* Type Indicator */
    .type-dot {
        height: 10px; width: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    .type-credit { background-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }
    .type-debit { background-color: #ef4444; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2); }

    /* Balance Highlight */
    .balance-positive { color: #059669; font-weight: 700; } /* Green for Advance/Clear */
    .balance-negative { color: #dc2626; font-weight: 700; } /* Red for Due */

    /* Action Buttons */
    .action-btn-group .btn {
        width: 32px; height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: all 0.2s;
    }
    .btn-edit-light { background: #f0f9ff; color: #0ea5e9; }
    .btn-edit-light:hover { background: #0ea5e9; color: white; }
    .btn-del-light { background: #fef2f2; color: #ef4444; }
    .btn-del-light:hover { background: #ef4444; color: white; }

</style>

<div class="container-fluid py-5 fade-in-up">

    <!-- 1. Header & Quick Actions -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-5 gap-4">
        
        <!-- Profile -->
        <div class="d-flex align-items-center">
            <div class="position-relative">
                {% if employee.image %}
                    <img src="{{ employee.image|fix_image }}" class="rounded-circle border border-4 border-white shadow-sm" width="70" height="70" style="object-fit: cover;">
                {% else %}
                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center border shadow-sm" style="width: 70px; height: 70px;">
                        <i class="fa-solid fa-user fa-2x text-secondary"></i>
                    </div>
                {% endif %}
                <span class="position-absolute bottom-0 end-0 p-1 bg-success border border-white rounded-circle"></span>
            </div>
            <div class="ms-3">
                <h3 class="fw-bold text-dark mb-0">{{ employee.name }}</h3>
                <p class="text-muted mb-0 small">{{ employee.position or 'Employee' }} | {{ employee.phone }}</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-2">
            <a href="{{ url_for('emp_list') }}" class="btn btn-light rounded-pill border px-4 fw-bold text-secondary">
                <i class="fa-solid fa-arrow-left me-2"></i>Back
            </a>
            <a href="{{ url_for('employee_ledger_pdf', employee_id=employee.id) }}" class="btn btn-outline-danger rounded-pill px-4 fw-bold border-2">
                <i class="fa-solid fa-file-pdf me-2"></i>Statement
            </a>
            
            <!-- WhatsApp Smart Logic -->
            {% if final_balance > 0 %}
                {% set msg = "Hello " ~ employee.name ~ ", your current Pending Due is Rs. " ~ (final_balance|abs|inr) %}
            {% else %}
                {% set msg = "Hello " ~ employee.name ~ ", your current Advance Balance is Rs. " ~ (final_balance|abs|inr) %}
            {% endif %}
            <a href="https://wa.me/91{{ employee.phone }}?text={{ msg }}" target="_blank" class="btn btn-success rounded-pill px-4 fw-bold text-white shadow-sm" style="background: #25D366; border: none;">
                <i class="fa-brands fa-whatsapp me-2"></i>Share
            </a>
        </div>
    </div>

    <!-- 2. KPI Cards Row -->
    <div class="row g-4 mb-5">
        <!-- Total Credit (Received) -->
        <div class="col-md-4">
            <div class="kpi-card h-100">
                <i class="fa-solid fa-arrow-down kpi-icon-bg text-success"></i>
                <p class="text-uppercase text-muted fw-bold small mb-1 ls-1">Total Credit (Received)</p>
                <h2 class="fw-800 text-success mb-0">{{ total_credit|inr }}</h2>
            </div>
        </div>

        <!-- Total Debit (Given) -->
        <div class="col-md-4">
            <div class="kpi-card h-100">
                <i class="fa-solid fa-arrow-up kpi-icon-bg text-danger"></i>
                <p class="text-uppercase text-muted fw-bold small mb-1 ls-1">Total Debit (Given)</p>
                <h2 class="fw-800 text-danger mb-0">{{ total_debit|inr }}</h2>
            </div>
        </div>

        <!-- Net Balance -->
        <div class="col-md-4">
            <div class="kpi-card h-100 {% if final_balance > 0 %}border-danger{% else %}border-success{% endif %}" style="border-width: 0 0 0 4px;">
                <i class="fa-solid fa-scale-balanced kpi-icon-bg text-primary"></i>
                <p class="text-uppercase text-muted fw-bold small mb-1 ls-1">Net Balance</p>
                <h2 class="fw-800 mb-0 {% if final_balance > 0 %}text-danger{% else %}text-success{% endif %}">
                    {{ final_balance|abs|inr }} 
                    <span class="fs-6 fw-normal text-muted ms-1">
                        {% if final_balance > 0 %}(Due from Emp){% else %}(Advance with Emp){% endif %}
                    </span>
                </h2>
            </div>
        </div>
    </div>

    <!-- 3. Transaction Actions Bar -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold text-dark mb-0"><i class="fa-solid fa-clock-rotate-left me-2 text-primary"></i>Transaction History</h5>
        <div class="d-flex gap-2">
            {% if not has_opening_balance %}
            <a href="{{ url_for('add_opening_balance', employee_id=employee.id) }}" class="btn btn-sm btn-white border shadow-sm rounded-pill px-3 fw-bold text-muted">
                <i class="fa-solid fa-plus me-1"></i> Opening
            </a>
            {% endif %}
            
            <a href="{{ url_for('add_transaction', employee_id=employee.id, type='credit') }}" class="btn btn-sm rounded-pill px-4 fw-bold text-white shadow-sm" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border:none;">
                <i class="fa-solid fa-circle-arrow-down me-2"></i>Credit (In)
            </a>
            
            <a href="{{ url_for('add_transaction', employee_id=employee.id, type='debit') }}" class="btn btn-sm rounded-pill px-4 fw-bold text-white shadow-sm" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border:none;">
                <i class="fa-solid fa-circle-arrow-up me-2"></i>Debit (Out)
            </a>
        </div>
    </div>

    <!-- 4. Ledger Table -->
    <div class="ledger-container">
        <div class="table-responsive">
            <table class="table table-modern mb-0">
                <thead>
                    <tr>
                        <th class="ps-4">Date & Time</th>
                        <th>Type</th>
                        <th>Description / Note</th>
                        <th>Mode</th>
                        <th class="text-end">Amount</th>
                        <th class="text-end pe-4">Balance</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in transactions %}
                    <tr>
                        <td class="ps-4">
                            <div class="fw-bold text-dark">{{ t.transaction_date.strftime('%d-%m-%Y') if t.transaction_date else 'N/A' }}</div>
                            <div class="small text-muted" style="font-size: 0.75rem;">
                                <i class="fa-regular fa-clock me-1"></i>{{ t.time_str }}
                            </div>
                        </td>
                        
                        <!-- Type Column with Dot -->
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="type-dot {% if t.type == 'credit' %}type-credit{% else %}type-debit{% endif %}"></span>
                                <span class="fw-bold text-dark text-capitalize">{{ t.type }}</span>
                            </div>
                        </td>

                        <!-- Description -->
                        <td class="text-muted">
                            <div class="text-truncate" style="max-width: 250px;" title="{{ t.description }}">{{ t.description }}</div>
                        </td>

                        <!-- Payment Mode -->
                        <td>
                            {% set mode = t.payment_mode|lower %}
                            <span class="mode-badge 
                                {% if 'cash' in mode %}mode-cash
                                {% elif 'online' in mode or 'upi' in mode %}mode-online
                                {% else %}mode-cheque{% endif %}">
                                {{ t.payment_mode or 'Cash' }}
                            </span>
                        </td>

                        <!-- Amount -->
                        <td class="text-end fw-bold {% if t.type == 'debit' %}text-danger{% else %}text-success{% endif %}">
                            {{ t.amount|inr }}
                        </td>

                        <!-- Balance -->
                        <td class="text-end pe-4">
                            <span class="{% if t.balance > 0 %}balance-negative{% else %}balance-positive{% endif %}">
                                {{ t.balance|abs|inr }} 
                                <small class="text-muted fw-normal ms-1">
                                    {% if t.balance > 0 %}Dr{% else %}Cr{% endif %}
                                </small>
                            </span>
                        </td>

                        <!-- Actions -->
                        <td class="text-center">
                            <div class="action-btn-group">
                                <a href="{{ url_for('edit_transaction', transaction_id=t.id) }}" class="btn btn-edit-light me-1" title="Edit">
                                    <i class="fa-solid fa-pencil"></i>
                                </a>
                                <button type="button" class="btn btn-del-light" onclick="confirmDelete({{ t.id }}, '{{ t.amount|inr }}')" title="Delete">
                                    <i class="fa-regular fa-trash-can"></i>
                                </button>
                                <form id="delete-form-{{ t.id }}" action="{{ url_for('delete_transaction', transaction_id=t.id) }}" method="POST" style="display: none;"></form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="opacity-50">
                                <i class="fa-solid fa-receipt fa-3x mb-3 text-secondary"></i>
                                <p class="mb-0 fw-bold text-secondary">No transactions found.</p>
                                <small class="text-muted">Start by adding an Opening Balance or Credit/Debit entry.</small>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function confirmDelete(id, amount) {
        Swal.fire({
            title: 'Delete Transaction?',
            text: "You are about to delete an entry of " + amount + ". This will recalculate the ledger.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: 'Yes, Delete',
            cancelButtonText: 'Cancel',
            customClass: {
                popup: 'rounded-4 border-0 shadow-lg',
                confirmButton: 'rounded-pill px-4',
                cancelButton: 'rounded-pill px-4'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('delete-form-' + id).submit();
            }
        })
    }
</script>
{% endblock %}
