{% extends 'admin_master.html' %}

{% block title %}{{ employee.name }}'s Ledger{% endblock %}

{% block page_content %}
<!-- Load Custom CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/employee_finance.css') }}">

<div class="container-fluid py-4 fade-in-up">

    <!-- Top Navigation -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{{ url_for('emp_list') }}" class="btn btn-light bg-white border rounded-pill shadow-sm px-4 fw-medium">
            <i class="fa-solid fa-arrow-left me-2"></i> Back
        </a>
        
        <div class="d-flex gap-2">
            <!-- PDF Download -->
            <a href="{{ url_for('employee_ledger_pdf', employee_id=employee.id) }}" class="btn btn-white border rounded-pill px-3 shadow-sm hover-lift">
                <i class="fa-solid fa-file-pdf text-danger me-2"></i> Report
            </a>
            
            <!-- SMART WHATSAPP LOGIC -->
            {% if final_balance > 0 %}
                <!-- Case: Positive Balance (Employee Owes Company) -->
                {% set w_status = "Debit (Due Amount)" %}
                {% set w_msg = "Hello " ~ employee.name ~ ", your current pending due amount is " ~ (final_balance|abs|inr) %}
            {% else %}
                <!-- Case: Negative Balance (Company Owes Employee/Advance) -->
                {% set w_status = "Credit (Advance/Clear)" %}
                {% set w_msg = "Hello " ~ employee.name ~ ", your current credit balance (advance) is " ~ (final_balance|abs|inr) %}
            {% endif %}
            
            <a href="https://wa.me/91{{ employee.phone }}?text={{ w_msg }}" target="_blank" class="btn btn-success rounded-pill px-4 text-white shadow-sm fw-medium">
                <i class="fa-brands fa-whatsapp me-2"></i> Share Status
            </a>
        </div>
    </div>

    <div class="row g-4">
        
        <!-- LEFT: Profile & Quick Stats -->
        <div class="col-lg-4">
            <div class="glass-card p-4 text-center h-100">
                
                <!-- Profile Image -->
                <div class="mb-3 position-relative d-inline-block">
                    {% if employee.image %}
                        <img src="{{ cloudinary_url(employee.image)[0] }}" class="profile-img-lg">
                    {% else %}
                        <div class="profile-img-lg bg-light d-flex align-items-center justify-content-center text-secondary">
                            <i class="fa-solid fa-user fa-2x"></i>
                        </div>
                    {% endif %}
                    <span class="position-absolute bottom-0 end-0 p-2 bg-success border border-white rounded-circle"></span>
                </div>

                <h4 class="fw-bold mb-1">{{ employee.name }}</h4>
                <p class="text-muted small mb-4">{{ employee.position }}</p>

                <!-- Main Balance Display -->
                <div class="p-3 rounded-4 bg-light mb-4 border">
                    <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Net Balance</small>
                    <h2 class="display-6 fw-bold mb-0 {% if final_balance > 0 %}text-danger{% else %}text-success{% endif %}">
                        {{ final_balance|abs|inr }}
                    </h2>
                    <div class="mt-1">
                        {% if final_balance > 0 %}
                            <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill">You will Receive (Debit)</span>
                        {% elif final_balance < 0 %}
                            <span class="badge bg-success bg-opacity-10 text-success rounded-pill">You will Pay (Credit)</span>
                        {% else %}
                            <span class="badge bg-secondary bg-opacity-10 text-secondary rounded-pill">Settled (Zero)</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="row g-2 mb-4">
                    <div class="col-6">
                        <div class="p-3 border rounded-3 bg-white">
                            <small class="text-muted d-block text-uppercase" style="font-size:0.65rem">Total Given</small>
                            <span class="fw-bold text-danger">{{ total_debit|inr }}</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 border rounded-3 bg-white">
                            <small class="text-muted d-block text-uppercase" style="font-size:0.65rem">Total Received</small>
                            <span class="fw-bold text-success">{{ total_credit|inr }}</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="d-grid gap-2">
                    <a href="{{ url_for('add_transaction', employee_id=employee.id, type='debit') }}" class="btn-action-card btn-debit">
                        <div class="d-flex align-items-center">
                            <div class="bg-white p-2 rounded-circle me-3 text-danger"><i class="fa-solid fa-arrow-up"></i></div>
                            <div>
                                <h6 class="mb-0 fw-bold">Give Money</h6>
                                <small class="opacity-75">Debit Record</small>
                            </div>
                        </div>
                    </a>
                    <a href="{{ url_for('add_transaction', employee_id=employee.id, type='credit') }}" class="btn-action-card btn-credit">
                        <div class="d-flex align-items-center">
                            <div class="bg-white p-2 rounded-circle me-3 text-success"><i class="fa-solid fa-arrow-down"></i></div>
                            <div>
                                <h6 class="mb-0 fw-bold">Receive / Salary</h6>
                                <small class="opacity-75">Credit Record</small>
                            </div>
                        </div>
                    </a>
                </div>
                
                {% if not has_opening_balance %}
                <div class="mt-3">
                    <a href="{{ url_for('add_opening_balance', employee_id=employee.id) }}" class="text-decoration-none text-muted small fw-bold">
                        <i class="fa-solid fa-plus-circle me-1"></i> Add Opening Balance
                    </a>
                </div>
                {% endif %}

            </div>
        </div>

        <!-- RIGHT: Transaction History -->
        <div class="col-lg-8">
            <div class="glass-card h-100 overflow-hidden d-flex flex-column">
                <div class="p-4 border-bottom bg-white d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">Transaction History</h5>
                    <span class="badge bg-light text-dark border">{{ transactions|length }} Records</span>
                </div>

                <div class="table-responsive flex-grow-1">
                    <table class="ledger-table">
                        <thead>
                            <tr>
                                <th class="ps-4">Date & Time</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th class="text-end">Amount</th>
                                <th class="text-end">Balance</th>
                                <th class="text-center pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in transactions %}
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-bold text-dark">{{ t.transaction_date.strftime('%d %b, %Y') }}</div>
                                    <div class="text-muted small"><i class="fa-regular fa-clock me-1"></i>{{ t.time_str }}</div>
                                </td>
                                <td>
                                    {% if t.type == 'debit' %}
                                        <span class="status-badge badge-debit">
                                            <i class="fa-solid fa-arrow-up"></i> Debit
                                        </span>
                                    {% else %}
                                        <span class="status-badge badge-credit">
                                            <i class="fa-solid fa-arrow-down"></i> Credit
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="text-dark d-block text-truncate" style="max-width: 200px;">{{ t.description }}</span>
                                </td>
                                <td class="text-end fw-bold {{ 'text-danger' if t.type == 'debit' else 'text-success' }}">
                                    {{ t.amount|inr }}
                                </td>
                                <td class="text-end fw-bold text-secondary">
                                    {{ t.balance|inr }}
                                </td>
                                <td class="text-center pe-4">
                                    <div class="d-flex justify-content-center gap-2">
                                        <!-- EDIT BUTTON -->
                                        <a href="{{ url_for('edit_transaction', transaction_id=t.id) }}" class="btn btn-sm btn-light border text-primary shadow-sm rounded-circle" style="width:32px; height:32px; display:flex; align-items:center; justify-content:center;" title="Edit">
                                            <i class="fa-solid fa-pen"></i>
                                        </a>
                                        
                                        <!-- DELETE BUTTON -->
                                        <button type="button" class="btn btn-sm btn-light border text-danger shadow-sm rounded-circle" style="width:32px; height:32px; display:flex; align-items:center; justify-content:center;" data-bs-toggle="modal" data-bs-target="#delModal{{ t.id }}" title="Delete">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </div>

                                    <!-- Delete Modal -->
                                    <div class="modal fade" id="delModal{{ t.id }}" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog modal-sm modal-dialog-centered">
                                            <div class="modal-content border-0 shadow-lg rounded-4">
                                                <div class="modal-body text-center p-4">
                                                    <div class="mb-3 text-danger">
                                                        <i class="fa-solid fa-circle-exclamation fa-3x"></i>
                                                    </div>
                                                    <h6 class="fw-bold">Delete Record?</h6>
                                                    <p class="text-muted small">This cannot be undone.</p>
                                                    <div class="d-flex justify-content-center gap-2">
                                                        <button type="button" class="btn btn-light btn-sm rounded-pill px-3" data-bs-dismiss="modal">Cancel</button>
                                                        <form action="{{ url_for('delete_transaction', transaction_id=t.id) }}" method="POST">
                                                            <button type="submit" class="btn btn-danger btn-sm rounded-pill px-3">Delete</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-5">
                                    <div class="text-muted opacity-50">
                                        <i class="fa-solid fa-receipt fa-3x mb-3"></i>
                                        <p>No transactions found.</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
