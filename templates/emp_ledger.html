{% extends 'admin_master.html' %}

{% block title %}{{ employee.name }}'s Ledger{% endblock %}

{% block page_content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/employee_finance.css') }}">
<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<div class="container-fluid py-4 fade-in-up">

    <!-- Top Nav -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{{ url_for('emp_list') }}" class="btn btn-light rounded-pill border shadow-sm px-3 text-muted fw-bold small">
            <i class="fa-solid fa-arrow-left me-1"></i> Back to List
        </a>
        
        <!-- Action Group -->
        <div class="d-flex gap-2">
            <!-- PDF Button -->
            <a href="{{ url_for('employee_ledger_pdf', employee_id=employee.id) }}" class="btn btn-outline-danger rounded-pill px-3 shadow-sm border-0 bg-white">
                <i class="fa-solid fa-file-pdf me-2"></i> PDF
            </a>
            
            <!-- SMART WHATSAPP LOGIC -->
            {% if final_balance > 0 %}
                {% set msg = "Hello " ~ employee.name ~ ", your current Pending Due is Rs. " ~ (final_balance|abs|inr) %}
            {% else %}
                {% set msg = "Hello " ~ employee.name ~ ", your current Advance Balance is Rs. " ~ (final_balance|abs|inr) %}
            {% endif %}
            
            <a href="https://wa.me/91{{ employee.phone }}?text={{ msg }}" target="_blank" class="btn btn-success rounded-pill px-4 text-white shadow-sm border-0">
                <i class="fa-brands fa-whatsapp me-2"></i> Share
            </a>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <!-- LEFT: Profile & Key Metrics -->
        <div class="col-lg-4">
            <div class="glass-card p-4 text-center h-100">
                
                <!-- Profile Image -->
                <div class="mb-3 position-relative d-inline-block">
                    {% if employee.image %}
                        <img src="{{ cloudinary_url(employee.image)[0] }}" class="profile-img-lg">
                    {% else %}
                        <div class="profile-img-lg bg-light d-flex align-items-center justify-content-center text-secondary">
                            <i class="fa-solid fa-user fa-2x"></i>
                        </div>
                    {% endif %}
                    <span class="position-absolute bottom-0 end-0 p-2 bg-success border border-white rounded-circle"></span>
                </div>

                <h4 class="fw-bold mb-1">{{ employee.name }}</h4>
                <p class="text-muted small mb-4">{{ employee.position }}</p>

                <!-- Current Balance (Big) -->
                <div class="p-3 rounded-4 bg-light mb-4 border">
                    <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Net Balance</small>
                    <h2 class="display-6 fw-bold mb-0 {% if final_balance > 0 %}text-danger{% else %}text-success{% endif %}">
                        {{ final_balance|abs|inr }}
                    </h2>
                    <div class="mt-1">
                        {% if final_balance > 0 %}
                            <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill">You will Receive (Debit)</span>
                        {% elif final_balance < 0 %}
                            <span class="badge bg-success bg-opacity-10 text-success rounded-pill">You will Pay (Credit)</span>
                        {% else %}
                            <span class="badge bg-secondary bg-opacity-10 text-secondary rounded-pill">Settled (Zero)</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Stats Grid (Order: Credit First, then Debit) -->
                <div class="row g-2 mb-4">
                    <div class="col-6">
                        <div class="p-3 border rounded-3 bg-white">
                            <small class="text-success fw-bold d-block text-uppercase mb-1" style="font-size: 0.65rem;">Total Credit</small>
                            <h6 class="fw-bold text-dark mb-0">{{ total_credit|inr }}</h6>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 border rounded-3 bg-white">
                            <small class="text-danger fw-bold d-block text-uppercase mb-1" style="font-size: 0.65rem;">Total Debit</small>
                            <h6 class="fw-bold text-dark mb-0">{{ total_debit|inr }}</h6>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions (Order: Credit First, then Debit) -->
                <div class="d-grid gap-2">
                    <a href="{{ url_for('add_transaction', employee_id=employee.id, type='credit') }}" class="btn-action-card btn-credit">
                        <div class="d-flex align-items-center">
                            <div class="bg-white p-2 rounded-circle me-3 text-success"><i class="fa-solid fa-arrow-down"></i></div>
                            <div>
                                <h6 class="mb-0 fw-bold">Receive / Salary</h6>
                                <small class="opacity-75">Credit Record</small>
                            </div>
                        </div>
                    </a>
                    <a href="{{ url_for('add_transaction', employee_id=employee.id, type='debit') }}" class="btn-action-card btn-debit">
                        <div class="d-flex align-items-center">
                            <div class="bg-white p-2 rounded-circle me-3 text-danger"><i class="fa-solid fa-arrow-up"></i></div>
                            <div>
                                <h6 class="mb-0 fw-bold">Give Money</h6>
                                <small class="opacity-75">Debit Record</small>
                            </div>
                        </div>
                    </a>
                </div>
                
                {% if not has_opening_balance %}
                <div class="mt-3">
                    <a href="{{ url_for('add_opening_balance', employee_id=employee.id) }}" class="text-decoration-none text-muted small fw-bold">
                        <i class="fa-solid fa-plus-circle me-1"></i> Add Opening Balance
                    </a>
                </div>
                {% endif %}

            </div>
        </div>

        <!-- RIGHT: Transaction History -->
        <div class="col-lg-8">
            <div class="glass-card h-100 overflow-hidden d-flex flex-column">
                <div class="p-4 border-bottom bg-white d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">Transaction History</h5>
                    <span class="badge bg-light text-dark border">{{ transactions|length }} Records</span>
                </div>

                <div class="table-responsive flex-grow-1">
                    <table class="ledger-table">
                        <thead>
                            <tr>
                                <th class="ps-4">Date & Time</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th class="text-end">Amount</th>
                                <th class="text-end pe-4">Balance</th>
                                <th class="text-center pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in transactions %}
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-bold text-dark">{{ t.transaction_date.strftime('%d %b, %Y') }}</div>
                                    <div class="text-muted small" style="font-size: 0.75rem;">
                                        <i class="fa-regular fa-clock me-1"></i>{{ t.time_str }}
                                    </div>
                                </td>
                                <td>
                                    {% if t.type == 'credit' %}
                                        <span class="status-badge badge-credit">
                                            <i class="fa-solid fa-arrow-down"></i> Credit
                                        </span>
                                    {% else %}
                                        <span class="status-badge badge-debit">
                                            <i class="fa-solid fa-arrow-up"></i> Debit
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="text-dark d-block text-truncate" style="max-width: 200px;">{{ t.description }}</span>
                                </td>
                                <td class="text-end fw-bold {{ 'text-danger' if t.type == 'debit' else 'text-success' }}">
                                    {{ t.amount|inr }}
                                </td>
                                <td class="text-end pe-4 fw-bold text-secondary">
                                    {{ t.balance|inr }}
                                </td>
                                <td class="text-center pe-4">
                                    <div class="d-flex justify-content-center gap-2">
                                        <!-- Edit -->
                                        <a href="{{ url_for('edit_transaction', transaction_id=t.id) }}" class="btn-icon text-primary bg-light border-0 shadow-sm" title="Edit">
                                            <i class="fa-solid fa-pen"></i>
                                        </a>
                                        
                                        <!-- Delete (Popup) -->
                                        <button type="button" class="btn-icon text-danger bg-light border-0 shadow-sm" onclick="confirmDelete({{ t.id }}, '{{ t.amount|inr }}')" title="Delete">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                        
                                        <!-- Hidden Form -->
                                        <form id="delete-form-{{ t.id }}" action="{{ url_for('delete_transaction', transaction_id=t.id) }}" method="POST" style="display: none;"></form>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-5">
                                    <div class="text-muted opacity-50">
                                        <i class="fa-solid fa-receipt fa-3x mb-3"></i>
                                        <p>No transactions found.</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SweetAlert2 Script -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function confirmDelete(id, amount) {
        Swal.fire({
            title: 'Are you sure?',
            text: "You are about to delete a transaction of " + amount + ". This cannot be undone!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Yes, delete it!',
            background: 'rgba(255, 255, 255, 0.95)',
            backdrop: `rgba(0,0,0,0.4)`
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('delete-form-' + id).submit();
            }
        })
    }
</script>
{% endblock %}
