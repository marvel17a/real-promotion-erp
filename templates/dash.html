{% extends "admin_master.html" %}

{% block page_content %}
<div class="container-fluid" data-aos="fade-in">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0">Executive Overview</h2>
            <p class="text-muted small">Real-time business intelligence</p>
        </div>
        <div class="d-flex gap-2">
            <span class="badge bg-glass text-dark d-flex align-items-center px-3">
                <i class="fa-regular fa-clock me-2"></i> {{ today_date }}
            </span>
            <button class="btn btn-sm btn-outline-primary rounded-circle" onclick="location.reload()">
                <i class="fa-solid fa-sync"></i>
            </button>
        </div>
    </div>

    <!-- KPI ROW -->
    <div class="row g-4 mb-4">

        <div class="col-xl-3 col-md-6">
            <div class="glass-card p-4 h-100">
                <p class="text-muted text-uppercase fw-bold small mb-1">Total Revenue</p>
                <h3 class="fw-bold text-primary mb-0">
                    ₹{{ "{:,.0f}".format(total_sales) }}
                </h3>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="glass-card p-4 h-100 border-start border-4 border-warning">
                <p class="text-muted text-uppercase fw-bold small mb-1">Supplier Dues</p>
                <h3 class="fw-bold text-warning mb-0">
                    ₹{{ "{:,.0f}".format(supplier_dues) }}
                </h3>
                <small class="text-danger">Pending</small>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="glass-card p-4 h-100">
                <p class="text-muted text-uppercase fw-bold small mb-1">Op. Expenses</p>
                <h3 class="fw-bold text-danger mb-0">
                    ₹{{ "{:,.0f}".format(total_expenses) }}
                </h3>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="glass-card p-4 h-100">
                <p class="text-muted text-uppercase fw-bold small mb-1">Inventory Alert</p>
                <h3 class="fw-bold text-dark mb-0">{{ low_stock }}</h3>
            </div>
        </div>

    </div>

    <!-- CHART ROW -->
    <div class="row g-4 mb-4">

        <div class="col-lg-8">
            <div class="glass-card p-4 h-100">
                <h5 class="fw-bold mb-3">Financial Performance</h5>
                <div style="height:300px">
                    <canvas id="financeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="glass-card p-4 h-100">
                <h5 class="fw-bold mb-3">Top Selling Items</h5>
                <div style="height:250px">
                    <canvas id="productChart"></canvas>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ✅ SAFE JSON DATA INJECTION -->
<script id="chart-months" type="application/json">
{{ chart_months | default([]) | tojson }}
</script>

<script id="chart-sales" type="application/json">
{{ chart_sales | default([]) | tojson }}
</script>

<script id="chart-expenses" type="application/json">
{{ chart_expenses | default([]) | tojson }}
</script>

<script id="prod-names" type="application/json">
{{ top_prod_names | default([]) | tojson }}
</script>

<script id="prod-qty" type="application/json">
{{ top_prod_qty | default([]) | tojson }}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const months = JSON.parse(
        document.getElementById("chart-months").textContent.trim()
    );
    const salesData = JSON.parse(
        document.getElementById("chart-sales").textContent.trim()
    );
    const expenseData = JSON.parse(
        document.getElementById("chart-expenses").textContent.trim()
    );

    new Chart(document.getElementById("financeChart"), {
        type: "bar",
        data: {
            labels: months,
            datasets: [
                {
                    label: "Sales",
                    data: salesData,
                    backgroundColor: "rgba(52,152,219,0.8)",
                    borderRadius: 5
                },
                {
                    label: "Expenses",
                    data: expenseData,
                    backgroundColor: "rgba(231,76,60,0.8)",
                    borderRadius: 5
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });

    const prodNames = JSON.parse(
        document.getElementById("prod-names").textContent.trim()
    );
    const prodQty = JSON.parse(
        document.getElementById("prod-qty").textContent.trim()
    );

    new Chart(document.getElementById("productChart"), {
        type: "doughnut",
        data: {
            labels: prodNames,
            datasets: [{
                data: prodQty,
                backgroundColor: [
                    "#3498db", "#9b59b6", "#2ecc71", "#f1c40f", "#e67e22"
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "70%"
        }
    });

});
</script>

<style>
.bg-glass {
    background: rgba(255,255,255,0.5);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255,255,255,0.4);
    border-radius: 20px;
}
</style>
{% endblock %}
