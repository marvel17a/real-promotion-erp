{% extends "admin_master.html" %}

{% block page_content %}
<!-- Link to Custom Dashboard CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/dash.css') }}">

<div class="container-fluid py-4" data-aos="fade-in">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-5 dashboard-header">
        <div>
            <h2 class="mb-1">Overview</h2>
            <p class="text-muted mb-0">Financial Year {{ current_year }}</p>
        </div>
        <div class="d-flex gap-3 align-items-center">
            <div class="date-pill">
                <i class="fa-regular fa-calendar me-2 text-primary"></i>
                <!-- FIXED: Using the variable passed from Python -->
                {{ today_date.strftime('%d %B %Y') }}
            </div>
            <button class="btn btn-dark rounded-circle shadow-sm" style="width: 45px; height: 45px;" onclick="location.reload()" title="Refresh Data">
                <i class="fa-solid fa-arrows-rotate"></i>
            </button>
        </div>
    </div>

    <!-- ROW 1: KEY METRICS (Glass Cards) -->
    <div class="row g-4 mb-5">
        
        <!-- 1. SALES TODAY -->
        <div class="col-xl-3 col-md-6">
            <div class="glass-stat-card border-start border-5 border-primary shadow-sm h-100 p-4 position-relative overflow-hidden">
                <div class="d-flex justify-content-between align-items-start z-1 position-relative">
                    <div>
                        <p class="text-uppercase fw-bold text-muted small mb-2 ls-1">Sales Today</p>
                        <h2 class="fw-bold mb-0 text-dark">{{ sales_today|inr }}</h2>
                    </div>
                    <div class="icon-box bg-primary bg-opacity-10 text-primary rounded-3">
                        <i class="fa-solid fa-cash-register fa-lg"></i>
                    </div>
                </div>
                <!-- Decor Circle -->
                <div class="decor-circle bg-primary"></div>
            </div>
        </div>

        <!-- 2. MONTHLY SALES -->
        <div class="col-xl-3 col-md-6">
            <div class="glass-stat-card border-start border-5 border-success shadow-sm h-100 p-4 position-relative overflow-hidden">
                <div class="d-flex justify-content-between align-items-start z-1 position-relative">
                    <div>
                        <p class="text-uppercase fw-bold text-muted small mb-2 ls-1">This Month</p>
                        <h2 class="fw-bold mb-0 text-dark">{{ sales_this_month|inr }}</h2>
                    </div>
                    <div class="icon-box bg-success bg-opacity-10 text-success rounded-3">
                        <i class="fa-solid fa-chart-line fa-lg"></i>
                    </div>
                </div>
                <div class="decor-circle bg-success"></div>
            </div>
        </div>

        <!-- 3. SUPPLIER DUES -->
        <div class="col-xl-3 col-md-6">
            <div class="glass-stat-card border-start border-5 border-danger shadow-sm h-100 p-4 position-relative overflow-hidden">
                <div class="d-flex justify-content-between align-items-start z-1 position-relative">
                    <div>
                        <p class="text-uppercase fw-bold text-muted small mb-2 ls-1">Supplier Dues</p>
                        <h2 class="fw-bold mb-0 text-danger">{{ supplier_dues|inr }}</h2>
                    </div>
                    <div class="icon-box bg-danger bg-opacity-10 text-danger rounded-3">
                        <i class="fa-solid fa-file-invoice-dollar fa-lg"></i>
                    </div>
                </div>
                <div class="decor-circle bg-danger"></div>
            </div>
        </div>

        <!-- 4. LOW STOCK -->
        <div class="col-xl-3 col-md-6">
            <div class="glass-stat-card border-start border-5 border-warning shadow-sm h-100 p-4 position-relative overflow-hidden">
                <div class="d-flex justify-content-between align-items-start z-1 position-relative">
                    <div>
                        <p class="text-uppercase fw-bold text-muted small mb-2 ls-1">Low Stock</p>
                        <h2 class="fw-bold mb-0 text-dark">{{ low_stock }} <span class="fs-6 text-muted">Items</span></h2>
                    </div>
                    <div class="icon-box bg-warning bg-opacity-10 text-warning rounded-3">
                        <i class="fa-solid fa-triangle-exclamation fa-lg"></i>
                    </div>
                </div>
                <div class="decor-circle bg-warning"></div>
            </div>
        </div>
    </div>

    <!-- ROW 2: CHARTS -->
    <div class="row g-4 mb-5">
        <!-- Sales vs Expenses -->
        <div class="col-lg-8">
            <div class="card glass-card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between">
                    <h5 class="fw-bold mb-0">Sales vs Expenses ({{ current_year }})</h5>
                    <span class="badge bg-light text-dark border">Yearly Overview</span>
                </div>
                <div class="card-body px-4 pb-4">
                    <div class="chart-container" style="height: 320px;">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Products -->
        <div class="col-lg-4">
            <div class="card glass-card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="fw-bold mb-0">Top Selling Products</h5>
                </div>
                <div class="card-body px-4 pb-4 d-flex align-items-center justify-content-center">
                    <div class="chart-container" style="height: 280px; width: 100%;">
                        <canvas id="productChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // DATA FROM FLASK
    const months = {{ chart_months | tojson }};
    const salesData = {{ chart_sales | tojson }};
    const expenseData = {{ chart_expenses | tojson }};
    
    const prodNames = {{ top_prod_names | tojson }};
    const prodQty = {{ top_prod_qty | tojson }};

    // --- 1. MAIN CHART (Bar) ---
    const ctxMain = document.getElementById('mainChart').getContext('2d');
    
    // Gradient for Sales
    const gradientSales = ctxMain.createLinearGradient(0, 0, 0, 400);
    gradientSales.addColorStop(0, 'rgba(99, 102, 241, 0.5)'); // Indigo
    gradientSales.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

    // Gradient for Expenses
    const gradientExp = ctxMain.createLinearGradient(0, 0, 0, 400);
    gradientExp.addColorStop(0, 'rgba(239, 68, 68, 0.5)');   // Red
    gradientExp.addColorStop(1, 'rgba(239, 68, 68, 0.0)');

    new Chart(ctxMain, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'Sales',
                    data: salesData,
                    backgroundColor: '#6366f1',
                    borderRadius: 4,
                    barPercentage: 0.6
                },
                {
                    label: 'Expenses',
                    data: expenseData,
                    backgroundColor: '#ef4444',
                    borderRadius: 4,
                    barPercentage: 0.6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', align: 'end' },
                tooltip: { backgroundColor: 'rgba(30, 41, 59, 0.9)', padding: 12, cornerRadius: 8 }
            },
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [4, 4], color: '#e2e8f0' }, border: { display: false } },
                x: { grid: { display: false }, border: { display: false } }
            }
        }
    });

    // --- 2. PRODUCT CHART ---
    const ctxProduct = document.getElementById('productChart').getContext('2d');
    new Chart(ctxProduct, {
        type: 'doughnut',
        data: {
            labels: prodNames.length ? prodNames : ['No Data'],
            datasets: [{
                data: prodQty.length ? prodQty : [1],
                backgroundColor: ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#3b82f6'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
            },
            cutout: '70%'
        }
    });
</script>

<style>
    /* Minimal Glass Styles for Dash */
    .glass-stat-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .glass-stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.08) !important;
    }
    .icon-box {
        width: 50px; height: 50px;
        display: flex; align-items: center; justify-content: center;
    }
    .decor-circle {
        position: absolute;
        width: 120px; height: 120px;
        border-radius: 50%;
        bottom: -60px; right: -60px;
        opacity: 0.05;
    }
    .dashboard-header h2 { font-weight: 800; letter-spacing: -0.5px; color: #1e293b; }
    .date-pill {
        background: #fff; padding: 8px 20px; border-radius: 50px;
        font-weight: 600; color: #64748b;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }
    .glass-card { background: #fff; border-radius: 16px; }
</style>
{% endblock %}
