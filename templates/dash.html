{% extends "admin_master.html" %}

{% block page_content %}
<!-- Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
    :root {
        --grad-purple: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        --grad-blue: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
        --grad-green: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);
        --grad-orange: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
        --grad-red: linear-gradient(135deg, #ef4444 0%, #f43f5e 100%);
        --glass: rgba(255, 255, 255, 0.95);
    }

    body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }

    /* --- KPI CARDS --- */
    .kpi-card {
        border: none;
        border-radius: 20px;
        position: relative;
        overflow: hidden;
        color: white;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
    
    .card-bg-purple { background: var(--grad-purple); }
    .card-bg-blue { background: var(--grad-blue); }
    .card-bg-green { background: var(--grad-green); }
    .card-bg-orange { background: var(--grad-orange); }
    .card-bg-red { background: var(--grad-red); }

    .icon-box {
        position: absolute; top: 15px; right: 15px;
        width: 45px; height: 45px;
        background: rgba(255,255,255,0.2);
        border-radius: 12px; display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem;
    }

    .chart-container {
        background: var(--glass);
        border-radius: 24px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        height: 400px;
        border: 1px solid rgba(255,255,255,0.5);
    }
</style>

<div class="container-fluid py-4 px-4">
    
    <!-- 1. Header -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div class="d-flex align-items-center">
             <!-- Back Button -->
             <a href="{{ url_for('index') }}" class="btn btn-white shadow-sm rounded-circle border me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="fa-solid fa-arrow-left text-dark"></i>
             </a>
            <div>
                <h2 class="fw-bold text-dark mb-0">Dashboard</h2>
                <p class="text-muted mb-0">Overview for {{ today_date.strftime('%d %B, %Y') }}</p>
            </div>
        </div>
        <div class="d-flex align-items-center gap-3">
             <div class="bg-white px-3 py-2 rounded-pill shadow-sm border d-flex align-items-center">
                <i class="fa-regular fa-calendar me-2 text-primary"></i>
                <span class="fw-bold text-dark">{{ today_date.strftime('%d-%m-%Y') }}</span>
             </div>
             <button onclick="window.location.reload();" class="btn btn-white shadow-sm rounded-circle border" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="fa-solid fa-arrows-rotate text-secondary"></i>
             </button>
        </div>
    </div>

    <!-- 2. KPI Cards Row -->
    <div class="row g-4 mb-5">
        
        <!-- Today's Sale (Big) / Previous Day (Small) -->
        <div class="col-xl-3 col-md-6">
            <div class="kpi-card card-bg-purple p-4">
                <div class="icon-box"><i class="fa-solid fa-chart-line"></i></div>
                <div>
                    <p class="text-white-50 text-uppercase fw-bold small mb-1">Today's Live Sale</p>
                    <h3 class="fw-bold mb-0">₹ {{ "%.0f"|format(sales_today) }}</h3>
                </div>
                <!-- Previous Day Small -->
                <div class="mt-3 border-top border-white border-opacity-10 pt-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small text-white-50">Yesterday:</span>
                        <span class="fw-bold small text-white">₹ {{ "%.2f"|format(sales_yesterday) }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sales This Month -->
        <div class="col-xl-3 col-md-6">
            <div class="kpi-card card-bg-blue p-4">
                <div class="icon-box"><i class="fa-solid fa-calendar-check"></i></div>
                <div>
                    <p class="text-white-50 text-uppercase fw-bold small mb-1">Sales (This Month)</p>
                    <h3 class="fw-bold mb-0">₹ {{ "%.2f"|format(sales_this_month) }}</h3>
                </div>
                <div class="mt-3 border-top border-white border-opacity-10 pt-2">
                    <span class="small text-white-50">Target Achievement</span>
                </div>
            </div>
        </div>

        <!-- Yearly Revenue -->
        <div class="col-xl-3 col-md-6">
            <div class="kpi-card card-bg-green p-4">
                <div class="icon-box"><i class="fa-solid fa-sack-dollar"></i></div>
                <div>
                    <p class="text-white-50 text-uppercase fw-bold small mb-1">Total Revenue (Year)</p>
                    <h3 class="fw-bold mb-0">₹ {{ "%.2f"|format(yearly_sales) }}</h3>
                </div>
                <div class="mt-3 border-top border-white border-opacity-10 pt-2">
                     <span class="small text-white-50">Fiscal Year {{ current_year }}</span>
                </div>
            </div>
        </div>

        <!-- Yearly Expenses -->
        <div class="col-xl-3 col-md-6">
            <div class="kpi-card card-bg-red p-4">
                <div class="icon-box"><i class="fa-solid fa-wallet"></i></div>
                <div>
                    <p class="text-white-50 text-uppercase fw-bold small mb-1">Expenses (Year)</p>
                    <h3 class="fw-bold mb-0">₹ {{ "%.2f"|format(yearly_expenses) }}</h3>
                </div>
                 <div class="mt-3 border-top border-white border-opacity-10 pt-2">
                    <span class="small text-white-50">Operational Costs</span>
                </div>
            </div>
        </div>

        <!-- Supplier Dues (New Separate Card) -->
        <div class="col-xl-3 col-md-6">
            <div class="kpi-card card-bg-orange p-4">
                <div class="icon-box"><i class="fa-solid fa-file-invoice-dollar"></i></div>
                <div>
                    <p class="text-white-50 text-uppercase fw-bold small mb-1">Supplier Dues</p>
                    <h3 class="fw-bold mb-0">₹ {{ "%.0f"|format(supplier_dues) }}</h3>
                </div>
                 <div class="mt-3 border-top border-white border-opacity-10 pt-2">
                    <span class="small text-white-50">Outstanding Payments</span>
                </div>
            </div>
        </div>

    </div>

    <!-- 3. Charts & Alerts -->
    <div class="row g-4">
        
        <!-- Main Chart -->
        <div class="col-lg-8">
            <div class="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold text-dark mb-0">Revenue vs Expenses</h5>
                    <span class="badge bg-light text-secondary border px-3 py-2">Yearly Overview</span>
                </div>
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <!-- Side Panel (Products) -->
        <div class="col-lg-4">
            
            <!-- Removed Low Stock Card as requested -->

            <!-- Top Products Chart -->
            <div class="chart-container" style="height: 400px;">
                <h6 class="fw-bold text-dark mb-3">Top 5 Products</h6>
                <div style="height: 300px; position: relative;">
                    <canvas id="productChart"></canvas>
                </div>
            </div>

        </div>
    </div>

</div>

<!-- Chart Config -->
<script>
    // --- 1. SALES CHART (Line) ---
    const ctxSales = document.getElementById('salesChart').getContext('2d');
    
    // Gradients
    let gradientSales = ctxSales.createLinearGradient(0, 0, 0, 400);
    gradientSales.addColorStop(0, 'rgba(99, 102, 241, 0.5)');
    gradientSales.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

    let gradientExp = ctxSales.createLinearGradient(0, 0, 0, 400);
    gradientExp.addColorStop(0, 'rgba(239, 68, 68, 0.5)');
    gradientExp.addColorStop(1, 'rgba(239, 68, 68, 0.0)');

    new Chart(ctxSales, {
        type: 'line',
        data: {
            labels: {{ chart_months | tojson }},
            datasets: [
                {
                    label: 'Revenue',
                    data: {{ chart_sales | tojson }},
                    borderColor: '#6366f1',
                    backgroundColor: gradientSales,
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'Expenses',
                    data: {{ chart_expenses | tojson }},
                    borderColor: '#ef4444',
                    backgroundColor: gradientExp,
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8 } },
                tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(15, 23, 42, 0.9)', padding: 12 }
            },
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [5, 5], color: '#e2e8f0' }, border: { display: false } },
                x: { grid: { display: false }, border: { display: false } }
            }
        }
    });

    // --- 2. PRODUCT CHART (Doughnut with Percentages) ---
    const ctxProd = document.getElementById('productChart').getContext('2d');
    new Chart(ctxProd, {
        type: 'doughnut',
        data: {
            labels: {{ top_prod_names | tojson }},
            datasets: [{
                data: {{ top_prod_qty | tojson }},
                backgroundColor: ['#4f46e5', '#0ea5e9', '#10b981', '#f59e0b', '#ef4444'],
                borderWidth: 0,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8, padding: 15 } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = Math.round((value / total) * 100) + '%';
                            return label + ': ' + value + ' (' + percentage + ')';
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}

