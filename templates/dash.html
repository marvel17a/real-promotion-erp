{% extends "admin_master.html" %}

{% block page_content %}
<!-- Link to Separate Dashboard CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/dash.css') }}">

<div class="container-fluid dashboard-container" data-aos="fade-in">
    
    <!-- HEADER SECTION -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h2 class="fw-bold mb-1" style="font-family: 'Outfit', sans-serif;">Dashboard</h2>
            <div class="header-welcome">
                <i class="fa-solid fa-calendar-day text-primary"></i>
                <span class="fw-bold text-muted">{{ date.today().strftime('%B %d, %Y') }}</span>
            </div>
        </div>
        <div>
            <button class="btn btn-dark rounded-pill px-4 shadow-sm" onclick="location.reload()">
                <i class="fa-solid fa-rotate-right me-2"></i> Refresh Data
            </button>
        </div>
    </div>

    <!-- ROW 1: SALES PERFORMANCE (New & Restored Elements) -->
    <div class="row g-4 mb-4">
        
        <!-- 1. TODAY'S SALES -->
        <div class="col-xl-3 col-md-6">
            <div class="glass-stat-card theme-blue">
                <div class="d-flex justify-content-between align-items-start position-relative z-2">
                    <div>
                        <div class="stat-icon">
                            <i class="fa-solid fa-cash-register"></i>
                        </div>
                        <div class="stat-label">Sales Today</div>
                        <div class="stat-value">₹{{ "{:,.0f}".format(sales_today | default(0)) }}</div>
                    </div>
                </div>
                <!-- Decoration -->
                <i class="fa-solid fa-coins bg-decoration-icon"></i>
            </div>
        </div>

        <!-- 2. MONTHLY SALES -->
        <div class="col-xl-3 col-md-6">
            <div class="glass-stat-card theme-purple">
                <div class="d-flex justify-content-between align-items-start position-relative z-2">
                    <div>
                        <div class="stat-icon">
                            <i class="fa-solid fa-calendar-check"></i>
                        </div>
                        <div class="stat-label">This Month</div>
                        <div class="stat-value">₹{{ "{:,.0f}".format(sales_this_month | default(0)) }}</div>
                    </div>
                </div>
                <i class="fa-solid fa-chart-area bg-decoration-icon"></i>
            </div>
        </div>

        <!-- 3. SUPPLIER DUES -->
        <div class="col-xl-3 col-md-6">
            <div class="glass-stat-card theme-orange">
                <div class="d-flex justify-content-between align-items-start position-relative z-2">
                    <div>
                        <div class="stat-icon">
                            <i class="fa-solid fa-file-invoice-dollar"></i>
                        </div>
                        <div class="stat-label">Supplier Dues</div>
                        <div class="stat-value">₹{{ "{:,.0f}".format(supplier_dues | default(0)) }}</div>
                    </div>
                </div>
                <i class="fa-solid fa-hand-holding-dollar bg-decoration-icon"></i>
            </div>
        </div>

        <!-- 4. LOW STOCK -->
        <div class="col-xl-3 col-md-6">
            <div class="glass-stat-card theme-red">
                <div class="d-flex justify-content-between align-items-start position-relative z-2">
                    <div>
                        <div class="stat-icon">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                        </div>
                        <div class="stat-label">Low Stock</div>
                        <div class="stat-value">{{ low_stock | default(0) }} <span style="font-size: 1rem; color: #aaa;">Items</span></div>
                    </div>
                </div>
                <i class="fa-solid fa-boxes-stacked bg-decoration-icon"></i>
            </div>
        </div>
    </div>

    <!-- ROW 2: SECONDARY STATS (Lifetime) -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="glass-stat-card py-3 px-4 d-flex align-items-center justify-content-between" style="min-height: auto;">
                <div>
                    <span class="text-muted small fw-bold d-block">LIFETIME SALES</span>
                    <span class="fs-4 fw-bold text-dark">₹{{ "{:,.0f}".format(total_sales | default(0)) }}</span>
                </div>
                <i class="fa-solid fa-chart-line text-success fs-3 opacity-50"></i>
            </div>
        </div>
        <div class="col-md-4">
            <div class="glass-stat-card py-3 px-4 d-flex align-items-center justify-content-between" style="min-height: auto;">
                <div>
                    <span class="text-muted small fw-bold d-block">TOTAL EXPENSES</span>
                    <span class="fs-4 fw-bold text-dark">₹{{ "{:,.0f}".format(total_expenses | default(0)) }}</span>
                </div>
                <i class="fa-solid fa-wallet text-danger fs-3 opacity-50"></i>
            </div>
        </div>
        <div class="col-md-4">
            <div class="glass-stat-card py-3 px-4 d-flex align-items-center justify-content-between" style="min-height: auto;">
                <div>
                    <span class="text-muted small fw-bold d-block">NET PROFIT (Est.)</span>
                    <span class="fs-4 fw-bold text-primary">₹{{ "{:,.0f}".format((total_sales|default(0) - total_purchases|default(0) - total_expenses|default(0))) }}</span>
                </div>
                <i class="fa-solid fa-piggy-bank text-primary fs-3 opacity-50"></i>
            </div>
        </div>
    </div>

    <!-- ROW 3: CHARTS -->
    <div class="row g-4 mb-4">
        <!-- Main Comparison Chart -->
        <div class="col-lg-8">
            <div class="glass-chart-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold m-0"><i class="fa-solid fa-chart-column me-2 text-primary"></i>Revenue vs Expenses</h5>
                </div>
                <div style="height: 320px;">
                    <canvas id="financeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Top Products -->
        <div class="col-lg-4">
            <div class="glass-chart-card">
                <h5 class="fw-bold mb-4"><i class="fa-solid fa-crown me-2 text-warning"></i>Top Movers</h5>
                <div style="height: 250px; position: relative;">
                    <canvas id="productChart"></canvas>
                </div>
                <div class="mt-4 text-center">
                    <small class="text-muted fst-italic">Based on quantity sold</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DATA INJECTION FOR JS (Safe defaults) -->
<script id="chart-months" type="application/json">{{ chart_months | tojson | default('[]') }}</script>
<script id="chart-sales" type="application/json">{{ chart_sales | tojson | default('[]') }}</script>
<script id="chart-expenses" type="application/json">{{ chart_expenses | tojson | default('[]') }}</script>
<script id="prod-names" type="application/json">{{ top_prod_names | tojson | default('[]') }}</script>
<script id="prod-qty" type="application/json">{{ top_prod_qty | tojson | default('[]') }}</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // 1. FINANCE CHART
    const ctxFinance = document.getElementById('financeChart').getContext('2d');
    let months = [], salesData = [], expenseData = [], prodNames = [], prodQty = [];
    
    try {
        months = JSON.parse(document.getElementById('chart-months').textContent);
        salesData = JSON.parse(document.getElementById('chart-sales').textContent);
        expenseData = JSON.parse(document.getElementById('chart-expenses').textContent);
        prodNames = JSON.parse(document.getElementById('prod-names').textContent);
        prodQty = JSON.parse(document.getElementById('prod-qty').textContent);
    } catch(e) { console.log("Chart data parsing error"); }

    // Gradient for bars
    let gradientSales = ctxFinance.createLinearGradient(0, 0, 0, 400);
    gradientSales.addColorStop(0, '#3498db');
    gradientSales.addColorStop(1, '#2980b9');

    let gradientExp = ctxFinance.createLinearGradient(0, 0, 0, 400);
    gradientExp.addColorStop(0, '#e74c3c');
    gradientExp.addColorStop(1, '#c0392b');

    new Chart(ctxFinance, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'Sales',
                    data: salesData,
                    backgroundColor: gradientSales,
                    borderRadius: 8,
                    barPercentage: 0.6,
                },
                {
                    label: 'Expenses',
                    data: expenseData,
                    backgroundColor: gradientExp,
                    borderRadius: 8,
                    barPercentage: 0.6,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', align: 'end' },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    padding: 12,
                    cornerRadius: 10,
                }
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    grid: { color: 'rgba(0,0,0,0.05)', borderDash: [5, 5] },
                    border: { display: false }
                },
                x: { 
                    grid: { display: false },
                    border: { display: false }
                }
            }
        }
    });

    // 2. PRODUCT CHART
    const ctxProduct = document.getElementById('productChart').getContext('2d');

    new Chart(ctxProduct, {
        type: 'doughnut',
        data: {
            labels: prodNames.length ? prodNames : ['No Data'],
            datasets: [{
                data: prodQty.length ? prodQty : [1],
                backgroundColor: [
                    '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'
                ],
                borderWidth: 0,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
            },
            cutout: '75%',
            layout: { padding: 10 }
        }
    });
});
</script>
{% endblock %}


