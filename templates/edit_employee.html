{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/employee_card_theme.css') }}">
<!-- This JS file handles validation -->
<script src="{{ url_for('static', filename='js/employee_edit.js') }}"></script>

<div class="container-fluid py-4">
  <div class="page-header">
    <h2>Edit Employee</h2>
    <a href="{{ url_for('employees') }}" class="btn btn-secondary">
      <i class="bi bi-x-lg"></i> Cancel
    </a>
  </div>

  <form method="POST" enctype="multipart/form-data" id="employeeForm">
    <!-- Hidden ID for JS validation -->
    <input type="hidden" id="employeeId" value="{{ employee.id }}">

    <div class="row g-4">
      <!-- Column 1: Core Info & Contact -->
      <div class="col-lg-8">
        <div class="card content-card">
          <div class="card-header">
            <h5><i class="bi bi-person-lines-fill me-2"></i>Employee Details</h5>
          </div>
          <div class="card-body p-4">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="name" class="form-label">Name <span>*</span></label>
                <input type="text" class="form-control" id="name" name="name" value="{{ employee.name }}" data-unique="name" required>
                <div class="form-error" data-error-for="name"></div>
              </div>
              <div class="col-md-6">
                <label for="position" class="form-label">Position <span>*</span></label>
                <input type="text" class="form-control" id="position" name="position" value="{{ employee.position }}" required>
                <div class="form-error" data-error-for="position"></div>
              </div>
              <div class="col-md-6">
                <label for="email" class="form-label">Email <span>*</span></label>
                <input type="email" class="form-control" id="email" name="email" value="{{ employee.email }}" data-unique="email" required>
                <div class="form-error" data-error-for="email"></div>
              </div>
              <div class="col-md-6">
                <label for="phone" class="form-label">Phone <span>*</span></label>
                <input type="tel" class="form-control" id="phone" name="phone" pattern="[0-9]{10}" value="{{ employee.phone }}" data-unique="phone" required>
                <div class="form-error" data-error-for="phone"></div>
              </div>
              <div class="col-md-6">
                <label for="city" class="form-label">City <span>*</span></label>
                <input type="text" class="form-control" id="city" name="city" value="{{ employee.city }}" required>
                <div class="form-error" data-error-for="city"></div>
              </div>
              <div class="col-md-6">
                <label for="status" class="form-label">Status <span>*</span></label>
                <select id="status" name="status" class="form-select" required>
                  <option value="active" {{ 'selected' if employee.status=='active' }}>Active</option>
                  <option value="inactive" {{ 'selected' if employee.status=='inactive' }}>Inactive</option>
                </select>
                <div class="form-error" data-error-for="status"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Column 2: Uploads -->
      <div class="col-lg-4">
        <!-- Profile Photo -->
        <div class="card content-card mb-4">
          <div class="card-header">
            <h5><i class="bi bi-image me-2"></i>Profile Photo</h5>
          </div>
          <div class="card-body p-4 text-center">
            <div class="preview-box mb-3">
              {% if employee.image %}
                <img id="imagePreview" class="preview-img-circle" src="{{ cloudinary_url(employee.image, height=150, width=150, crop='fill', gravity='face') }}" alt="{{ employee.name }}">
                <span id="imagePlaceholder" class="preview-placeholder" style="display:none;">Image preview</span>
              {% else %}
                <img id="imagePreview" class="preview-img-circle" alt="Image preview" style="display:none;">
                <span id="imagePlaceholder" class="preview-placeholder">No photo on file</span>
              {% endif %}
            </div>
            <label for="imageInput" class="form-label">Change Photo (Max 2MB)</label>
            <input type="file" class="form-control" name="image" accept="image/png, image/jpeg" id="imageInput">
            <div class="form-error" data-error-for="image"></div>
          </div>
        </div>
        
        <!-- Document -->
        <div class="card content-card">
          <div class="card-header">
            <h5><i class="bi bi-file-earmark-pdf-fill me-2"></i>Document</h5>
          </div>
          <div class="card-body p-4">
            <label class="form-label">Current Document</label>
            <div class="mb-3">
              {% if employee.document %}
                <a href="{{ cloudinary_url(employee.document)[0] }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                  <i class="bi bi-file-earmark-pdf"></i> View Current
                </a>
              {% else %}
                <p class="text-muted small">No document on file.</p>
              {% endif %}
            </div>
            <label for="docInput" class="form-label">Replace Document (Max 5MB)</label>
            <input type="file" class="form-control" name="document" accept="application/pdf" id="docInput">
            <div class="form-error" data-error-for="document"></div>
            <p class="file-note text-muted small mt-2" id="docName">No file chosen</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Sticky Footer Actions -->
    <div class="form-actions mt-4">
      <a href="{{ url_for('employees') }}" class="btn btn-secondary">Cancel</a>
      <button type="submit" class="btn btn-primary px-4">
        <i class="bi bi-check-circle-fill me-2"></i> Update Employee
      </button>
    </div>
  </form>
</div>

<!-- Custom JS to make image preview work -->
<script>
  document.getElementById('imageInput').addEventListener('change', function(e) {
    const preview = document.getElementById('imagePreview');
    const placeholder = document.getElementById('imagePlaceholder');
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(event) {
        preview.src = event.target.result;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
      }
      reader.readAsDataURL(file);
    }
  });
</script>
{% endblock %}
