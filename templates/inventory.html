{% extends "base.html" %}
{% block content %}
<!-- 
  NOTE: Make sure your base.html links to:
  1. Bootstrap 5.3 CSS & JS
  2. Bootstrap Icons
  3. The new 'inventory_vivid_theme.css'
<!-- REMOVE THIS LINE from base.html -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/inventory.css') }}">
<script src="{{ url_for('static', filename='js/inventory_add_edit.js') }}"></script>

<div class="container-fluid py-4">

  <!-- 1. PAGE HEADER -->
  <div class="page-header-vivid">
    <h2><i class="bi bi-box-seam me-3"></i>Inventory Management</h2>
    <a href="{{ url_for('add_product_form') }}" class="btn btn-primary">
      <i class="bi bi-plus-lg me-1"></i> Add New Product
    </a>
  </div>

  <!-- 2. QUICK STATS (NEW FEATURE) -->
  <div class="row g-4 mb-4">
    <div class="col-lg-4 col-md-6">
      <div class="card stat-card-vivid">
        <div class="card-body">
          <h6 class="card-title">Total Stock Value</h6>
          <p class="card-text small">₹{{ "%.0f"|format(stats.total_value) }}</p>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-md-6">
      <div class="card stat-card-vivid">
        <div class="card-body">
          <h6 class="card-title">Total Products</h6>
          <p class="card-text">{{ stats.total_products }}</p>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-md-12">
      <div class="card stat-card-vivid">
        <div class="card-body">
          <h6 class="card-title text-danger">Low Stock Items</h6>
          <p class="card-text">{{ stats.low_stock_count }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 3. FILTER CARD (NEW FEATURE) -->
  <div class="card filter-card-vivid mb-4">
    <div class="card-body p-4">
      <div class="row g-3 align-items-end">
        <div class="col-lg-8 col-md-12">
          <label for="searchProduct" class="form-label">Search by Product Name</label>
          <input type="text" class="form-control" id="searchProduct" placeholder="Start typing a name...">
        </div>
        <div class="col-lg-4 col-md-12">
          <label for="filterCategory" class="form-label">Filter by Category</label>
          <select id="filterCategory" class="form-select">
            <option value="all">All Categories</option>
            {% for cat in filters.categories %}
            <option value="{{ cat.category }}">{{ cat.category }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- 4. PRODUCT CARD GRID (NEW LAYOUT) -->
  
  <div class="row g-4" id="product-grid">
    {% for product in products %}
    <div class="col-xl-3 col-lg-4 col-md-6 product-card-filter"
         data-name="{{ product.name.lower() }}"
         data-category="{{ product.category }}">
      
      <div class="product-card-vivid">
        
        <!-- Card Image -->
        <div class="card-image-wrapper">
          <!-- LOW STOCK BADGE (NEW FEATURE) -->
          {% if product.stock <= 10 %}
            <span class="badge text-bg-danger rounded-pill low-stock-badge">
              <i class="bi bi-exclamation-triangle-fill"></i> Low Stock
            </span>
          {% endif %}

          <!-- 
            THIS IS THE FIX USING YOUR REQUESTED CODE.
            It uses your `if/else` and "No Image" text,
            but with the *correct* `cloudinary_url()` function.
          -->
          {% if product.image %}
            <img class="card-product-image"
     src="{{ product.image | fix_image }}"
     alt="{{ product.name }}"
     style="object-fit: cover;">

          {% else %}
            <div class="card-product-image placeholder">
              <i class="bi bi-camera"></i>
              <span>No Image</span>
            </div>
          {% endif %}
        </div>
        
        <!-- Card Body -->
        <div class="product-card-body">
          <p class="card-category">{{ product.category or 'Uncategorized' }}</p>
          <h5 class="card-title-vivid">{{ product.name }}</h5>
          
          <div class="card-stock-price">
            <div class="stock-info">
              <span class="stock-label">In Stock</span>
              <p class="stock-value">{{ product.stock }}</p>
            </div>
            <div class="price-info text-end">
              <span class="price-label">Sell Price</span>
              <p class="price-value">₹{{ "%.0f"|format(product.price) }}</p>
            </div>
          </div>
        </div>
        
        <!-- Card Footer Actions -->
        <div class="card-footer-actions">
          <form action="{{ url_for('delete_product', id=product.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this product?')" class="d-inline">
            <button type="submit" class="btn btn-sm btn-outline-danger">
              <i class="bi bi-trash"></i>
            </button>
          </form>
          <a href="{{ url_for('edit_product', id=product.id) }}" class="btn btn-sm btn-primary">
            <i class="bi bi-pencil me-1"></i> Edit Product
          </a>
        </div>
      </div>
    </div>
    {% else %}
      <div class="col-12">
        <p class="text-center text-muted p-5 fs-5">No products found. Add one to get started!</p>
      </div>
    {% endfor %}
  </div>

  <!-- No Results Message for Filtering -->
  <div id="noResultsMessage" class="text-center p-5" style="display: none;">
    <h5 class="text-muted">No products match your search criteria.</h5>
  </div>

</div>
{% endblock %}



