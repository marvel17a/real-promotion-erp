{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/evening.css') }}">

<div class="glass-container fade-in-up mb-5">

    <div class="page-header">
        <h1 class="company-title fw-800 text-gradient">REAL PROMOTION</h1>
        <p class="company-subtitle text-uppercase">Since 2005</p>
        <div class="address-pill">
            <i class="fa-solid fa-map-pin text-danger me-2"></i>
            Real Promotion, G/12, Tulsimangalam Complex, Nadiad-387001
        </div>
    </div>

    <div class="glass-panel p-4 mb-4">
        
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
            <h4 class="fw-bold text-secondary mb-0">
                <i class="fa-solid fa-moon text-primary me-2"></i>Evening Settlement
            </h4>
            <div class="text-end">
                <div class="live-clock" id="liveClock">00:00:00</div>
                <div class="date-display text-muted small">{{ today }}</div>
            </div>
        </div>

        <form method="POST" action="{{ url_for('evening') }}" id="eveningForm">
            <input type="hidden" name="form_status" id="formStatus" value="final">
            <input type="hidden" name="timestamp" id="timestampInput">

            <div class="row g-3 align-items-end mb-4">
                <div class="col-md-4">
                    <label class="form-label fw-bold text-uppercase small">Select Employee</label>
                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-user text-muted"></i></span>
                        <select class="form-select border-start-0 ps-0" name="employee_id" id="employee" required>
                            <option value="" selected disabled>-- Choose Employee --</option>
                            {% for emp in employees %}
                            <option value="{{ emp.id }}" data-img="{{ emp.profile_image }}">{{ emp.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-bold text-uppercase small">Date</label>
                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-calendar text-muted"></i></span>
                        <input type="text" class="form-select border-start-0 ps-0" name="date" id="date" value="{{ today }}" required>
                    </div>
                </div>

                <div class="col-md-2">
                    <div class="profile-preview-box text-center">
                        <img id="empPhoto" src="{{ url_for('static', filename='img/default-user.png') }}" class="rounded-circle shadow-sm" style="width: 50px; height: 50px; object-fit: cover;">
                    </div>
                </div>
            </div>

            <div id="fetchMsg" class="alert alert-info shadow-sm d-none mb-4">
                <i class="fa-solid fa-circle-info me-2"></i><span>Loading...</span>
            </div>

            <div id="submittedBlock" class="alert alert-warning shadow-sm d-none text-center mb-4">
                <h5 class="alert-heading fw-bold"><i class="fa-solid fa-lock me-2"></i>Settlement Already Submitted</h5>
                <p class="mb-0">This settlement is finalized. You can view it in history.</p>
            </div>

            <div class="table-responsive rounded-4 shadow-sm mb-4">
                <table class="table table-hover align-middle mb-0" id="settleTable">
                    <thead class="bg-light text-secondary small text-uppercase">
                        <tr>
                            <th class="ps-4" style="width: 50px;">#</th>
                            <th style="width: 60px;">Img</th>
                            <th>Product Name</th>
                            <th class="text-center" style="width: 100px;">Price</th>
                            <th class="text-center" style="width: 100px;">Total Qty</th>
                            <th class="text-center bg-success bg-opacity-10" style="width: 120px;">Sold</th>
                            <th class="text-center bg-danger bg-opacity-10" style="width: 120px;">Return</th>
                            <th class="text-end pe-4" style="width: 150px;">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="rowsArea" class="bg-white">
                        <tr><td colspan="8" class="text-center py-5 text-muted">Select an employee to load data.</td></tr>
                    </tbody>
                    <tfoot class="bg-light fw-bold">
                        <tr>
                            <td colspan="4" class="text-end text-uppercase text-muted small pe-3">Totals:</td>
                            <td class="text-center" id="totTotal">0</td>
                            <td class="text-center text-success" id="totSold">0</td>
                            <td class="text-center text-danger" id="totReturn">0</td>
                            <td class="text-end pe-4 text-primary" id="totAmount">₹ 0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body p-4">
                            <h6 class="fw-bold text-uppercase text-muted mb-3">Notes & Remarks</h6>
                            <textarea name="note" class="form-control bg-light border-0 mb-2" rows="2" placeholder="General transaction note..."></textarea>
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="text" name="emp_debit_note" class="form-control form-control-sm bg-light border-0" placeholder="Debit Note (e.g. Advance)">
                                </div>
                                <div class="col-6">
                                    <input type="text" name="emp_credit_note" class="form-control form-control-sm bg-light border-0" placeholder="Credit Note">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm bg-dark text-white h-100">
                        <div class="card-body p-4">
                            <h6 class="fw-bold text-uppercase text-warning mb-3">
                                <i class="fa-solid fa-calculator me-2"></i>Payment Settlement
                            </h6>

                            <input type="hidden" name="total_amount" id="totalAmount" value="0">
                            <input type="hidden" name="allocation_id" id="allocation_id">
                            <input type="hidden" name="h_employee" id="h_employee">
                            <input type="hidden" name="h_date" id="h_date">
                            
                            <input type="hidden" name="draft_id" id="draft_id">

                            <div class="row g-2 align-items-center mb-2">
                                <div class="col-5 text-end"><label class="small text-white-50">Discount:</label></div>
                                <div class="col-7">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-secondary border-0 text-white">₹</span>
                                        <input type="number" step="0.01" name="discount" id="discount" class="form-control bg-secondary border-0 text-white text-end" placeholder="0.00">
                                    </div>
                                </div>
                            </div>

                            <div class="row g-2 align-items-center mb-2">
                                <div class="col-5 text-end"><label class="small text-white-50">Cash Received:</label></div>
                                <div class="col-7">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-secondary border-0 text-white">₹</span>
                                        <input type="number" step="0.01" name="cash" id="cash" class="form-control bg-secondary border-0 text-white text-end" placeholder="0.00">
                                    </div>
                                </div>
                            </div>

                            <div class="row g-2 align-items-center mb-3">
                                <div class="col-5 text-end"><label class="small text-white-50">Online / Bank:</label></div>
                                <div class="col-7">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-secondary border-0 text-white">₹</span>
                                        <input type="number" step="0.01" name="online" id="online" class="form-control bg-secondary border-0 text-white text-end" placeholder="0.00">
                                    </div>
                                </div>
                            </div>

                            <div class="border-top border-secondary my-3"></div>

                            <div class="row g-2 align-items-center">
                                <div class="col-5 text-end"><label class="fw-bold text-white">STATUS:</label></div>
                                <div class="col-7">
                                    <input type="text" id="dueAmount" class="form-control fw-bold text-center border-0" readonly value="0.00">
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-3 mt-4 pt-3 border-top">
                <button type="button" onclick="saveDraft()" class="btn btn-glass-secondary px-4">
                    <i class="fa-regular fa-floppy-disk me-2"></i>Save Draft
                </button>
                <button type="button" onclick="submitFinal()" class="btn btn-glass px-5">
                    <i class="fa-solid fa-check-circle me-2"></i>Submit Settlement
                </button>
            </div>

        </form>
    </div>
</div>

<script src="{{ url_for('static', filename='js/evening.js') }}"></script>
<script>
    // Helper function for submit
    function submitForm(status) {
        document.getElementById('formStatus').value = status;
        const form = document.getElementById('eveningForm');
        const emp = document.getElementById('employee').value;

        if(!emp) { alert("Please select an employee first."); return; }

        if(status === 'final') {
            if(!confirm("Are you sure you want to SUBMIT this settlement? Inventory will be deducted.")) return;
        } 
        form.submit();
    }

    document.addEventListener("DOMContentLoaded", function() {
        flatpickr("#date", { dateFormat: "d-m-Y", defaultDate: "{{ today }}", allowInput: true });
        
        const empSelect = document.getElementById('employee');
        const empPhoto = document.getElementById('empPhoto');
        if(empSelect) {
            empSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const img = selectedOption.getAttribute('data-img');
                if(img && img !== 'None' && img !== "") empPhoto.src = img;
                else empPhoto.src = "{{ url_for('static', filename='img/default-user.png') }}";
            });
        }
    });
</script>
{% endblock %}
