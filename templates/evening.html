{% extends "base.html" %}

{% block content %}

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<div class="glass-container fade-in-up mb-5">

    <!-- Header -->
    <div class="glass-header text-center mb-4 p-4">
        <h1 class="company-name text-gradient fw-bold mb-1">REAL PROMOTION</h1>
        <p class="since-text text-secondary mb-3 small letter-spacing-2">SINCE 2005</p>
        <div class="address-block text-muted small mx-auto bg-white bg-opacity-50 p-2 rounded-3" style="max-width: 600px;">
            <i class="fa-solid fa-location-dot text-primary me-1"></i>
            Real Promotion, G/12, Tulsimangalam Complex, B/h. Trimurti Complex, Ghodiya Bazar, Nadiad-387001, Gujarat, India
        </div>
    </div>

    <!-- Filter -->
    <div class="glass-panel p-4 mb-4">
        <div class="row g-3 align-items-end">
            <div class="col-md-5">
                <label class="form-label text-uppercase small fw-bold text-secondary">Sales Representative</label>
                <div class="input-group input-group-glass">
                    <span class="input-group-text"><i class="fa-solid fa-user-tie"></i></span>
                    <select class="form-select" id="employee_id">
                        <option value="">-- Select Staff --</option>
                        {% for emp in employees %}
                        <option value="{{ emp.id }}">{{ emp.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="col-md-4">
                <label class="form-label text-uppercase small fw-bold text-secondary">Settlement Date</label>
                <div class="input-group input-group-glass">
                    <span class="input-group-text"><i class="fa-solid fa-calendar-day"></i></span>
                    <input type="text" class="form-control" id="date" value="{{ today }}">
                </div>
            </div>

            <div class="col-md-3">
                <button type="button" id="btnFetch" class="btn btn-gradient-primary w-100 py-2 shadow-sm">
                    <i class="fa-solid fa-sync-alt me-2"></i> Load Allocation
                </button>
            </div>
        </div>
        <div id="fetchMsg" class="mt-2 text-center fw-bold small"></div>
    </div>

    <form id="eveningForm" action="{{ url_for('evening') }}" method="POST">
        <input type="hidden" name="allocation_id" id="allocation_id">
        <input type="hidden" name="h_employee" id="h_employee">
        <input type="hidden" name="h_date" id="h_date">

        <!-- Table -->
        <div class="glass-panel p-0 overflow-hidden mb-4">
            <div class="p-3 border-bottom bg-light bg-opacity-50">
                <h5 class="fw-bold mb-0">
                    <i class="fa-solid fa-boxes-stacked me-2 text-primary"></i>
                    Stock Reconciliation
                </h5>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="productsTable">
                    <thead class="bg-gradient-primary text-white">
                        <tr>
                            <th class="ps-4">Img</th>
                            <th>Product</th>
                            <th class="text-center">Total</th>
                            <th>Sold</th>
                            <th>Return</th>
                            <th class="text-center">Left</th>
                            <th class="text-end pe-4">Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="rowsArea">
                        <tr>
                            <td colspan="7" class="text-center text-muted py-5">
                                Load data to begin...
                            </td>
                        </tr>
                    </tbody>
                    <tfoot class="bg-light fw-bold">
                        <tr>
                            <td colspan="3" class="text-end">Totals:</td>
                            <td id="totSold">0</td>
                            <td>-</td>
                            <td>-</td>
                            <td id="totAmount" class="text-end pe-4">0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Sticky Footer -->
        <nav class="navbar fixed-bottom glass-header border-top py-3">
            <div class="container d-flex justify-content-between">
                <span class="fw-bold">Due: â‚¹ <span id="stickyDue">0.00</span></span>
                <button type="submit" class="btn btn-dark px-5 fw-bold">
                    Submit
                </button>
            </div>
        </nav>
    </form>
</div>

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    flatpickr("#date", {
        dateFormat: "Y-m-d",
        defaultDate: "{{ today }}",
        allowInput: true
    });

    const dueEl = document.getElementById("dueAmount");
    const stickyEl = document.getElementById("stickyDue");

    if (dueEl && stickyEl) {
        const observer = new MutationObserver(() => {
            stickyEl.textContent = dueEl.textContent;
        });
        observer.observe(dueEl, { childList: true, subtree: true });
    }
});
</script>

<script src="{{ url_for('static', filename='js/evening.js') }}"></script>

{% endblock %}
