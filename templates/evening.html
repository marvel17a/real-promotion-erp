{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/morning.css') }}">

<div class="glass-container fade-in-up mb-5">
    <div class="page-header">
        <h1 class="company-title fw-800 text-gradient">EVENING SETTLEMENT</h1>
        <p class="company-subtitle text-uppercase">Daily Sales Closing</p>
    </div>

    <div class="glass-panel p-4 mb-4">
        <!-- Filter / Selection -->
        <div class="row g-4 align-items-end mb-4">
            <div class="col-lg-5">
                <label class="control-label">Sales Representative</label>
                <div class="d-flex align-items-center gap-3">
                    <div class="emp-photo-box">
                        <img id="empPhoto" src="{{ url_for('static', filename='img/default-user.png') }}">
                    </div>
                    <div class="flex-grow-1">
                        <div class="input-group-glass">
                            <span class="input-group-text"><i class="fa-solid fa-user-tie"></i></span>
                            <select id="employee" class="form-select">
                                <option value="">-- Choose Employee --</option>
                                {% for emp in employees %}
                                <option value="{{ emp.id }}" data-img="{{ emp.image }}">{{ emp.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <label class="control-label">Date</label>
                <div class="input-group-glass">
                    <span class="input-group-text"><i class="fa-solid fa-calendar-day"></i></span>
                    <input type="text" id="date" class="form-control" value="{{ today }}">
                </div>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-primary w-100 rounded-pill shadow-sm py-2 fw-bold" onclick="fetchData()">
                    <i class="fa-solid fa-sync me-2"></i> Fetch Data
                </button>
            </div>
        </div>

        <div id="fetchMsg" class="alert alert-info d-none text-center fw-bold"></div>

        <form method="POST" action="{{ url_for('evening') }}" id="eveningForm" style="display:none;">
            <input type="hidden" name="h_employee" id="h_employee">
            <input type="hidden" name="h_date" id="h_date">
            
            <!-- Product Table -->
            <div class="table-responsive mb-4">
                <table class="table styled-table" id="stockTable">
                    <thead>
                        <tr>
                            <th width="5%">#</th>
                            <th width="10%">Img</th>
                            <th width="30%">Product</th>
                            <th width="10%" class="text-center">Total</th>
                            <th width="10%" class="text-center">Sold</th>
                            <th width="10%" class="text-center">Return</th>
                            <th width="15%" class="text-end">Price</th>
                            <th width="10%" class="text-end">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="rowsArea"></tbody>
                    <tfoot class="table-footer">
                        <tr>
                            <td colspan="3" class="summary-label">Summary</td>
                            <td class="text-center"><span class="total-box bg-total-dark" id="totTotal">0</span></td>
                            <td class="text-center"><span class="total-box bg-total-green" id="totSold">0</span></td>
                            <td class="text-center"><span class="total-box bg-total-red" id="totReturn">0</span></td>
                            <td></td>
                            <td class="text-end"><span class="total-box bg-total-blue fs-5">₹ <span id="totAmount">0.00</span></span></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Finance Section -->
            <div class="row g-4 mb-5 finance-section">
                <!-- Employee Finance -->
                <div class="col-lg-6">
                    <div class="finance-card">
                        <div class="finance-header"><i class="fa-solid fa-wallet me-2 text-warning"></i>Employee Finance</div>
                        <div class="finance-body">
                            <!-- Credit -->
                            <div class="p-3 border rounded-3 mb-3 bg-light">
                                <span class="finance-title-credit">CREDIT (Given to Emp)</span>
                                <div class="mb-2">
                                    <input type="number" step="0.01" name="emp_credit_amount" class="form-control border-success text-success fw-bold text-end" placeholder="0.00">
                                </div>
                                <input type="text" name="emp_credit_note" class="form-control border-success" placeholder="Note (e.g. Salary, Expense)">
                            </div>
                            <!-- Debit -->
                            <div class="p-3 border rounded-3 bg-light">
                                <span class="finance-title-debit">DEBIT (Taken from Emp)</span>
                                <div class="mb-2">
                                    <input type="number" step="0.01" name="emp_debit_amount" class="form-control border-danger text-danger fw-bold text-end" placeholder="0.00">
                                </div>
                                <input type="text" name="emp_debit_note" class="form-control border-danger" placeholder="Note (e.g. Advance, Penalty)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cash Settlement -->
                <div class="col-lg-6">
                    <div class="finance-card">
                        <div class="finance-header"><i class="fa-solid fa-cash-register me-2 text-primary"></i>Cash Settlement</div>
                        <div class="finance-body">
                            <div class="settle-row"><span class="settle-label">Total Sales</span><input type="text" name="totalAmount" id="totalAmount" class="form-control border-0 bg-white fw-900 text-end fs-5" readonly value="0.00"></div>
                            <div class="settle-row"><span class="settle-label text-warning">Discount</span><input type="number" name="discount" id="discount" class="settle-input" value="0"></div>
                            <div class="settle-row"><span class="settle-label text-info">Online</span><input type="number" name="online" id="online" class="settle-input" value="0"></div>
                            <div class="settle-row"><span class="settle-label text-success">Cash</span><input type="number" name="cash" id="cash" class="settle-input fs-5" value="0"></div>
                            <div class="balance-box"><span class="fw-800 fs-5">BALANCE DUE</span><span class="fs-4 fw-800">₹ <span id="dueAmount">0.00</span></span></div>
                            <div class="mt-3"><input type="text" name="due_note" class="form-control fw-bold" placeholder="Due Note..."></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit -->
            <div class="text-center pb-5">
                <button type="submit" class="btn btn-glass btn-save px-5 py-3" onclick="return confirm('Submit FINAL Settlement? This action is irreversible.');">
                    <i class="fa-solid fa-check-double me-2"></i> Submit Final
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    flatpickr("#date", { dateFormat: "d-m-Y", defaultDate: "today", allowInput: true });
    
    // Photo Logic
    const empSelect = document.getElementById('employee');
    const empPhoto = document.getElementById('empPhoto');
    if(empSelect) {
        empSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const img = selectedOption.getAttribute('data-img');
            if(img && img !== 'None') empPhoto.src = img;
            else empPhoto.src = "{{ url_for('static', filename='img/default-user.png') }}";
        });
    }
});

function fetchData() {
    const empId = document.getElementById('employee').value;
    const dateVal = document.getElementById('date').value;
    const msg = document.getElementById('fetchMsg');
    const form = document.getElementById('eveningForm');
    const tbody = document.getElementById('rowsArea');

    if(!empId || !dateVal) { alert("Select Employee & Date"); return; }

    msg.classList.remove('d-none', 'alert-danger', 'alert-success');
    msg.classList.add('alert-info');
    msg.textContent = "Fetching data...";
    form.style.display = 'none';

    fetch('/api/get_evening_stock', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ employee_id: empId, date: dateVal })
    })
    .then(r => r.json())
    .then(data => {
        if(data.status === 'submitted') {
            msg.className = 'alert alert-warning fw-bold text-center';
            msg.innerHTML = `<i class="fa-solid fa-check-circle me-2"></i> ${data.message}`;
            msg.classList.remove('d-none');
            return;
        }
        
        if(data.status === 'success' && data.items.length > 0) {
            msg.classList.add('d-none');
            form.style.display = 'block';
            
            // Set hidden fields
            // Convert dd-mm-yyyy to yyyy-mm-dd for input type date or backend
            const [d, m, y] = dateVal.split('-');
            document.getElementById('h_date').value = `${y}-${m}-${d}`;
            document.getElementById('h_employee').value = empId;

            tbody.innerHTML = '';
            data.items.forEach((item, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center fw-bold text-muted">${idx+1}</td>
                    <td class="text-center"><img src="${item.image}" class="rounded border" width="40" height="40" style="object-fit:cover;"></td>
                    <td class="fw-bold text-dark">
                        ${item.name}
                        <input type="hidden" name="product_id[]" value="${item.product_id}">
                    </td>
                    <td><input type="number" name="total_qty[]" class="table-input total-qty" value="${item.total_qty}" readonly></td>
                    <td><input type="number" name="sold[]" class="table-input input-sold" value="0" min="0" max="${item.total_qty}" oninput="calcRow(this)"></td>
                    <td><input type="number" name="return[]" class="table-input input-return" value="0" readonly></td>
                    <td><input type="number" name="price[]" class="table-input text-end" value="${item.price}" readonly></td>
                    <td class="text-end fw-bold text-primary row-amount">0.00</td>
                `;
                tbody.appendChild(tr);
            });
            calcAll(); // Init totals
        } else {
            msg.className = 'alert alert-danger fw-bold text-center';
            msg.textContent = "No stock found for this employee (Yesterday Left + Today Given).";
            msg.classList.remove('d-none');
        }
    });
}

// Calculation Logic
function calcRow(input) {
    const tr = input.closest('tr');
    const total = parseInt(tr.querySelector('.total-qty').value) || 0;
    let sold = parseInt(input.value) || 0;
    
    if(sold > total) { sold = total; input.value = total; }
    
    const ret = total - sold;
    tr.querySelector('.input-return').value = ret;
    
    const price = parseFloat(tr.querySelector('input[name="price[]"]').value) || 0;
    const amt = sold * price;
    tr.querySelector('.row-amount').textContent = amt.toFixed(2);
    
    calcAll();
}

function calcAll() {
    let tTotal=0, tSold=0, tReturn=0, tAmt=0;
    
    document.querySelectorAll('#rowsArea tr').forEach(tr => {
        tTotal += parseInt(tr.querySelector('.total-qty').value)||0;
        tSold += parseInt(tr.querySelector('.input-sold').value)||0;
        tReturn += parseInt(tr.querySelector('.input-return').value)||0;
        tAmt += parseFloat(tr.querySelector('.row-amount').textContent)||0;
    });

    document.getElementById('totTotal').textContent = tTotal;
    document.getElementById('totSold').textContent = tSold;
    document.getElementById('totReturn').textContent = tReturn;
    document.getElementById('totAmount').textContent = tAmt.toFixed(2);
    
    // Finance
    document.getElementById('totalAmount').value = tAmt.toFixed(2);
    calcDue();
}

function calcDue() {
    const total = parseFloat(document.getElementById('totalAmount').value) || 0;
    const disc = parseFloat(document.getElementById('discount').value) || 0;
    const online = parseFloat(document.getElementById('online').value) || 0;
    const cash = parseFloat(document.getElementById('cash').value) || 0;
    
    const due = total - (disc + online + cash);
    document.getElementById('dueAmount').textContent = due.toFixed(2);
}

// Event listeners for finance inputs
['discount', 'online', 'cash'].forEach(id => {
    document.getElementById(id).addEventListener('input', calcDue);
});
</script>
{% endblock %}
