{% extends "base.html" %}

{% block content %}
<!-- External Libraries -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Custom CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/evening.css') }}">

<div class="glass-container fade-in-up">

    <!-- Header Section -->
    <div class="text-center mb-5">
        <h1 class="main-title mb-1">Real Promotion</h1>
        <p class="text-muted small fw-bold tracking-widest">EVENING STOCK SETTLEMENT</p>
    </div>

    <!-- Controls Panel -->
    <div class="glass-panel mb-4">
        <div class="row align-items-end g-3">
            
            <!-- Employee Select -->
            <div class="col-md-4">
                <label class="small fw-bold text-muted mb-2 text-uppercase">Select Employee</label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-user-tie text-primary"></i></span>
                    <select id="employee" class="form-select border-start-0 ps-0 fw-bold" {% if last_settle_id %}disabled{% endif %}>
                        <option value="">-- Choose Sales Rep --</option>
                        {% for emp in employees %}
                        <option value="{{ emp.id }}" data-img="{{ emp.image }}" {% if selected_emp_id|string == emp.id|string %}selected{% endif %}>{{ emp.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- Date Select -->
            <div class="col-md-3">
                <label class="small fw-bold text-muted mb-2 text-uppercase">Date</label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="fa-regular fa-calendar text-primary"></i></span>
                    <input type="text" id="date" class="form-control border-start-0 ps-0 fw-bold" value="{{ today }}" {% if last_settle_id %}disabled{% endif %}>
                </div>
            </div>

            <!-- Fetch Button -->
            <div class="col-md-2">
                {% if last_settle_id %}
                    <a href="{{ url_for('evening') }}" class="btn btn-dark w-100 fw-bold rounded-pill">
                        <i class="fa-solid fa-plus me-1"></i> New
                    </a>
                {% else %}
                    <button id="btnFetch" class="btn btn-primary w-100 fw-bold rounded-pill" style="background: var(--primary-gradient); border:none;">
                        <i class="fa-solid fa-download me-1"></i> Fetch
                    </button>
                {% endif %}
            </div>

             <!-- Live Clock -->
             <div class="col-md-3 text-end d-none d-md-block">
                <div class="d-inline-block bg-white px-4 py-2 rounded-pill shadow-sm border">
                    <i class="fa-regular fa-clock me-2 text-muted"></i>
                    <span id="liveClock" class="fw-bold font-monospace text-dark">00:00:00</span>
                </div>
            </div>
        </div>
        <div id="fetchMsg" class="mt-3 text-center fw-bold small"></div>
    </div>

    <form method="POST" action="{{ url_for('evening') }}" id="eveningForm">
        <!-- Hidden Inputs for Logic -->
        <input type="hidden" name="allocation_id" id="allocation_id" value="{{ draft_data.allocation_id if draft_data else '' }}">
        <input type="hidden" name="h_employee" id="h_employee" value="{{ draft_data.employee_id if draft_data else '' }}">
        <input type="hidden" name="h_date" id="h_date" value="{{ draft_data.date if draft_data else '' }}">
        <input type="hidden" name="timestamp" id="timestampInput">
        <input type="hidden" name="status" id="formStatus" value="final">
        <input type="hidden" name="draft_id" value="{{ draft_data.id if draft_data and not last_settle_id else '' }}">

        <!-- MAIN STOCK TABLE -->
        <div class="custom-table-container mb-5">
            <div class="table-responsive">
                <table class="table table-borderless mb-0" id="stockTable">
                    <thead>
                        <tr>
                            <th class="ps-4">#</th>
                            <th class="text-center">Image</th>
                            <th>Product Name</th>
                            <th class="text-center">Total</th>
                            <th class="text-center">Sold</th>
                            <th class="text-end">Price</th>
                            <th class="text-end">Amount</th>
                            <th class="text-center">Return</th>
                            <th class="text-center">Left</th>
                        </tr>
                    </thead>
                    <tbody id="rowsArea">
                        {% if draft_items %}
                            {% for item in draft_items %}
                            <tr>
                                <td class="ps-4 text-muted fw-bold">{{ loop.index }}</td>
                                <td class="text-center"><img src="{{ item.image }}" class="img-thumbnail-custom"></td>
                                <td class="fw-bold text-dark">
                                    {{ item.product_name }}
                                    <input type="hidden" name="product_id[]" value="{{ item.product_id }}">
                                </td>
                                <td class="text-center">
                                    <input type="number" name="total_qty[]" class="form-control-plaintext text-center fw-bold" value="{{ item.total_qty }}" readonly>
                                </td>
                                <td class="text-center">
                                    <input type="number" name="sold[]" class="table-input sold" value="{{ item.sold_qty }}" min="0" {% if last_settle_id %}readonly{% endif %}>
                                </td>
                                <td>
                                    <input type="number" name="price[]" class="form-control-plaintext text-end" value="{{ item.unit_price }}" readonly>
                                </td>
                                <td class="text-end fw-bold text-primary row-amount">
                                    {{ "%.2f"|format(item.sold_qty * item.unit_price) }}
                                </td>
                                <td class="text-center">
                                    <input type="number" name="return[]" class="table-input return" value="{{ item.return_qty }}" min="0" {% if last_settle_id %}readonly{% endif %}>
                                </td>
                                <td class="text-center fw-bold text-muted remaining-qty">{{ item.remaining_qty }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="9" class="text-center p-5 text-muted fw-bold">No Data Loaded. Please Fetch Allocation.</td></tr>
                        {% endif %}
                    </tbody>
                    
                    <!-- DESIGNED FOOTER ROW -->
                    <tfoot style="border-top: 2px solid #e2e8f0; background: white;">
                        <tr>
                            <td colspan="3" class="text-end pe-4 text-uppercase fw-bold text-muted" style="vertical-align: middle;">Total Summary:</td>
                            <td class="text-center"><div class="tfoot-box box-gray" id="totTotal">0</div></td>
                            <td class="text-center"><div class="tfoot-box box-blue" id="totSold">0</div></td>
                            <td></td>
                            <td class="text-end"><div class="tfoot-box box-dark" id="totAmount">0.00</div></td>
                            <td class="text-center"><div class="tfoot-box box-red" id="totReturn">0</div></td>
                            <td class="text-center"><div class="tfoot-box box-green" id="totRemain">0</div></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- BOTTOM SECTION: FINANCE & COLLECTION -->
        <div class="row g-4 mb-5">
            
            <!-- LEFT: EMPLOYEE FINANCE -->
            <div class="col-lg-6">
                <div class="glass-panel h-100">
                    <div class="section-title text-dark">
                        <i class="fa-solid fa-wallet text-secondary"></i> Employee Finance
                    </div>
                    
                    {% if not last_settle_id %}
                    <!-- Credit Block -->
                    <div class="finance-block">
                        <div class="finance-label label-credit">
                            <i class="fa-solid fa-arrow-down me-1"></i> Credit (Received)
                        </div>
                        <div class="finance-inputs">
                            <input type="number" step="0.01" name="emp_credit_amount" class="form-control finance-input-field" placeholder="Amount ₹" style="flex: 1;">
                            <input type="text" name="emp_credit_note" class="form-control finance-input-field" placeholder="Note (e.g. Salary)" style="flex: 2;">
                        </div>
                    </div>

                    <!-- Debit Block -->
                    <div class="finance-block">
                        <div class="finance-label label-debit">
                            <i class="fa-solid fa-arrow-up me-1"></i> Debit (Advance)
                        </div>
                        <div class="finance-inputs">
                            <input type="number" step="0.01" name="emp_debit_amount" class="form-control finance-input-field" placeholder="Amount ₹" style="flex: 1;">
                            <input type="text" name="emp_debit_note" class="form-control finance-input-field" placeholder="Note (e.g. Fuel)" style="flex: 2;">
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-success fw-bold text-center p-4">
                        <i class="fa-solid fa-check-circle me-2"></i> Finance Locked
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- RIGHT: COLLECTION SETTLEMENT -->
            <div class="col-lg-6">
                <div class="glass-panel h-100">
                    <div class="section-title text-dark">
                        <i class="fa-solid fa-coins text-warning"></i> Payment Collection
                    </div>
                    
                    <div class="px-2">
                        <!-- Vertical List Format -->
                        
                        <!-- 1. Total Sales -->
                        <div class="collection-row">
                            <div class="col-label">
                                <i class="fa-solid fa-file-invoice text-secondary" style="width:20px;"></i> Total Sales Value
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold text-muted me-1">₹</span>
                                <input type="number" name="totalAmount" id="totalAmount" class="col-value-input" readonly value="{{ draft_data.total_amount if draft_data else '0.00' }}">
                            </div>
                        </div>

                        <!-- 2. Discount -->
                        <div class="collection-row">
                            <div class="col-label">
                                <i class="fa-solid fa-tags text-secondary" style="width:20px;"></i> Discount
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold text-danger me-1">-</span>
                                <input type="number" step="0.01" name="discount" id="discount" class="col-value-input" placeholder="0.00" value="{{ draft_data.discount if draft_data else '' }}" {% if last_settle_id %}readonly{% endif %}>
                            </div>
                        </div>

                        <!-- 3. Online -->
                        <div class="collection-row">
                            <div class="col-label">
                                <i class="fa-solid fa-qrcode text-info" style="width:20px;"></i> Online Received
                            </div>
                            <div class="d-flex align-items-center">
                                <input type="number" step="0.01" name="online" id="online" class="col-value-input text-info" placeholder="0.00" value="{{ draft_data.online_money if draft_data else '' }}" {% if last_settle_id %}readonly{% endif %}>
                            </div>
                        </div>

                        <!-- 4. Cash -->
                        <div class="collection-row">
                            <div class="col-label">
                                <i class="fa-solid fa-money-bill-wave text-success" style="width:20px;"></i> Cash Collected
                            </div>
                            <div class="d-flex align-items-center">
                                <input type="number" step="0.01" name="cash" id="cash" class="col-value-input text-success" placeholder="0.00" value="{{ draft_data.cash_money if draft_data else '' }}" {% if last_settle_id %}readonly{% endif %}>
                            </div>
                        </div>

                        <!-- 5. Balance Due -->
                        <div class="collection-row balance-row">
                            <div class="balance-label">
                                Balance Due
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="balance-amount">₹ </span>
                                <span id="dueAmount" class="balance-amount ms-1">0.00</span>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>

        <!-- ACTION BUTTONS -->
        <div class="d-flex justify-content-center gap-3 pb-5">
            {% if not last_settle_id %}
                <button type="button" onclick="submitForm('draft')" class="btn btn-action btn-save-draft">
                    <i class="fa-regular fa-floppy-disk me-2"></i> Save Draft
                </button>
                <button type="button" onclick="submitForm('final')" class="btn btn-action btn-submit-final">
                    <i class="fa-solid fa-check-double me-2"></i> Submit Allocation
                </button>
            {% else %}
                <a href="{{ url_for('evening') }}" class="btn btn-action btn-submit-final">
                    <i class="fa-solid fa-check me-2"></i> Done
                </a>
            {% endif %}
        </div>

    </form>
</div>

<!-- Link External JS -->
<script src="{{ url_for('static', filename='js/evening.js') }}"></script>
<script>
    // Embedded small helper logic that interacts directly with templates
    function submitForm(status) {
        document.getElementById('formStatus').value = status;
        const form = document.getElementById('eveningForm');
        const emp = document.getElementById('employee').value;

        if(!emp) { alert("Please select an employee first."); return; }

        if(status === 'final') {
            if(!confirm("Are you sure you want to SUBMIT this settlement? Inventory will be deducted.")) return;
        } 
        form.submit();
    }

    document.addEventListener("DOMContentLoaded", function() {
        flatpickr("#date", { dateFormat: "d-m-Y", defaultDate: "{{ today }}", allowInput: true });
        
        // Clock
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute:'2-digit', second:'2-digit' });
            if(document.getElementById('liveClock')) document.getElementById('liveClock').textContent = timeString;
            // DB Timestamp
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            if(document.getElementById('timestampInput')) document.getElementById('timestampInput').value = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        setInterval(updateClock, 1000);
        updateClock();
    });
</script>
{% endblock %}
