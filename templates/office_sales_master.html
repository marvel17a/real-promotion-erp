{% extends "admin_master.html" %}

{% block page_content %}
<!-- Libs -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<div class="container-fluid fade-in-up py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h3 class="fw-bold text-dark mb-0">Office Sales History</h3>
            <p class="text-muted small mb-0">Manage Counter Sales & Bills</p>
        </div>
        <div>
             <a href="{{ url_for('office_sales') }}" class="btn btn-dark rounded-pill shadow px-4">
                <i class="fa-solid fa-plus me-2"></i>New Sale
            </a>
        </div>
    </div>

    <!-- 1. Stats Cards -->
    <div class="row g-3 mb-4">
        <!-- Total Sales -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 bg-primary bg-opacity-10 h-100 rounded-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-primary fw-bold text-uppercase small mb-1">Total Sales</p>
                        <h4 class="fw-800 mb-0 text-dark">₹ {{ "%.2f"|format(stats.total_sales) }}</h4>
                    </div>
                    <div class="bg-primary text-white rounded-circle p-3 shadow-sm">
                        <i class="fa-solid fa-chart-line fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cash -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 bg-success bg-opacity-10 h-100 rounded-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-success fw-bold text-uppercase small mb-1">Cash Received</p>
                        <h4 class="fw-800 mb-0 text-dark">₹ {{ "%.2f"|format(stats.cash) }}</h4>
                    </div>
                    <div class="bg-success text-white rounded-circle p-3 shadow-sm">
                        <i class="fa-solid fa-money-bill-wave fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Online -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 bg-info bg-opacity-10 h-100 rounded-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-info fw-bold text-uppercase small mb-1">Online Received</p>
                        <h4 class="fw-800 mb-0 text-dark">₹ {{ "%.2f"|format(stats.online) }}</h4>
                    </div>
                    <div class="bg-info text-white rounded-circle p-3 shadow-sm">
                        <i class="fa-solid fa-qrcode fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Discount -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 bg-warning bg-opacity-10 h-100 rounded-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-warning fw-bold text-uppercase small mb-1">Total Discount</p>
                        <h4 class="fw-800 mb-0 text-dark">₹ {{ "%.2f"|format(stats.discount) }}</h4>
                    </div>
                    <div class="bg-warning text-white rounded-circle p-3 shadow-sm">
                        <i class="fa-solid fa-percent fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Filter Bar -->
    <div class="card glass-card border-0 shadow-sm mb-4">
        <div class="card-body p-3">
            <form method="GET" class="row g-2 align-items-center">
                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="fa-regular fa-calendar"></i></span>
                        <input type="text" name="start_date" class="form-control border-start-0 date-picker" placeholder="Start Date" value="{{ filters.start }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="fa-regular fa-calendar"></i></span>
                        <input type="text" name="end_date" class="form-control border-start-0 date-picker" placeholder="End Date" value="{{ filters.end }}">
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-dark w-100 rounded-pill fw-bold">Filter</button>
                </div>
                <div class="col-md-2">
                    <a href="{{ url_for('office_sales_master') }}" class="btn btn-outline-secondary w-100 rounded-pill fw-bold">Reset</a>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. Sales Table -->
    <div class="card glass-card border-0 shadow-sm overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-uppercase small text-muted">
                    <tr>
                        <th class="ps-4">ID</th>
                        <th>Date & Time</th>
                        <th>Customer</th>
                        <th class="text-end">Amount</th>
                        <th class="text-end">Paid</th>
                        <th class="text-center">Mode</th>
                        <th class="text-end pe-4">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in sales %}
                    <tr>
                        <td class="ps-4 fw-bold text-muted">#{{ s.id }}</td>
                        <td>
                            <div class="fw-bold text-dark">{{ s.formatted_date }}</div>
                            <div class="small text-muted" style="font-size: 0.75rem;">
                                <i class="fa-regular fa-clock me-1"></i> {{ s.formatted_time }}
                            </div>
                        </td>
                        <td>
                            <div class="fw-bold text-dark">{{ s.customer_name }}</div>
                            <div class="small text-muted">{{ s.customer_mobile }}</div>
                        </td>
                        <td class="text-end fw-bold text-primary">₹ {{ "%.2f"|format(s.final_amount) }}</td>
                        <td class="text-end">
                            <span class="d-block text-success fw-bold">{{ "%.2f"|format(s.cash_amount + s.online_amount) }}</span>
                            {% if s.discount > 0 %}
                            <small class="text-warning">Disc: {{ "%.2f"|format(s.discount) }}</small>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if s.online_amount > 0 and s.cash_amount > 0 %}
                                <span class="badge bg-secondary">Mixed</span>
                            {% elif s.online_amount > 0 %}
                                <span class="badge bg-info">Online</span>
                            {% elif s.cash_amount > 0 %}
                                <span class="badge bg-success">Cash</span>
                            {% else %}
                                <span class="badge bg-danger">Unpaid</span>
                            {% endif %}
                        </td>
                        <td class="text-end pe-4">
                            <div class="btn-group shadow-sm rounded-pill">
                                <!-- View -->
                                <a href="{{ url_for('view_office_sale', sale_id=s.id) }}" class="btn btn-sm btn-white border-end" title="View Details">
                                    <i class="fa-solid fa-eye text-secondary"></i>
                                </a>
                                <!-- PDF -->
                                <a href="{{ url_for('download_office_bill', sale_id=s.id) }}" class="btn btn-sm btn-white border-end" title="Print Bill">
                                    <i class="fa-solid fa-file-pdf text-danger"></i>
                                </a>
                                <!-- Edit -->
                                <a href="{{ url_for('edit_office_sale', sale_id=s.id) }}" class="btn btn-sm btn-white border-end" title="Edit">
                                    <i class="fa-solid fa-pen text-primary"></i>
                                </a>
                                <!-- WhatsApp -->
                                {% set pdf_link = url_for('download_office_bill', sale_id=s.id, _external=True) %}
                                {% set wa_msg = "Hello " ~ s.customer_name ~ ", Bill #" ~ s.id ~ " generated. Download: " ~ pdf_link %}
                                <a href="https://wa.me/91{{ s.customer_mobile }}?text={{ wa_msg | urlencode }}" target="_blank" class="btn btn-sm btn-white border-end text-success" title="WhatsApp">
                                    <i class="fa-brands fa-whatsapp"></i>
                                </a>
                                <!-- Delete -->
                                <form action="{{ url_for('delete_office_sale', sale_id=s.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Delete Sale? Stock will be restored.');">
                                    <button class="btn btn-sm btn-white text-danger border-0 rounded-end-pill ps-2" title="Delete">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="7" class="text-center py-5 text-muted">No sales records found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        flatpickr(".date-picker", { dateFormat: "d-m-Y", allowInput: true });
    });
</script>

<style>
    .glass-card { background: #fff; border-radius: 12px; }
    .btn-white { background: #fff; border: 1px solid #dee2e6; }
    .btn-white:hover { background: #f8f9fa; }
</style>
{% endblock %}
