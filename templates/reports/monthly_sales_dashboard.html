{% extends "admin_master.html" %}

{% block page_content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Custom Styles for Dashboard -->
<style>
    :root {
        --primary-color: #4361ee;
        --secondary-color: #3f37c9;
        --success-color: #4cc9f0;
        --warning-color: #f72585;
        --light-bg: #f8f9fa;
        --card-bg: #ffffff;
        --font-heading: 'Quicksand', sans-serif;
        --font-body: 'Rubik', sans-serif;
    }

    body {
        background-color: var(--light-bg);
        font-family: var(--font-body);
    }

    .fade-in-up { animation: fadeInUp 0.6s ease-out; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* Filter Bar */
    .filter-bar {
        background: var(--card-bg);
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        margin-bottom: 2rem;
        border: 1px solid rgba(0,0,0,0.02);
    }

    /* KPI Cards */
    .kpi-card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.04);
        border: 1px solid rgba(0,0,0,0.02);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
        position: relative;
        overflow: hidden;
    }
    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    }
    .kpi-icon-bg {
        position: absolute;
        right: -10px;
        bottom: -10px;
        font-size: 5rem;
        opacity: 0.05;
        transform: rotate(-15deg);
    }
    .kpi-label {
        font-family: var(--font-heading);
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
    }
    .kpi-value {
        font-family: var(--font-heading);
        font-weight: 700;
        color: #2d3748;
        font-size: 1.75rem;
        margin-top: 0.5rem;
    }

    /* Chart Containers */
    .chart-card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.04);
        margin-bottom: 2rem;
        height: 100%;
    }
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    .chart-title {
        font-family: var(--font-heading);
        font-weight: 700;
        color: #2d3748;
        font-size: 1.1rem;
        margin: 0;
    }

    /* Data Table */
    .table-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.04);
        overflow: hidden;
    }
    .custom-table thead th {
        background-color: #f1f5f9;
        color: #64748b;
        font-family: var(--font-heading);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.75rem;
        padding: 1rem 1.5rem;
        border-bottom: 2px solid #e2e8f0;
    }
    .custom-table tbody td {
        padding: 1rem 1.5rem;
        vertical-align: middle;
        color: #475569;
        font-size: 0.9rem;
        border-bottom: 1px solid #f1f5f9;
    }
    .custom-table tr:hover td {
        background-color: #f8fafc;
    }
</style>

<div class="container-fluid py-4 fade-in-up">

    <!-- 1. Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1" style="font-family: var(--font-heading);">Monthly Sales Insights</h2>
            <p class="text-muted small mb-0">Visual analysis of sales performance and growth trends.</p>
        </div>
        <div class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill fw-bold">
            <i class="fa-regular fa-calendar me-2"></i> Year: {{ selected_year }}
        </div>
    </div>

    <!-- 2. Filter Section -->
    <div class="filter-bar">
        <form class="row g-3 align-items-end" method="get">
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted text-uppercase">Select Year</label>
                <div class="input-group">
                    <span class="input-group-text bg-light border-end-0"><i class="fa-solid fa-calendar-days text-muted"></i></span>
                    <select name="year" class="form-select border-start-0 bg-light" onchange="this.form.submit()">
                        {% for y in year_list %}
                        <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted text-uppercase">Start Month</label>
                <select name="start_month" class="form-select">
                    <option value="">-- All Months --</option>
                    {% for m in range(1,13) %}
                    <option value="{{ m }}" {% if start_month|int == m %}selected{% endif %}>{{ m }} - {{ ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][m-1] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted text-uppercase">End Month</label>
                <select name="end_month" class="form-select">
                    <option value="">-- All Months --</option>
                    {% for m in range(1,13) %}
                    <option value="{{ m }}" {% if end_month|int == m %}selected{% endif %}>{{ m }} - {{ ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][m-1] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100 fw-bold shadow-sm" style="padding: 0.6rem;">
                    <i class="fa-solid fa-filter me-2"></i> Apply Analysis
                </button>
            </div>
        </form>
    </div>

    <!-- CALCULATION LOGIC -->
    {% set ns = namespace(total_revenue=0, total_units=0) %}
    {% for row in monthly_data %}
        {% set ns.total_revenue = ns.total_revenue + row.total_revenue %}
        {% set ns.total_units = ns.total_units + row.total_qty %}
    {% endfor %}
    {% set avg_monthly_rev = ns.total_revenue / monthly_data|length if monthly_data|length > 0 else 0 %}

    <!-- 3. KPI Overview Cards -->
    <div class="row g-4 mb-4">
        <!-- Total Revenue -->
        <div class="col-md-4">
            <div class="kpi-card border-bottom border-4 border-primary">
                <div class="kpi-label">Total Revenue (Selected Period)</div>
                <div class="kpi-value text-primary">{{ ns.total_revenue|inr }}</div>
                <i class="fa-solid fa-coins kpi-icon-bg text-primary"></i>
            </div>
        </div>
        <!-- Units Sold -->
        <div class="col-md-4">
            <div class="kpi-card border-bottom border-4 border-success">
                <div class="kpi-label">Total Units Sold</div>
                <div class="kpi-value text-success">{{ ns.total_units }} <span class="fs-6 text-muted fw-normal">Units</span></div>
                <i class="fa-solid fa-boxes-stacked kpi-icon-bg text-success"></i>
            </div>
        </div>
        <!-- Avg Monthly Revenue -->
        <div class="col-md-4">
            <div class="kpi-card border-bottom border-4 border-warning">
                <div class="kpi-label">Average Monthly Sales</div>
                <div class="kpi-value text-warning">{{ avg_monthly_rev|inr }}</div>
                <i class="fa-solid fa-chart-line kpi-icon-bg text-warning"></i>
            </div>
        </div>
    </div>

    <!-- 4. Visual Growth Charts -->
    <div class="row g-4 mb-5">
        <!-- Main Combo Chart: Revenue vs Quantity -->
        <div class="col-lg-8">
            <div class="chart-card">
                <div class="chart-header">
                    <h5 class="chart-title">Monthly Sales Performance</h5>
                    <span class="badge bg-light text-dark border">Rev vs Qty</span>
                </div>
                <div style="height: 350px;">
                    <canvas id="monthlyComboChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Category Distribution -->
        <div class="col-lg-4">
            <div class="chart-card">
                <div class="chart-header">
                    <h5 class="chart-title">Sales by Category</h5>
                </div>
                <div style="height: 300px; display: flex; justify-content: center;">
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="mt-3 text-center">
                    <small class="text-muted">Breakdown by Quantity Sold</small>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Detailed Breakdown Table -->
    <div class="row">
        <div class="col-12">
            <div class="table-card">
                <div class="p-3 border-bottom bg-white d-flex align-items-center justify-content-between">
                    <h6 class="m-0 fw-bold text-dark" style="font-family: var(--font-heading);">Monthly Breakdown Data</h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="window.print()"><i class="fa-solid fa-print me-1"></i> Print</button>
                </div>
                <div class="table-responsive">
                    <table class="table custom-table mb-0">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th class="text-center">Units Sold</th>
                                <th class="text-end">Revenue Generated</th>
                                <th class="text-center">Performance</th> <!-- Visual Indicator -->
                            </tr>
                        </thead>
                        <tbody>
                            {% set ns_prev = namespace(val=0) %}
                            {% for row in monthly_data %}
                            <tr>
                                <td class="fw-bold">{{ row.month }}</td>
                                <td class="text-center">
                                    <span class="badge bg-light text-dark border px-3">{{ row.total_qty }}</span>
                                </td>
                                <td class="text-end fw-bold text-primary">{{ row.total_revenue|inr }}</td>
                                <td class="text-center">
                                    {% if loop.first %}
                                        <span class="text-muted small">-</span>
                                    {% else %}
                                        {% set diff = row.total_revenue - ns_prev.val %}
                                        {% if diff > 0 %}
                                            <span class="text-success small fw-bold"><i class="fa-solid fa-arrow-trend-up me-1"></i> Growth</span>
                                        {% elif diff < 0 %}
                                            <span class="text-danger small fw-bold"><i class="fa-solid fa-arrow-trend-down me-1"></i> Drop</span>
                                        {% else %}
                                            <span class="text-muted small">Stable</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% set ns_prev.val = row.total_revenue %}
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-5 text-muted">No sales data found for selected period.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Chart JS Logic -->
<script>
    // Data from Backend
    const monthlyData = {{ monthly_data | tojson | safe }};
    const categoryData = {{ category_data | tojson | safe }};

    // Prepare Arrays
    const months = monthlyData.map(m => {
        // Format Month string (e.g., 2025-01 -> Jan 25)
        const d = new Date(m.month + '-01');
        return d.toLocaleString('default', { month: 'short', year: '2-digit' });
    });
    const qtyData = monthlyData.map(m => m.total_qty);
    const revenueData = monthlyData.map(m => m.total_revenue);

    // --- 1. COMBO CHART (Revenue & Qty) ---
    const ctxCombo = document.getElementById('monthlyComboChart').getContext('2d');
    
    // Gradient for Revenue Line
    const gradRev = ctxCombo.createLinearGradient(0, 0, 0, 400);
    gradRev.addColorStop(0, 'rgba(67, 97, 238, 0.4)');
    gradRev.addColorStop(1, 'rgba(67, 97, 238, 0.0)');

    new Chart(ctxCombo, {
        type: 'line',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'Revenue (₹)',
                    data: revenueData,
                    borderColor: '#4361ee',
                    backgroundColor: gradRev,
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#4361ee',
                    pointRadius: 5,
                    fill: true,
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Quantity Sold',
                    data: qtyData,
                    type: 'bar',
                    backgroundColor: 'rgba(76, 201, 240, 0.3)',
                    borderColor: '#4cc9f0',
                    borderWidth: 1,
                    borderRadius: 4,
                    barPercentage: 0.4,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.9)',
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label.includes('Revenue')) {
                                return label + ': ₹' + context.raw.toLocaleString('en-IN');
                            }
                            return label + ': ' + context.raw;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: { borderDash: [4, 4] },
                    ticks: { callback: function(value) { return '₹' + value/1000 + 'k'; } }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'Units' }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });

    // --- 2. CATEGORY DOUGHNUT CHART ---
    const catLabels = categoryData.map(c => c.category_name || 'Uncategorized');
    const catValues = categoryData.map(c => c.total_qty);
    const catColors = ['#4361ee', '#3f37c9', '#4cc9f0', '#f72585', '#7209b7', '#4895ef'];

    const ctxCat = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctxCat, {
        type: 'doughnut',
        data: {
            labels: catLabels,
            datasets: [{
                data: catValues,
                backgroundColor: catColors,
                borderWidth: 0,
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15, font: { size: 11 } } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let val = context.raw;
                            let total = context.chart._metasets[context.datasetIndex].total;
                            let pct = ((val / total) * 100).toFixed(1) + '%';
                            return ` ${context.label}: ${val} (${pct})`;
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
