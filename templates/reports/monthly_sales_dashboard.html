{% extends "admin_master.html" %}

{% block page_content %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
    :root {
        --font-main: 'Outfit', sans-serif;
        --color-bg: #f3f4f6;
        --color-card: #ffffff;
        --color-primary: #6366f1; /* Indigo */
        --color-success: #10b981; /* Emerald */
        --color-warning: #f59e0b; /* Amber */
        --color-purple: #8b5cf6;  /* Violet */
        --color-dark: #1e293b;
        --color-gray: #64748b;
    }

    body {
        background-color: var(--color-bg);
        font-family: var(--font-main);
        color: var(--color-dark);
    }

    .fade-in { animation: fadeIn 0.6s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Top Control Bar */
    .control-bar {
        background: var(--color-card);
        border-radius: 16px;
        padding: 1.2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        border: 1px solid rgba(0,0,0,0.03);
    }

    .page-title h3 { margin: 0; font-weight: 700; color: var(--color-dark); font-size: 1.5rem; }
    .page-title p { margin: 0; color: var(--color-gray); font-size: 0.9rem; }

    .year-filter select {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 0.6rem 2.5rem 0.6rem 1rem;
        font-weight: 600;
        color: var(--color-dark);
        cursor: pointer;
    }

    /* KPI Cards - Modern Solid Style */
    .stat-card {
        border-radius: 20px;
        padding: 1.5rem;
        color: #fff;
        position: relative;
        overflow: hidden;
        height: 100%;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    .stat-card:hover { transform: translateY(-5px); }
    
    .stat-card.blue   { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
    .stat-card.green  { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .stat-card.orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .stat-card.purple { background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%); }

    .stat-icon {
        position: absolute;
        right: -10px; bottom: -10px;
        font-size: 5rem;
        opacity: 0.15;
        transform: rotate(-10deg);
    }

    .stat-label { font-size: 0.85rem; font-weight: 500; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 2rem; font-weight: 700; margin-top: 0.5rem; line-height: 1; }

    /* Chart Containers */
    .dashboard-card {
        background: var(--color-card);
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        height: 100%;
        border: 1px solid rgba(0,0,0,0.02);
    }
    .card-heading {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--color-dark);
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Modern Table */
    .modern-table { width: 100%; border-collapse: separate; border-spacing: 0; }
    .modern-table th {
        background: #f8fafc;
        color: var(--color-gray);
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        padding: 1rem;
        border-bottom: 2px solid #e2e8f0;
    }
    .modern-table td {
        padding: 1rem;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.95rem;
        font-weight: 500;
    }
    .modern-table tr:hover td { background-color: #f8fafc; }
    
    .trend-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .trend-up { background-color: #dcfce7; color: #166534; }
    .trend-down { background-color: #fee2e2; color: #991b1b; }
    .trend-flat { background-color: #f1f5f9; color: #475569; }

</style>

<div class="container-fluid py-4 fade-in">
     <a href="{{ url_for('reports') }}" class="btn btn-light btn-sm rounded-pill px-3 border shadow-sm ms-2 fw-bold">
                <i class="fa-solid fa-arrow-left me-2"></i>Back
            </a>
    
    <!-- 1. Top Control Bar -->
    <div class="control-bar">
        <div class="page-title">
            <h3>Sales Dashboard</h3>
            <p>Financial Year Performance & Growth Analysis</p>
        </div>
        <form method="GET" class="d-flex align-items-center gap-3">
            <div class="year-filter">
                <select name="year" onchange="this.form.submit()">
                    {% for y in year_list %}
                        <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>Year: {{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="window.print()">
                <i class="fa-solid fa-print me-2"></i> Print Report
            </button>
        </form>
    </div>

    <!-- 2. KPI Cards -->
    <div class="row g-4 mb-5">
        <!-- Revenue -->
        <div class="col-xl-3 col-md-6">
            <div class="stat-card blue">
                <div class="stat-label">Total Revenue</div>
                <div class="stat-value">{{ kpi.revenue|inr }}</div>
                <i class="fa-solid fa-sack-dollar stat-icon"></i>
            </div>
        </div>
        <!-- Units -->
        <div class="col-xl-3 col-md-6">
            <div class="stat-card green">
                <div class="stat-label">Total Units Sold</div>
                <div class="stat-value">{{ kpi.units }}</div>
                <i class="fa-solid fa-box-open stat-icon"></i>
            </div>
        </div>
        <!-- Average -->
        <div class="col-xl-3 col-md-6">
            <div class="stat-card purple">
                <div class="stat-label">Avg. Monthly Sales</div>
                <div class="stat-value">{{ kpi.avg|inr }}</div>
                <i class="fa-solid fa-chart-area stat-icon"></i>
            </div>
        </div>
        <!-- Best Month -->
        <div class="col-xl-3 col-md-6">
            <div class="stat-card orange">
                <div class="stat-label">Best Performing Month</div>
                <div class="stat-value" style="font-size: 1.5rem; margin-top: 1rem;">
                    {{ kpi.best_month }}
                    <div style="font-size: 0.8rem; font-weight: 400; opacity: 0.9;">{{ kpi.best_val|inr }}</div>
                </div>
                <i class="fa-solid fa-trophy stat-icon"></i>
            </div>
        </div>
    </div>

    <!-- 3. Charts Section -->
    <div class="row g-4 mb-5">
        <!-- Main Growth Chart -->
        <div class="col-lg-8">
            <div class="dashboard-card">
                <div class="card-heading">
                    <span>Monthly Growth Trend</span>
                    <span class="badge bg-light text-primary border">Revenue vs Units</span>
                </div>
                <div style="height: 350px;">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Top Products Doughnut -->
        <div class="col-lg-4">
            <div class="dashboard-card">
                <div class="card-heading">
                    <span>Top Selling Products</span>
                    <small class="text-muted">By Qty</small>
                </div>
                <div style="height: 300px; position: relative;">
                    <canvas id="productChart"></canvas>
                </div>
                <!-- Custom Legend Container (optional) -->
                <div id="productLegend" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- 4. Detailed Data Table -->
    <div class="row">
        <div class="col-12">
            <div class="dashboard-card p-0 overflow-hidden">
                <div class="p-4 border-bottom bg-white">
                    <h5 class="fw-bold mb-0 text-dark">Detailed Monthly Breakdown</h5>
                </div>
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th class="ps-4">Month</th>
                                <th class="text-center">Units Sold</th>
                                <th class="text-end">Revenue</th>
                                <th class="text-center pe-4">Trend (vs Prev)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set ns = namespace(prev_rev=0) %}
                            {% for row in monthly_data %}
                            <tr>
                                <td class="ps-4 fw-bold text-dark">{{ row.month }}</td>
                                <td class="text-center">
                                    <span class="badge bg-light text-dark border px-3 py-2">{{ row.units }}</span>
                                </td>
                                <td class="text-end fw-bold text-primary">{{ row.revenue|inr }}</td>
                                
                                <!-- Trend Logic -->
                                <td class="text-center pe-4">
                                    {% if loop.first %}
                                        <span class="trend-badge trend-flat">-</span>
                                    {% else %}
                                        {% set diff = row.revenue - ns.prev_rev %}
                                        {% if diff > 0 %}
                                            <span class="trend-badge trend-up"><i class="fa-solid fa-arrow-trend-up"></i> Up</span>
                                        {% elif diff < 0 %}
                                            <span class="trend-badge trend-down"><i class="fa-solid fa-arrow-trend-down"></i> Down</span>
                                        {% else %}
                                            <span class="trend-badge trend-flat">Stable</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% set ns.prev_rev = row.revenue %}
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-5 text-muted">No sales data found for {{ selected_year }}.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- DATA & SCRIPTS -->
<script>
    // 1. Prepare Data
    const monthlyData = {{ monthly_data | tojson | safe }};
    const topProducts = {{ top_products | tojson | safe }};

    const labels = monthlyData.map(d => d.month);
    const revenueData = monthlyData.map(d => d.revenue);
    const unitData = monthlyData.map(d => d.units);

    // 2. Growth Chart (Line + Bar)
    const ctxGrowth = document.getElementById('growthChart').getContext('2d');
    
    // Gradient for Line
    const gradient = ctxGrowth.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)'); // Primary color
    gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

    new Chart(ctxGrowth, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Revenue (₹)',
                    data: revenueData,
                    borderColor: '#6366f1',
                    backgroundColor: gradient,
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#6366f1',
                    yAxisID: 'y'
                },
                {
                    label: 'Units Sold',
                    data: unitData,
                    type: 'bar',
                    backgroundColor: 'rgba(16, 185, 129, 0.2)', // Green low opacity
                    borderColor: '#10b981',
                    borderWidth: 1,
                    borderRadius: 4,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    backgroundColor: '#1e293b',
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label.includes('Revenue')) {
                                return label + ': ' + context.raw.toLocaleString('en-IN', {style: 'currency', currency: 'INR'});
                            }
                            return label + ': ' + context.raw;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: { borderDash: [4, 4], color: '#f1f5f9' },
                    ticks: { callback: function(val) { return '₹' + val/1000 + 'k'; } }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'Units' }
                },
                x: { grid: { display: false } }
            }
        }
    });

    // 3. Top Products Chart (Doughnut)
    const ctxProd = document.getElementById('productChart').getContext('2d');
    const prodNames = topProducts.map(p => p.product_name);
    const prodQty = topProducts.map(p => p.total_qty);

    new Chart(ctxProd, {
        type: 'doughnut',
        data: {
            labels: prodNames,
            datasets: [{
                data: prodQty,
                backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#3b82f6'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '75%',
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15 } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let val = context.raw;
                            let total = context.chart._metasets[context.datasetIndex].total;
                            let pct = ((val / total) * 100).toFixed(1) + '%';
                            return ` ${context.label}: ${val} (${pct})`;
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
