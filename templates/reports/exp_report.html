{% extends 'admin_master.html' %}
{% block title %}Expense Analytics Hub{% endblock %}

{% block page_content %}

<!-- Google Fonts: Inter -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">

<style>
    :root {
        --glass-bg: rgba(255, 255, 255, 0.9);
        --glass-border: 1px solid rgba(255, 255, 255, 0.5);
        --shadow-soft: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
        --primary-accent: #4f46e5; /* Indigo-600 */
        --text-main: #1e293b;
        --text-muted: #64748b;
        --bg-surface: #f8fafc;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-surface);
    }

    /* Page Layout */
    .report-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    /* Header Section */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-title h2 {
        font-weight: 800;
        letter-spacing: -0.025em;
        color: var(--text-main);
        margin-bottom: 0.25rem;
        font-size: 1.75rem;
    }

    .page-title p {
        color: var(--text-muted);
        font-size: 0.95rem;
        font-weight: 500;
        margin: 0;
    }

    /* Net Outflow Widget */
    .outflow-widget {
        background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 16px;
        box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.4);
        display: flex;
        align-items: center;
        gap: 1rem;
        min-width: 260px;
    }

    .widget-icon {
        background: rgba(255, 255, 255, 0.2);
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .widget-content small {
        display: block;
        opacity: 0.9;
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .widget-content .amount {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1.2;
    }

    /* Filter Card (Control Center) */
    .control-center {
        background: var(--glass-bg);
        border: var(--glass-border);
        box-shadow: var(--shadow-soft);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(8px);
    }

    .control-label {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
        display: block;
    }

    .modern-select, .modern-input {
        background-color: #fff;
        border: 1px solid #e2e8f0;
        color: var(--text-main);
        border-radius: 10px;
        padding: 0.625rem 1rem;
        font-size: 0.95rem;
        font-weight: 500;
        width: 100%;
        transition: all 0.2s;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }

    .modern-select:focus, .modern-input:focus {
        border-color: var(--primary-accent);
        outline: none;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* Flatpickr Customization */
    .flatpickr-input {
        background-color: #fff !important; /* Ensure white background */
    }

    .btn-generate {
        background-color: var(--text-main);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 0.625rem 1.5rem;
        font-weight: 600;
        width: 100%;
        height: 100%;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-generate:hover {
        background-color: #0f172a; /* Slate-900 */
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Transitions */
    .animate-fade {
        animation: fadeIn 0.4s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .dashboard-header { flex-direction: column; align-items: flex-start; }
        .outflow-widget { width: 100%; }
        .btn-generate { margin-top: 1rem; }
    }
</style>

<div class="report-container">
    
    <!-- 1. Header & KPI Widget -->
    <div class="dashboard-header">
        <div class="page-title">
            <h2>Expense Intelligence</h2>
            <p>Analyze spending patterns and financial health.</p>
        </div>
        
        <!-- Total Outflow Widget (Uses data passed from backend) -->
        <div class="outflow-widget">
            <div class="widget-icon">
                <i class="fa-solid fa-arrow-trend-down"></i>
            </div>
            <div class="widget-content">
                <small>Total Outflow (Period)</small>
                <div class="amount">
                    {% if report_data.summary %}
                        {{ report_data.summary.total | inr }}
                    {% else %}
                        â‚¹ 0.00
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 2. The Control Center (Filters) -->
    <div class="control-center">
        <form id="report-filter-form" method="GET" action="{{ url_for('exp_report') }}">
            <div class="row g-3 align-items-end">
                
                <!-- Report Type Selector -->
                <div class="col-lg-3 col-md-6">
                    <label class="control-label">Analysis View</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0 rounded-start-3 ps-3 text-muted">
                            <i class="fa-solid fa-layer-group"></i>
                        </span>
                        <select name="type" id="report_type" class="form-select modern-select border-start-0 ps-2" onchange="toggleFilters()">
                            <option value="monthly_summary" {{ 'selected' if report_type == 'monthly_summary' else '' }}>Monthly Snapshot</option>
                            <option value="detailed_log" {{ 'selected' if report_type == 'detailed_log' else '' }}>Detailed Ledger</option>
                            <option value="category_wise" {{ 'selected' if report_type == 'category_wise' else '' }}>Category Analysis</option>
                            <option value="subcategory_wise" {{ 'selected' if report_type == 'subcategory_wise' else '' }}>Sub-Category Drilldown</option>
                            <option value="mom_comparison" {{ 'selected' if report_type == 'mom_comparison' else '' }}>Month-over-Month Trend</option>
                            <option value="annual_summary" {{ 'selected' if report_type == 'annual_summary' else '' }}>Annual Overview</option>
                        </select>
                    </div>
                </div>

                <!-- DYNAMIC FILTER: Month/Year -->
                <div id="filter-monthly" class="col-lg-5 col-md-6 filter-group">
                    <div class="row g-2">
                        <div class="col-7">
                            <label class="control-label">Select Month</label>
                            <select name="month" class="form-select modern-select">
                                {% for m_val, m_name in months %}
                                <option value="{{ m_val }}" {{ 'selected' if filters.month == m_val else '' }}>{{ m_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-5">
                            <label class="control-label">Year</label>
                            <input type="number" name="year" class="modern-input" value="{{ filters.year }}">
                        </div>
                    </div>
                </div>

                <!-- DYNAMIC FILTER: Date Range -->
                <div id="filter-range" class="col-lg-5 col-md-6 filter-group d-none">
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="control-label">From Date</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0 rounded-start-3 ps-3 text-muted">
                                    <i class="fa-regular fa-calendar"></i>
                                </span>
                                <input type="text" name="start_date" id="start_date" class="form-control modern-input border-start-0 ps-2 flatpickr-date" value="{{ filters.start_date }}" placeholder="Select Date">
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="control-label">To Date</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0 rounded-start-3 ps-3 text-muted">
                                    <i class="fa-regular fa-calendar"></i>
                                </span>
                                <input type="text" name="end_date" id="end_date" class="form-control modern-input border-start-0 ps-2 flatpickr-date" value="{{ filters.end_date }}" placeholder="Select Date">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Button -->
                <div class="col-lg-2 col-md-12 ms-auto">
                    <button type="submit" class="btn-generate">
                        <span>Run Report</span>
                        <i class="fa-solid fa-chevron-right fa-xs"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- 3. Dynamic Report Content -->
    <!-- This area is where your partials (_monthly_summary.html, etc.) will load -->
    <div id="report-content" class="animate-fade">
        {% if report_type == 'monthly_summary' %}
            {% include 'reports/_monthly_summary.html' %}
        {% elif report_type == 'detailed_log' %}
            {% include 'reports/_detailed_log.html' %}
        {% elif report_type == 'category_wise' %}
            {% include 'reports/_category_wise.html' %}
        {% elif report_type == 'subcategory_wise' %}
            {% include 'reports/_subcategory_wise.html' %}
        {% elif report_type == 'mom_comparison' %}
            {% include 'reports/_mom_comparison.html' %}
        {% elif report_type == 'annual_summary' %}
            {% include 'reports/_annual_summary.html' %}
        {% endif %}
    </div>

</div>

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- JavaScript for Filter Logic -->
<script>
    function toggleFilters() {
        const reportType = document.getElementById('report_type').value;
        const monthlyFilter = document.getElementById('filter-monthly');
        const rangeFilter = document.getElementById('filter-range');

        // Logic: These reports need Date Range, others need Month/Year
        const needsRange = ['detailed_log', 'product_performance'].includes(reportType);

        if (needsRange) {
            monthlyFilter.classList.add('d-none');
            rangeFilter.classList.remove('d-none');
        } else {
            monthlyFilter.classList.remove('d-none');
            rangeFilter.classList.add('d-none');
        }
    }

    // Run on load to set initial state and init Flatpickr
    document.addEventListener('DOMContentLoaded', function() {
        toggleFilters();

        // Initialize Flatpickr
        flatpickr(".flatpickr-date", {
            dateFormat: "d-m-Y", // Format sent to backend (standard ISO)
            altInput: true,      // Show user-friendly format
            altFormat: "j F, Y", // e.g., October 25, 2023
            allowInput: true,
            theme: "airbnb"      // Matches the loaded CSS theme
        });
    });
</script>

{% endblock %}
