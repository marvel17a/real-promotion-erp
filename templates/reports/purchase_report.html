{% extends "admin_master.html" %}

{% block page_content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Premium Design CSS -->
<style>
    :root {
        --primary-color: #4e73df;
        --secondary-color: #858796;
        --success-color: #1cc88a;
        --info-color: #36b9cc;
        --warning-color: #f6c23e;
        --danger-color: #e74a3b;
        --dark-color: #5a5c69;
        --body-bg: #f8f9fc;
        --card-bg: #ffffff;
    }

    body { background-color: var(--body-bg); font-family: 'Nunito', sans-serif; }

    .fade-in-up { animation: fadeInUp 0.6s ease-out; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* KPI Cards */
    .kpi-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        transition: transform 0.2s;
        overflow: hidden;
        height: 100%;
        background: #fff;
        position: relative;
    }
    .kpi-card:hover { transform: translateY(-5px); }
    .kpi-border-left { border-left: 5px solid; }
    .kpi-purple { border-left-color: var(--primary-color); }
    .kpi-orange { border-left-color: var(--warning-color); }
    .kpi-green { border-left-color: var(--success-color); }
    
    .kpi-icon {
        width: 50px; height: 50px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem;
        opacity: 0.15;
    }

    /* Filter Bar */
    .filter-box {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        border: 1px solid rgba(0,0,0,0.05);
    }

    /* Charts */
    .chart-box {
        background: #fff;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        height: 400px;
        position: relative;
    }

    /* Table */
    .table-container {
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        overflow: hidden;
    }
    .table thead th {
        background: #f8f9fc;
        color: var(--secondary-color);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.75rem;
        border-bottom: 2px solid #e3e6f0;
        padding: 1rem;
    }
    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
        color: var(--dark-color);
    }
</style>

<!-- --- DATA CALCULATION LOGIC (JINJA) --- -->
<!-- This ensures data is calculated before display -->
{% set ns = namespace(total_val=0, total_count=0) %}
{% for p in purchases %}
    {% set ns.total_val = ns.total_val + p.total_amount %}
    {% set ns.total_count = ns.total_count + 1 %}
{% endfor %}

<!-- Determine Top Supplier from Chart Data if available -->
{% set top_supplier_name = "N/A" %}
{% if supplier_data and supplier_data|length > 0 %}
    {% set top_supplier_name = supplier_data[0].supplier_name %}
{% endif %}

<div class="container-fluid py-4 fade-in-up">

    <!-- 1. Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">Purchase Analytics</h2>
            <p class="text-muted small mb-0">Overview of procurement performance.</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('export_purchase_excel') }}" class="btn btn-success btn-sm rounded-pill px-3 shadow-sm fw-bold">
                <i class="fa-solid fa-file-excel me-2"></i>Export Excel
            </a>
            <a href="{{ url_for('export_purchase_pdf') }}" class="btn btn-danger btn-sm rounded-pill px-3 shadow-sm fw-bold">
                <i class="fa-solid fa-file-pdf me-2"></i>Export PDF
            </a>
        </div>
    </div>

    <!-- 2. KPI Cards Row (3 Cards) -->
    <div class="row g-4 mb-4">
        <!-- Total Purchases -->
        <div class="col-md-4">
            <div class="kpi-card kpi-border-left kpi-purple p-3">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-uppercase text-primary fw-bold small mb-1">Total Amount</div>
                        <div class="h4 mb-0 fw-bold text-dark">{{ ns.total_val|inr }}</div>
                    </div>
                    <div class="kpi-icon bg-primary text-primary"><i class="fa-solid fa-indian-rupee-sign"></i></div>
                </div>
            </div>
        </div>

        <!-- Total Orders -->
        <div class="col-md-4">
            <div class="kpi-card kpi-border-left kpi-orange p-3">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-uppercase text-warning fw-bold small mb-1">Total Orders</div>
                        <div class="h4 mb-0 fw-bold text-dark">{{ ns.total_count }}</div>
                    </div>
                    <div class="kpi-icon bg-warning text-warning"><i class="fa-solid fa-file-invoice"></i></div>
                </div>
            </div>
        </div>

        <!-- Top Supplier -->
        <div class="col-md-4">
            <div class="kpi-card kpi-border-left kpi-green p-3">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-uppercase text-success fw-bold small mb-1">Top Supplier</div>
                        <div class="h5 mb-0 fw-bold text-dark text-truncate" style="max-width: 200px;" title="{{ top_supplier_name }}">
                            {{ top_supplier_name }}
                        </div>
                    </div>
                    <div class="kpi-icon bg-success text-success"><i class="fa-solid fa-trophy"></i></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Filter Bar (Below Cards) -->
    <div class="filter-box mb-4">
        <form method="POST" action="{{ url_for('purchase_report') }}" class="row g-3 align-items-end">
            <input type="hidden" name="type" value="monthly_summary">
            
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted text-uppercase">Start Date</label>
                <div class="input-group">
                    <span class="input-group-text bg-light border-end-0"><i class="fa-solid fa-calendar text-muted"></i></span>
                    <input type="text" name="start_date" class="form-control date-picker" value="{{ start_date }}" placeholder="Select Date">
                </div>
            </div>
            
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted text-uppercase">End Date</label>
                <div class="input-group">
                    <span class="input-group-text bg-light border-end-0"><i class="fa-solid fa-calendar text-muted"></i></span>
                    <input type="text" name="end_date" class="form-control date-picker" value="{{ end_date }}" placeholder="Select Date">
                </div>
            </div>
            
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted text-uppercase">Supplier</label>
                <select name="supplier_id" class="form-select">
                    <option value="">All Suppliers</option>
                    {% for s in suppliers %}
                    <option value="{{ s.id }}" {% if selected_supplier == s.id|string %}selected{% endif %}>{{ s.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100 fw-bold shadow-sm">
                    <i class="fa-solid fa-filter me-2"></i> Apply Filters
                </button>
            </div>
        </form>
    </div>

    <!-- 4. Charts Section -->
    <div class="row g-4 mb-4">
        <!-- Monthly Trend -->
        <div class="col-lg-8">
            <div class="chart-box">
                <h5 class="fw-bold text-dark mb-4">Monthly Purchase Trend</h5>
                <div style="height: 320px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Supplier Distribution -->
        <div class="col-lg-4">
            <div class="chart-box">
                <h5 class="fw-bold text-dark mb-4">Top Suppliers</h5>
                <div style="height: 320px; display: flex; justify-content: center;">
                    <canvas id="supplierChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Data Table -->
    <div class="table-container mb-5">
        <div class="p-3 border-bottom bg-white d-flex align-items-center justify-content-between">
            <h6 class="m-0 fw-bold text-primary">Detailed Purchase History</h6>
        </div>
        <div class="table-responsive">
            <table class="table mb-0 table-hover">
                <thead>
                    <tr>
                        <th class="ps-4">Date</th>
                        <th>Bill No.</th>
                        <th>Supplier</th>
                        <th class="text-end pe-4">Total Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in purchases %}
                    <tr>
                        <td class="ps-4 fw-medium">
                            {% if p.purchase_date %}
                                {{ p.purchase_date.strftime('%d-%b-%Y') }}
                            {% else %} - {% endif %}
                        </td>
                        <td><span class="badge bg-light text-dark border">{{ p.bill_number or 'N/A' }}</span></td>
                        <td>{{ p.supplier_name }}</td>
                        <td class="text-end pe-4 fw-bold text-dark">{{ p.total_amount|inr }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center py-5 text-muted">No purchase records found matching your criteria.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    // 1. Date Picker
    flatpickr(".date-picker", { dateFormat: "Y-m-d", allowInput: true });

    // 2. Data from Backend (Using safe filter to prevent errors)
    // FIX: Using '| safe' to output raw JSON string
    const monthlyData = {{ monthly_data | tojson | safe }};
    const supplierData = {{ supplier_data | tojson | safe }};

    // 3. Prepare Chart Data
    // We assume backend sends 'month' like '2025-01' and 'total_purchase' as number
    const trendLabels = monthlyData.map(d => {
        if (!d.month) return "N/A";
        const parts = d.month.split('-'); 
        if(parts.length === 2) {
            const date = new Date(parts[0], parts[1] - 1);
            return date.toLocaleString('default', { month: 'short', year: 'numeric' });
        }
        return d.month;
    });
    
    // Ensure values are numbers
    const trendValues = monthlyData.map(d => parseFloat(d.total_purchase) || 0);

    const suppLabels = supplierData.map(d => d.supplier_name || "Unknown");
    const suppValues = supplierData.map(d => parseFloat(d.total_purchase) || 0);

    // --- 1. TREND CHART (Gradient Area) ---
    const ctxTrend = document.getElementById('trendChart').getContext('2d');
    const grad = ctxTrend.createLinearGradient(0, 0, 0, 400);
    grad.addColorStop(0, 'rgba(78, 115, 223, 0.2)');
    grad.addColorStop(1, 'rgba(78, 115, 223, 0)');

    new Chart(ctxTrend, {
        type: 'line',
        data: {
            labels: trendLabels,
            datasets: [{
                label: 'Purchase Volume',
                data: trendValues,
                borderColor: '#4e73df',
                backgroundColor: grad,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#4e73df',
                pointRadius: 4,
                pointHoverRadius: 6,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return ' ₹ ' + context.raw.toLocaleString('en-IN');
                        }
                    }
                }
            },
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [2] } },
                x: { grid: { display: false } }
            }
        }
    });

    // --- 2. SUPPLIER PIE CHART (Doughnut with %) ---
    const ctxSup = document.getElementById('supplierChart').getContext('2d');
    const colors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'];

    new Chart(ctxSup, {
        type: 'doughnut',
        data: {
            labels: suppLabels,
            datasets: [{
                data: suppValues,
                backgroundColor: colors,
                borderWidth: 0,
                hoverOffset: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 10, padding: 15 } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            let total = context.chart._metasets[context.datasetIndex].total;
                            let percentage = ((value / total) * 100).toFixed(1) + "%";
                            return ` ${label}: ₹${value.toLocaleString()} (${percentage})`;
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
