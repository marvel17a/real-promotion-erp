{% extends "admin_master.html" %}
{% block page_content %}
<!-- Dependencies -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        --glass-surface: rgba(255, 255, 255, 0.95);
        --border-light: rgba(0,0,0,0.05);
        --text-dark: #1e293b;
        --success: #10b981;
    }

    body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }

    /* --- KPI CARDS --- */
    .kpi-card {
        border: none; border-radius: 20px; overflow: hidden;
        transition: transform 0.3s;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    
    .bg-gradient-primary { background: var(--primary-gradient); color: white; }
    .bg-white-glass { background: var(--glass-surface); border: 1px solid var(--border-light); }

    /* --- FILTERS --- */
    .filter-container {
        background: white; border-radius: 20px; padding: 25px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
    }
    
    .form-control, .form-select {
        border-radius: 12px; padding: 12px 15px; border: 1px solid #e2e8f0;
        font-size: 0.9rem;
    }
    .form-control:focus, .form-select:focus {
        border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .btn-apply {
        background: var(--dark); color: white; border-radius: 12px;
        padding: 12px; font-weight: 600; width: 100%; transition: 0.2s;
    }
    .btn-apply:hover { background: #334155; transform: translateY(-1px); }

    /* --- CHARTS --- */
    .chart-box {
        background: white; border-radius: 20px; padding: 25px; height: 100%;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
    }

    /* --- TABLE --- */
    .table-card {
        background: white; border-radius: 20px; overflow: hidden;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
    }
    .table thead th {
        background: #f1f5f9; color: #475569; font-size: 0.75rem;
        text-transform: uppercase; letter-spacing: 1px; padding: 18px; border: none;
    }
    .table tbody td { padding: 18px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
    .table-hover tbody tr:hover { background-color: #f8fafc; }
    
    .supplier-avatar {
        width: 35px; height: 35px; background: #e0e7ff; color: #4f46e5;
        border-radius: 10px; display: flex; align-items: center; justify-content: center;
        font-weight: bold; margin-right: 10px;
    }

    .btn-action {
        width: 35px; height: 35px; border-radius: 10px; display: inline-flex;
        align-items: center; justify-content: center; border: 1px solid #e2e8f0;
        transition: 0.2s; background: white;
    }
    .btn-action:hover { background: #f1f5f9; border-color: #cbd5e1; }
    .btn-pdf:hover { color: #ef4444; background: #fef2f2; border-color: #fca5a5; }
    .btn-view:hover { color: #4f46e5; background: #eef2ff; border-color: #c7d2fe; }
</style>

<div class="container-fluid py-4 fade-in-up">
    
    <!-- HEADER -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-5 gap-3">
        <div>
            <h3 class="fw-bold text-dark m-0">Purchase Intelligence</h3>
            <p class="text-muted small m-0">Detailed analysis of procurement & vendor orders</p>
        </div>
        <div class="d-flex gap-2">
            <!-- Global Exports -->
            <a href="{{ url_for('export_purchase_excel') }}" class="btn btn-success rounded-pill px-4 shadow-sm fw-bold">
                <i class="fas fa-file-excel me-2"></i> Export Excel
            </a>
            <a href="{{ url_for('export_purchase_pdf') }}" class="btn btn-danger rounded-pill px-4 shadow-sm fw-bold">
                <i class="fas fa-file-pdf me-2"></i> Export Report
            </a>
        </div>
    </div>

    <!-- KPI ROW -->
    <div class="row g-4 mb-5">
        <div class="col-md-6 col-xl-3">
            <div class="kpi-card bg-gradient-primary p-4 h-100">
                <div class="d-flex justify-content-between">
                    <div>
                        <p class="text-white-50 text-uppercase fw-bold mb-1" style="font-size:0.7rem;">Total Purchase Value</p>
                        <h2 class="fw-bold mb-0">₹ {{ "{:,.0f}".format(kpi.total_spend) }}</h2>
                    </div>
                    <i class="fas fa-wallet fa-2x text-white-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="kpi-card bg-white-glass p-4 h-100">
                <div class="d-flex justify-content-between">
                    <div>
                        <p class="text-muted text-uppercase fw-bold mb-1" style="font-size:0.7rem;">Total Orders</p>
                        <h2 class="fw-bold text-dark mb-0">{{ kpi.total_orders }}</h2>
                    </div>
                    <div class="bg-light rounded-circle p-3">
                        <i class="fas fa-file-invoice text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add more KPIs if needed -->
    </div>

    <!-- CHARTS ROW -->
    <div class="row g-4 mb-5">
        <div class="col-lg-8">
            <div class="chart-box">
                <h6 class="fw-bold mb-4">Monthly Purchase Trend</h6>
                <div style="height: 300px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="chart-box">
                <h6 class="fw-bold mb-4">Top Suppliers (Volume)</h6>
                <div style="height: 250px; position: relative;">
                    <canvas id="supplierChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- FILTERS -->
    <div class="filter-container mb-5">
        <form method="GET" action="{{ url_for('purchase_report') }}">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label text-uppercase text-muted fw-bold small">Search</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" name="q" class="form-control border-start-0 ps-0" placeholder="Bill No, Supplier..." value="{{ search_query }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label text-uppercase text-muted fw-bold small">Supplier</label>
                    <select name="supplier_id" class="form-select">
                        <option value="all">All Vendors</option>
                        {% for s in suppliers %}
                        <option value="{{ s.id }}" {% if selected_supplier == s.id|string %}selected{% endif %}>{{ s.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label text-uppercase text-muted fw-bold small">Start Date</label>
                    <input type="text" name="start_date" id="dateStart" class="form-control" placeholder="Select..." value="{{ start_date or '' }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label text-uppercase text-muted fw-bold small">End Date</label>
                    <input type="text" name="end_date" id="dateEnd" class="form-control" placeholder="Select..." value="{{ end_date or '' }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-apply shadow-sm"><i class="fas fa-filter me-2"></i>Apply</button>
                </div>
            </div>
        </form>
    </div>

    <!-- DATA TABLE -->
    <div class="table-card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th class="ps-4">Date</th>
                        <th>Supplier Detail</th>
                        <th>Bill Ref</th>
                        <th>Items</th>
                        <th class="text-end">Amount</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in purchases %}
                    <tr>
                        <td class="ps-4 fw-medium text-muted">
                            {{ p.purchase_date.strftime('%d %b, %Y') }}
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="supplier-avatar">
                                    {{ p.supplier_name[:1] }}
                                </div>
                                <div>
                                    <span class="fw-bold text-dark d-block">{{ p.supplier_name }}</span>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge bg-light text-dark border">#{{ p.bill_number }}</span></td>
                        <td><span class="badge bg-white border text-muted rounded-pill">{{ p.item_count }} Items</span></td>
                        <td class="text-end fw-bold text-dark">₹ {{ "{:,.2f}".format(p.total_amount) }}</td>
                        <td class="text-center">
                            <a href="{{ url_for('view_purchase', purchase_id=p.id) }}" class="btn-action btn-view me-1" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{{ url_for('purchase_pdf', purchase_id=p.id) }}" class="btn-action btn-pdf" title="Download Voucher">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <img src="https://cdn-icons-png.flaticon.com/512/7486/7486754.png" width="60" class="opacity-25 mb-3">
                            <p class="text-muted mb-0">No purchase records found.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script>
    // 1. Init Date Pickers
    document.addEventListener("DOMContentLoaded", function() {
        flatpickr("#dateStart", { dateFormat: "Y-m-d", allowInput: true });
        flatpickr("#dateEnd", { dateFormat: "Y-m-d", allowInput: true });
    });

    // 2. Charts Data
    const monthlyData = {{ monthly_data | tojson }};
    const supplierData = {{ supplier_data | tojson }};

    // Trend Chart
    const ctxTrend = document.getElementById('trendChart').getContext('2d');
    new Chart(ctxTrend, {
        type: 'line',
        data: {
            labels: monthlyData.map(d => d.month_label),
            datasets: [{
                label: 'Purchase Volume',
                data: monthlyData.map(d => d.total),
                borderColor: '#4f46e5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { grid: { borderDash: [5, 5] }, beginAtZero: true } }
        }
    });

    // Supplier Doughnut
    const ctxSup = document.getElementById('supplierChart').getContext('2d');
    new Chart(ctxSup, {
        type: 'doughnut',
        data: {
            labels: supplierData.map(d => d.supplier_name),
            datasets: [{
                data: supplierData.map(d => d.total),
                backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#0ea5e9', '#64748b'],
                borderWidth: 0,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true } }
            }
        }
    });
</script>
{% endblock %}
