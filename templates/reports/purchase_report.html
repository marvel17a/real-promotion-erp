{% extends "admin_master.html" %}
{% block page_content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0">
        <i class="fa-solid fa-file-invoice-dollar me-2"></i> Purchase Report
    </h2>
    <div>
        <a href="{{ url_for('export_purchase_excel') }}" class="btn btn-success me-2">
            <i class="fa-solid fa-file-excel"></i> Excel
        </a>
        <a href="{{ url_for('export_purchase_pdf') }}" class="btn btn-danger">
            <i class="fa-solid fa-file-pdf"></i> PDF
        </a>
    </div>
</div>

<!-- FILTERS -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">

            <div class="col-md-3">
                <label class="form-label fw-bold">From Date</label>
                <input type="date" name="start_date" class="form-control"
                       value="{{ start_date or '' }}">
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">To Date</label>
                <input type="date" name="end_date" class="form-control"
                       value="{{ end_date or '' }}">
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">Supplier</label>
                <select name="supplier_id" class="form-select">
                    <option value="">All Suppliers</option>
                    {% for s in suppliers %}
                        <option value="{{ s.id }}"
                                {% if selected_supplier == s.id|string %}selected{% endif %}>
                            {{ s.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <button class="btn btn-primary w-100">
                    <i class="fa-solid fa-filter me-1"></i> Apply Filters
                </button>
            </div>

        </form>
    </div>
</div>

<!-- SUMMARY CARDS -->
<div class="row g-4 mb-4">
    <div class="col-lg-4 col-md-6">
        <div class="card shadow-sm">
            <div class="card-body">
                <h6 class="text-muted small">Total Purchases</h6>
                <h4 class="fw-bold mb-0">
                    ₹{{ "%.2f"|format(purchases|sum(attribute='total_amount') or 0) }}
                </h4>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-6">
        <div class="card shadow-sm">
            <div class="card-body">
                <h6 class="text-muted small">Total Bills</h6>
                <h4 class="fw-bold mb-0">{{ purchases|length }}</h4>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <h6 class="text-muted small">Unique Suppliers</h6>
                <h4 class="fw-bold mb-0">
                    {{
                        purchases
                        | map(attribute='supplier_name')
                        | list
                        | unique
                        | list
                        | length
                    }}
                </h4>
            </div>
        </div>
    </div>
</div>

<!-- TABLE -->
<div class="card shadow-sm mb-4">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Supplier</th>
                        <th>Bill #</th>
                        <th class="text-end">Total Amount (₹)</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in purchases %}
                    <tr>
                        <td>
                            {% if p.purchase_date %}
                                {{ p.purchase_date.strftime("%d-%b-%Y") }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ p.supplier_name or 'N/A' }}</td>
                        <td>{{ p.bill_number or 'N/A' }}</td>
                        <td class="text-end fw-bold">₹{{ "%.2f"|format(p.total_amount) }}</td>
                        <td class="text-center">
                            {# If you already have view_purchase route, use it here #}
                            <a href="{{ url_for('view_purchase', purchase_id=p.id) }}"
                               class="btn btn-sm btn-outline-primary">
                                <i class="fa-solid fa-eye"></i> View
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-muted p-4">
                            No purchases found for selected filters.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- CHARTS SECTION -->
<h4 class="fw-bold mb-3">Purchase Analytics</h4>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h6 class="fw-bold mb-3">Monthly Purchase Trend</h6>
                <canvas id="monthlyPurchaseChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h6 class="fw-bold mb-3">Supplier-wise Purchases</h6>
                <canvas id="supplierPurchaseChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const monthlyData = {{ monthly_data | tojson }};
    const supplierData = {{ supplier_data | tojson }};

    const monthLabels = monthlyData.map(m => m.month);
    const monthTotals = monthlyData.map(m => m.total_purchase);

    const supLabels = supplierData.map(s => s.supplier_name || 'Unknown');
    const supTotals = supplierData.map(s => s.total_purchase);

    // Monthly Purchase Chart (Line)
    new Chart(document.getElementById('monthlyPurchaseChart'), {
        type: 'line',
        data: {
            labels: monthLabels,
            datasets: [{
                label: 'Total Purchase (₹)',
                data: monthTotals,
                borderColor: 'rgb(54, 162, 235)',
                fill: false,
                tension: 0.2
            }]
        }
    });

    // Supplier-wise Purchase Chart (Bar)
    new Chart(document.getElementById('supplierPurchaseChart'), {
        type: 'bar',
        data: {
            labels: supLabels,
            datasets: [{
                label: 'Total Purchase (₹)',
                data: supTotals,
                backgroundColor: 'rgba(40, 167, 69, 0.7)'
            }]
        }
    });
</script>

{% endblock %}
