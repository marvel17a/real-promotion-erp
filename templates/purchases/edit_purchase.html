{% extends "admin_master.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/purchase.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<div class="container py-5 fade-in-up" style="max-width: 800px;">
    
    <div class="d-flex align-items-center mb-4">
        <a href="{{ url_for('purchases') }}" class="btn btn-light rounded-circle shadow-sm me-3" style="width: 40px; height: 40px; display:flex; align-items:center; justify-content:center;">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <h2 class="mb-0 fw-bold page-title">Edit Purchase #{{ purchase.id }}</h2>
    </div>

    <div class="glass-panel p-5">
        <form action="{{ url_for('update_purchase', purchase_id=purchase.id) }}" method="POST" id="purchaseForm">
            
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <label class="form-label fw-bold text-muted small text-uppercase">Supplier</label>
                    <select name="supplier_id" class="form-select input-glass" required>
                        {% for s in suppliers %}
                            <option value="{{ s.id }}" {% if s.id == purchase.supplier_id %}selected{% endif %}>
                                {{ s.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold text-muted small text-uppercase">Date</label>
                    <!-- FIX: Handle None/NULL date safely. Defaults to today if missing. -->
                    <input type="text" name="purchase_date" id="purchase_date" class="form-control input-glass" 
                           value="{{ purchase.purchase_date.strftime('%Y-%m-%d') if purchase.purchase_date else '' }}" required>
                </div>
                <div class="col-12">
                    <label class="form-label fw-bold text-muted small text-uppercase">Bill Number</label>
                    <input type="text" name="bill_number" class="form-control input-glass" 
                           value="{{ purchase.bill_number or '' }}">
                </div>
            </div>

            <!-- Items Table (If you implemented item editing logic in app.py, include it here. 
                 If not, this simple form just updates the header info.) -->
            
            <div class="mt-5 text-end">
                <button type="submit" class="btn-glass-primary px-5 py-3 shadow-lg">
                    <i class="fa-solid fa-check-double me-2"></i>Update Purchase
                </button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    // Initialize Flatpickr
    // If value is empty, 'defaultDate: "today"' will auto-fill it
    flatpickr("#purchase_date", {
        dateFormat: "Y-m-d",
        defaultDate: "today",
        allowInput: true
    });
</script>
{% endblock %}
