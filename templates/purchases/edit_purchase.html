{% extends "admin_master.html" %}

{% block page_content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/purchase.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<div class="container py-5 fade-in-up" style="max-width: 1000px;">
    
    <div class="d-flex align-items-center mb-4">
        <a href="{{ url_for('purchases') }}" class="btn btn-light rounded-circle shadow-sm me-3" style="width: 40px; height: 40px; display:flex; align-items:center; justify-content:center;">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <h2 class="mb-0 fw-bold page-title">Edit Purchase #{{ purchase.id }}</h2>
    </div>

    <div class="glass-panel p-5">
        <form action="{{ url_for('update_purchase', purchase_id=purchase.id) }}" method="POST" id="purchaseForm">
            
            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <label class="form-label fw-bold text-muted small text-uppercase">Supplier</label>
                    <select name="supplier_id" class="form-select input-glass" required>
                        {% for s in suppliers %}
                            <option value="{{ s.id }}" {% if s.id == purchase.supplier_id %}selected{% endif %}>
                                {{ s.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold text-muted small text-uppercase">Date</label>
                    <input type="text" name="purchase_date" id="purchase_date" class="form-control input-glass" 
                           value="{{ purchase.purchase_date.strftime('%Y-%m-%d') if purchase.purchase_date else '' }}" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold text-muted small text-uppercase">Bill Number</label>
                    <input type="text" name="bill_number" class="form-control input-glass" 
                           value="{{ purchase.bill_number or '' }}">
                </div>
            </div>

            <!-- ITEMS TABLE -->
            <h5 class="fw-bold mb-3">Item Details</h5>
            <div class="table-responsive mb-3">
                <table class="table table-borderless align-middle" id="itemsTable">
                    <thead class="text-muted small text-uppercase border-bottom">
                        <tr>
                            <th style="width: 35%;">Product</th>
                            <th style="width: 15%;">Quantity</th>
                            <th style="width: 20%;">Unit Price (₹)</th>
                            <th style="width: 20%;" class="text-end">Total</th>
                            <th style="width: 10%;" class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody">
                        <!-- Rows populated via JS -->
                    </tbody>
                    <tfoot class="border-top">
                        <tr>
                            <td colspan="3" class="text-end pt-3"><strong>Grand Total</strong></td>
                            <td id="grandTotal" class="fw-bold fs-5 text-end pt-3 text-primary">₹0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <button type="button" id="addRowBtn" class="btn btn-sm btn-light border shadow-sm fw-bold text-primary">
                <i class="fa-solid fa-plus me-2"></i> Add Item Row
            </button>

            <div class="mt-5 text-end">
                <button type="submit" class="btn-glass-primary px-5 py-3 shadow-lg">
                    <i class="fa-solid fa-check-double me-2"></i>Update Purchase
                </button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    flatpickr("#purchase_date", { dateFormat: "Y-m-d", altInput: true, altFormat: "d-m-Y", allowInput: true });
</script>

<!-- Pass Data to JS -->
<script id="products-data" type="application/json">{{ products|tojson|safe }}</script>
<script id="existing-items" type="application/json">{{ items|tojson|safe }}</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const products = JSON.parse(document.getElementById('products-data').textContent || '[]');
        const existingItems = JSON.parse(document.getElementById('existing-items').textContent || '[]');
        const tbody = document.getElementById('itemsBody');
        const addBtn = document.getElementById('addRowBtn');
        const grandTotalEl = document.getElementById('grandTotal');

        function addRow(item = null) {
            const row = document.createElement('tr');
            
            let productOptions = '<option value="" disabled selected>Select Product</option>';
            products.forEach(p => {
                let price = p.price || 0;
                let selected = (item && item.product_id == p.id) ? 'selected' : '';
                productOptions += `<option value="${p.id}" data-price="${price}" ${selected}>${p.name}</option>`;
            });

            const qtyVal = item ? item.quantity : 1;
            const priceVal = item ? item.purchase_price : 0;
            const totalVal = (qtyVal * priceVal).toFixed(2);

            row.innerHTML = `
                <td><select class="form-select input-glass product-select" name="product_id[]" required>${productOptions}</select></td>
                <td><input type="number" class="form-control input-glass quantity" name="quantity[]" value="${qtyVal}" min="1" required></td>
                <td><input type="number" step="0.01" class="form-control input-glass price" name="price[]" value="${priceVal}" required></td>
                <td class="text-end total-cell fw-bold text-dark">₹${totalVal}</td>
                <td class="text-center"><button type="button" class="btn btn-sm text-danger remove-row"><i class="fa-solid fa-trash"></i></button></td>
            `;
            tbody.appendChild(row);
            
            const select = row.querySelector('.product-select');
            const qtyInput = row.querySelector('.quantity');
            const priceInput = row.querySelector('.price');
            const removeBtn = row.querySelector('.remove-row');

            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const price = parseFloat(selectedOption.dataset.price) || 0;
                priceInput.value = price.toFixed(2);
                updateRowTotal(row);
            });

            qtyInput.addEventListener('input', () => updateRowTotal(row));
            priceInput.addEventListener('input', () => updateRowTotal(row));
            
            removeBtn.addEventListener('click', () => { row.remove(); updateGrandTotal(); });
        }

        function updateRowTotal(row) {
            const qty = parseFloat(row.querySelector('.quantity').value) || 0;
            const price = parseFloat(row.querySelector('.price').value) || 0;
            row.querySelector('.total-cell').textContent = '₹' + (qty * price).toFixed(2);
            updateGrandTotal();
        }

        function updateGrandTotal() {
            let total = 0;
            document.querySelectorAll('#itemsBody tr').forEach(row => {
                const qty = parseFloat(row.querySelector('.quantity').value) || 0;
                const price = parseFloat(row.querySelector('.price').value) || 0;
                total += qty * price;
            });
            grandTotalEl.textContent = '₹' + total.toFixed(2);
        }

        if(addBtn) addBtn.addEventListener('click', () => addRow());

        // Load existing items
        if (existingItems.length > 0) {
            existingItems.forEach(item => addRow(item));
        } else {
            addRow();
        }
        updateGrandTotal();
    });
</script>
{% endblock %}
