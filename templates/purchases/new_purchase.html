{% extends "admin_master.html" %}

{% block page_content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/purchase.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<div class="container py-5 fade-in-up" style="max-width: 1000px;">
    
    <div class="d-flex align-items-center mb-4">
        <a href="{{ url_for('purchases') }}" class="btn btn-light rounded-circle shadow-sm me-3" style="width: 40px; height: 40px; display:flex; align-items:center; justify-content:center;">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <h2 class="mb-0 fw-bold page-title">New Purchase Entry</h2>
    </div>

    <div class="glass-panel p-5">
        <form id="purchaseForm" method="POST" action="{{ url_for('new_purchase') }}" class="needs-validation" novalidate>
            
            <!-- Master Details -->
            <div class="row g-4 mb-5 border-bottom pb-4">
                <div class="col-md-4">
                    <label for="supplier_id" class="form-label fw-bold text-muted small text-uppercase">Supplier <span class="text-danger">*</span></label>
                    <select class="form-select input-glass" id="supplier_id" name="supplier_id" required>
                        <option value="" disabled selected>-- Select Supplier --</option>
                        {% for supplier in suppliers %}
                        <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">Please select a supplier.</div>
                </div>
                <div class="col-md-4">
                    <label for="purchase_date" class="form-label fw-bold text-muted small text-uppercase">Purchase Date <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="fa-regular fa-calendar"></i></span>
                        <input type="text" class="form-control input-glass border-start-0 ps-0" id="purchase_date" name="purchase_date" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="bill_number" class="form-label fw-bold text-muted small text-uppercase">Bill / Invoice No.</label>
                    <input type="text" class="form-control input-glass" id="bill_number" name="bill_number" placeholder="Optional">
                </div>
            </div>

            <!-- Product Items Table -->
            <h5 class="fw-bold mb-3">Item Details</h5>
            <div class="table-responsive mb-3">
                <table class="table table-borderless align-middle" id="itemsTable">
                    <thead class="text-muted small text-uppercase border-bottom">
                        <tr>
                            <th style="width: 35%;">Product</th>
                            <th style="width: 15%;">Quantity</th>
                            <th style="width: 20%;">Unit Price (₹)</th>
                            <th style="width: 20%;" class="text-end">Total</th>
                            <th style="width: 10%;" class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows added by JS -->
                    </tbody>
                    <tfoot class="border-top">
                        <tr>
                            <td colspan="3" class="text-end pt-3"><strong>Grand Total</strong></td>
                            <td id="grandTotal" class="fw-bold fs-5 text-end pt-3 text-primary">₹0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <button type="button" id="addRowBtn" class="btn btn-sm btn-light border shadow-sm fw-bold text-primary">
                <i class="fa-solid fa-plus me-2"></i> Add Item Row
            </button>

            <div class="mt-5 text-end">
                <button type="submit" class="btn-glass-primary px-5 py-3 shadow-lg">
                    <i class="fa-solid fa-check me-2"></i>Save Purchase
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    // Initialize Flatpickr
    flatpickr("#purchase_date", {
        dateFormat: "Y-m-d", // Value sent to backend
        altInput: true,      // Display format
        altFormat: "d-m-Y",
        defaultDate: "today",
        allowInput: true
    });

    document.addEventListener('DOMContentLoaded', function() {
        // --- ROBUST JSON PARSING ---
        const productsDataElement = document.getElementById('products-data');
        let products = [];
        
        if (productsDataElement) {
            try {
                const rawData = productsDataElement.textContent.trim();
                if (rawData) {
                    products = JSON.parse(rawData);
                }
            } catch (e) {
                console.error("Error parsing products JSON:", e);
                products = []; 
            }
        }

        const tbody = document.querySelector('#itemsTable tbody');
        const addBtn = document.getElementById('addRowBtn');
        const grandTotalEl = document.getElementById('grandTotal');
        const form = document.getElementById('purchaseForm');

        function addRow() {
            const row = document.createElement('tr');
            
            let productOptions = '<option value="" disabled selected>Select Product</option>';
            if (Array.isArray(products) && products.length > 0) {
                products.forEach(p => {
                    let price = p.price || p.cost_price || p.selling_price || 0;
                    let safeName = p.name.replace(/"/g, '&quot;');
                    productOptions += `<option value="${p.id}" data-price="${price}">${safeName}</option>`;
                });
            } else {
                productOptions += '<option value="" disabled>No products available</option>';
            }

            row.innerHTML = `
                <td>
                    <select class="form-select input-glass product-select" name="product_id[]" required>
                        ${productOptions}
                    </select>
                </td>
                <td>
                    <input type="number" class="form-control input-glass quantity" name="quantity[]" value="1" min="1" required>
                </td>
                <td>
                    <input type="number" step="0.01" class="form-control input-glass price" name="price[]" value="0.00" required>
                </td>
                <td class="text-end total-cell fw-bold text-dark">₹0.00</td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm text-danger remove-row"><i class="fa-solid fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(row);
            
            const select = row.querySelector('.product-select');
            const qtyInput = row.querySelector('.quantity');
            const priceInput = row.querySelector('.price');
            const removeBtn = row.querySelector('.remove-row');

            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const price = parseFloat(selectedOption.dataset.price) || 0;
                priceInput.value = price.toFixed(2);
                updateRowTotal(row);
            });

            qtyInput.addEventListener('input', () => updateRowTotal(row));
            priceInput.addEventListener('input', () => updateRowTotal(row));
            
            removeBtn.addEventListener('click', () => {
                if(tbody.rows.length > 1) {
                    row.remove();
                    updateGrandTotal();
                } else {
                    select.value = "";
                    qtyInput.value = 1;
                    priceInput.value = "0.00";
                    updateRowTotal(row);
                }
            });
        }

        function updateRowTotal(row) {
            const qty = parseFloat(row.querySelector('.quantity').value) || 0;
            const price = parseFloat(row.querySelector('.price').value) || 0;
            const total = qty * price;
            row.querySelector('.total-cell').textContent = '₹' + total.toFixed(2);
            updateGrandTotal();
        }

        function updateGrandTotal() {
            let total = 0;
            document.querySelectorAll('#itemsTable tbody tr').forEach(row => {
                const qty = parseFloat(row.querySelector('.quantity').value) || 0;
                const price = parseFloat(row.querySelector('.price').value) || 0;
                total += qty * price;
            });
            grandTotalEl.textContent = '₹' + total.toFixed(2);
        }

        if(addBtn) addBtn.addEventListener('click', () => addRow());
        
        // Add first row on load
        addRow();

        // Custom Form Validation
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // Check if at least one product is selected
            const productSelects = document.querySelectorAll('.product-select');
            let hasProduct = false;
            productSelects.forEach(select => {
                if(select.value) hasProduct = true;
            });

            if (!hasProduct) {
                event.preventDefault();
                alert("Please add at least one product.");
            }

            form.classList.add('was-validated');
        }, false);
    });
</script>

<!-- SAFE DATA PASSING -->
<script id="products-data" type="application/json">
    {{ products|tojson|safe }}
</script>
{% endblock %}
