{% extends "admin_master.html" %}

{% block page_content %}

<!-- Premium Design CSS -->
<style>
    :root {
        --primary-color: #4e73df;
        --secondary-color: #858796;
        --success-color: #1cc88a;
        --info-color: #36b9cc;
        --warning-color: #f6c23e;
        --danger-color: #e74a3b;
        --light-bg: #f8f9fc;
        --card-bg: #ffffff;
        --text-dark: #2e384d;
        --text-muted: #8898aa;
        --border-color: #e3e6f0;
        --shadow-soft: 0 4px 15px rgba(0, 0, 0, 0.03);
        --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.08);
        --radius-lg: 15px;
        --radius-md: 10px;
    }

    body {
        background-color: var(--light-bg);
        color: var(--text-dark);
        font-family: 'Nunito', sans-serif;
    }

    /* Animations */
    .fade-in-up {
        animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Cards */
    .glass-card {
        background: var(--card-bg);
        border: 1px solid rgba(0,0,0,0.02);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-soft);
        transition: all 0.3s ease;
    }
    .glass-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-hover);
    }

    /* Stats Icons */
    .icon-box {
        width: 56px;
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        font-size: 1.5rem;
        transition: transform 0.3s ease;
    }
    .glass-card:hover .icon-box {
        transform: scale(1.1);
    }
    
    /* Table Styling */
    .table-responsive {
        border-radius: var(--radius-lg);
    }
    .table {
        margin-bottom: 0;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    /* MODIFIED: Header Styling for BOLD TEXT */
    .table thead th {
        background-color: #f1f3f9;
        color: #2c3e50; /* Darker Text */
        font-weight: 800 !important; /* Extra Bold */
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.05em;
        border-bottom: 2px solid #d1d3e2; /* Thicker border */
        padding: 1.2rem 1rem;
    }
    
    .table tbody td {
        vertical-align: middle;
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-dark);
        font-size: 0.9rem;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(78, 115, 223, 0.03);
    }
    .product-img-wrapper {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-md);
        overflow: hidden;
        border: 1px solid var(--border-color);
        background: #fff;
    }
    .product-img-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Badges */
    .badge-soft {
        padding: 0.5em 0.8em;
        font-weight: 600;
        border-radius: 6px;
    }
    .badge-soft-success { background-color: rgba(28, 200, 138, 0.15); color: var(--success-color); }
    .badge-soft-danger { background-color: rgba(231, 74, 59, 0.15); color: var(--danger-color); }
    .badge-soft-warning { background-color: rgba(246, 194, 62, 0.15); color: #b78d05; }
    .badge-soft-primary { background-color: rgba(78, 115, 223, 0.15); color: var(--primary-color); }
    .badge-soft-secondary { background-color: rgba(133, 135, 150, 0.15); color: var(--secondary-color); }

    /* Buttons */
    .btn-primary {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        border: none;
        box-shadow: 0 4px 10px rgba(78, 115, 223, 0.3);
        transition: all 0.2s;
    }
    .btn-primary:hover {
        box-shadow: 0 6px 15px rgba(78, 115, 223, 0.4);
        transform: translateY(-1px);
    }
    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        color: var(--secondary-color);
        transition: all 0.2s;
    }
    .btn-icon:hover {
        background-color: #eaecf4;
        color: var(--primary-color);
    }
    .btn-icon.delete:hover {
        background-color: #ffe6e6;
        color: var(--danger-color);
    }

    /* Inputs */
    .form-control, .form-select {
        border-radius: var(--radius-md);
        border: 1px solid #d1d3e2;
        padding: 0.6rem 1rem;
    }
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.15);
    }
    .input-group-text {
        border-radius: var(--radius-md) 0 0 var(--radius-md);
        border-color: #d1d3e2;
        background-color: #fff;
    }
</style>

<!-- Logic: Calculate Out of Stock in Template -->
{% set out_of_stock_count = 0 %}
{% for p in products %}
    {% if p.total_stock == 0 %}
        {% set out_of_stock_count = out_of_stock_count + 1 %}
    {% endif %}
{% endfor %}

<div class="container-fluid py-4 fade-in-up">
    
    <!-- Header -->
    <div class="row mb-4 align-items-end">
        <div class="col-md-8">
            <div class="d-flex align-items-center">
                <div class="bg-white p-2 rounded-3 shadow-sm me-3 border">
                    <i class="fa-solid fa-boxes-stacked text-primary fs-3"></i>
                </div>
                <div>
                    <h6 class="text-uppercase text-primary fw-bold small mb-1 ls-1">Real Promotion</h6>
                    <h3 class="fw-bold text-dark mb-0">Inventory Master</h3>
                    <p class="text-muted small mb-0">Track complete stock details (Warehouse + Field).</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <div class="d-flex gap-2 justify-content-md-end">
                <button onclick="window.print()" class="btn btn-light bg-white border shadow-sm text-secondary fw-semibold">
                    <i class="fa-solid fa-print me-2"></i> Print
                </button>
                <a href="{{ url_for('add_product') }}" class="btn btn-primary rounded-pill px-4 fw-bold">
                    <i class="fa-solid fa-plus me-2"></i> New Product
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Row (4 Cards) -->
    <div class="row g-3 mb-4">
        <!-- 1. Total Value -->
        <div class="col-xl-3 col-md-6">
            <div class="card glass-card h-100 border-0">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-primary bg-opacity-10 text-primary me-3">
                            <i class="fa-solid fa-sack-dollar"></i>
                        </div>
                        <div>
                            <p class="text-uppercase text-muted fw-bold small mb-1">Total Asset Value</p>
                            <h4 class="fw-bold mb-0 text-dark">₹ {{ "%.0f"|format(stats.total_value) }}</h4>
                            <small class="text-xs text-primary bg-primary bg-opacity-10 px-2 py-1 rounded-pill mt-1 d-inline-block">Warehouse + Field</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 2. Total Products -->
        <div class="col-xl-3 col-md-6">
            <div class="card glass-card h-100 border-0">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-success bg-opacity-10 text-success me-3">
                            <i class="fa-solid fa-box-open"></i>
                        </div>
                        <div>
                            <p class="text-uppercase text-muted fw-bold small mb-1">Total Products</p>
                            <h4 class="fw-bold mb-0 text-dark">{{ stats.total_items }}</h4>
                            <small class="text-xs text-muted mt-1 d-block">Active SKUs</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Low Stock -->
        <div class="col-xl-3 col-md-6">
            <div class="card glass-card h-100 border-0">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-warning bg-opacity-10 text-warning me-3">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                        </div>
                        <div>
                            <p class="text-uppercase text-muted fw-bold small mb-1">Low Stock Items</p>
                            <h4 class="fw-bold mb-0 text-dark">{{ stats.low_stock }}</h4>
                            <small class="text-xs text-muted mt-1 d-block">Restock Needed</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Out of Stock -->
        <div class="col-xl-3 col-md-6">
            <div class="card glass-card h-100 border-0">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-danger bg-opacity-10 text-danger me-3">
                            <i class="fa-solid fa-ban"></i>
                        </div>
                        <div>
                            <p class="text-uppercase text-muted fw-bold small mb-1">Out of Stock</p>
                            <h4 class="fw-bold mb-0 text-dark">{{ out_of_stock_count }}</h4>
                            <small class="text-xs text-muted mt-1 d-block">Immediate Action</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="card glass-card border-0 mb-4">
        <div class="card-body p-3">
            <div class="row g-3 align-items-center">
                <div class="col-md-5">
                    <div class="input-group shadow-sm">
                        <span class="input-group-text border-end-0"><i class="fa-solid fa-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control border-start-0 ps-0" placeholder="Search by product name...">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group shadow-sm">
                        <span class="input-group-text border-end-0 bg-white"><i class="fa-solid fa-filter text-muted"></i></span>
                        <select id="categoryFilter" class="form-select border-start-0 ps-0 cursor-pointer">
                            <option value="all">All Categories</option>
                            {% for cat in categories %}
                            <option value="{{ cat.category_name }}">{{ cat.category_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-3 text-md-end">
                    <a href="{{ url_for('category_master') }}" class="btn btn-outline-secondary rounded-pill w-100">
                        <i class="fa-solid fa-layer-group me-2"></i> Manage Categories
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Table -->
    <div class="card glass-card border-0 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="inventoryTable">
                <thead>
                    <tr>
                        <th class="ps-4">Product Name</th>
                        <th>Category</th>
                        <th class="text-center" style="background: #fdfdfe;">Warehouse</th>
                        <th class="text-center" style="background: #f0f9ff;">Allocated</th>
                        <th class="text-center">Total Health</th>
                        <th class="text-end">Price</th>
                        <th class="text-end pe-4">Action</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                    {% for p in products %}
                    
                    {% set threshold = p.low_stock_threshold if p.low_stock_threshold is not none else 10 %}
                    
                    <!-- UPDATED: Use |lower filter for search attribute -->
                    <tr class="product-row transition-base" 
                        data-name="{{ p.name|lower }}" 
                        data-category="{{ p.category_name or 'Uncategorized' }}">
                        
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <div class="product-img-wrapper shadow-sm me-3">
                                    {% if p.image %}
                                    <img src="{{ p.image | fix_image }}" alt="Product">
                                    {% else %}
                                    <div class="d-flex align-items-center justify-content-center h-100 bg-light text-muted">
                                        <i class="fa-solid fa-image"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <div>
                                    <div class="fw-bold text-dark fs-6">{{ p.name }}</div>
                                    <small class="text-muted d-block fw-semibold" style="font-size: 0.75rem;">ID: #{{ p.id }}</small>
                                </div>
                            </div>
                        </td>
                        
                        <td>
                            <span class="badge badge-soft-secondary fw-bold border">
                                {{ p.category_name or 'Uncategorized' }}
                            </span>
                        </td>
                        
                        <td class="text-center" style="background: #fdfdfe;">
                            <div class="d-flex flex-column align-items-center">
                                <span class="fw-bold text-dark fs-5">{{ p.warehouse_stock }}</span>
                                <span class="text-muted text-uppercase fw-bold" style="font-size: 0.65rem; letter-spacing: 0.5px;">IN OFFICE</span>
                            </div>
                        </td>

                        <td class="text-center" style="background: #f0f9ff;">
                            <div class="d-flex flex-column align-items-center">
                                <span class="fw-bold text-primary fs-5">{{ p.allocated_stock }}</span>
                                <span class="text-primary text-opacity-75 text-uppercase fw-bold" style="font-size: 0.65rem; letter-spacing: 0.5px;">IN FIELD</span>
                            </div>
                        </td>

                        <!-- TOTAL HEALTH COLUMN (Boxed Logic) -->
                        {% if p.total_stock <= threshold %}
                            <td class="text-center bg-danger text-white fw-bold">
                                Low: {{ p.total_stock }}
                            </td>
                        {% else %}
                            <td class="text-center bg-success text-white fw-bold">
                                Good: {{ p.total_stock }}
                            </td>
                        {% endif %}

                        <td class="text-end fw-bolder text-dark fs-6">
                            ₹ {{ "%.0f"|format(p.price) }}
                        </td>

                        <td class="text-end pe-4">
                            <div class="d-flex justify-content-end gap-1">
                                <!-- Edit -->
                                <a href="{{ url_for('edit_product', product_id=p.id) }}" class="btn btn-icon" data-bs-toggle="tooltip" title="Edit Product">
                                    <i class="fa-solid fa-pen"></i>
                                </a>

                                <!-- Stock Adjust (Modal Trigger) -->
                                <button type="button" class="btn btn-icon text-warning" data-bs-toggle="modal" data-bs-target="#adjustStockModal{{p.id}}" title="Adjust Stock">
                                    <i class="fa-solid fa-sliders"></i>
                                </button>

                                <!-- History (Fixed URL parameter) -->
                                <a href="{{ url_for('product_history', product_id=p.id) }}" class="btn btn-icon text-info" data-bs-toggle="tooltip" title="View History">
                                    <i class="fa-solid fa-clock-rotate-left"></i>
                                </a>

                                <!-- Soft Delete -->
                                <form action="{{ url_for('delete_product_soft', id=p.id) }}" method="POST" onsubmit="return confirm('Archive this product? It will be hidden from lists.');" class="d-inline">
                                    <button type="submit" class="btn btn-icon delete text-danger" data-bs-toggle="tooltip" title="Archive">
                                        <i class="fa-solid fa-box-archive"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="d-flex flex-column align-items-center justify-content-center opacity-50">
                                <i class="fa-solid fa-box-open fs-1 mb-3 text-secondary"></i>
                                <h6 class="text-muted fw-normal">No products found in inventory.</h6>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODALS SECTION -->
{% for p in products %}
<div class="modal fade" id="adjustStockModal{{p.id}}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form action="{{ url_for('stock_adjust') }}" method="POST">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-header border-0 pb-0">
                    <h6 class="modal-title fw-bold text-dark">Adjust Stock: <span class="text-primary">{{ p.name }}</span></h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-start pt-4">
                    <input type="hidden" name="product_id" value="{{ p.id }}">
                    
                    <label class="small text-muted fw-bold text-uppercase mb-2">Adjustment Type</label>
                    <div class="d-flex gap-2 mb-4">
                        <input type="radio" class="btn-check" name="adjustment_type" id="add{{p.id}}" value="add" checked>
                        <label class="btn btn-outline-success flex-fill rounded-3 border-2 fw-bold" for="add{{p.id}}">
                            <i class="fa-solid fa-plus me-1"></i> Add Stock
                        </label>
                        
                        <input type="radio" class="btn-check" name="adjustment_type" id="sub{{p.id}}" value="subtract">
                        <label class="btn btn-outline-danger flex-fill rounded-3 border-2 fw-bold" for="sub{{p.id}}">
                            <i class="fa-solid fa-minus me-1"></i> Remove Stock
                        </label>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="number" name="quantity" class="form-control bg-light border-0" id="qty{{p.id}}" placeholder="0" required>
                        <label for="qty{{p.id}}">Quantity</label>
                    </div>

                    <div class="form-floating">
                        <input type="text" name="reason" class="form-control bg-light border-0" id="reason{{p.id}}" placeholder="Reason" required>
                        <label for="reason{{p.id}}">Reason (e.g. Damage, Audit)</label>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0 pb-4 px-4">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-dark rounded-pill px-4">Confirm Adjustment</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endfor %}

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Initialize Tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // Client Side Search & Filter
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const rows = document.querySelectorAll('.product-row');

    function filterProducts() {
        if (!searchInput || !categoryFilter) return;

        const term = searchInput.value.toLowerCase().trim();
        const category = categoryFilter.value;

        rows.forEach(row => {
            const nameAttr = row.getAttribute('data-name');
            const catAttr = row.getAttribute('data-category');
            
            const name = nameAttr ? nameAttr.toLowerCase() : '';
            const rowCat = catAttr ? catAttr : '';
            
            const matchesSearch = name.includes(term);
            const matchesCategory = category === 'all' || rowCat === category;

            if (matchesSearch && matchesCategory) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    if(searchInput) {
        searchInput.addEventListener('keyup', filterProducts);
        searchInput.addEventListener('input', filterProducts);
    }
    if(categoryFilter) {
        categoryFilter.addEventListener('change', filterProducts);
    }
});
</script>

{% endblock %}
